<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0b0904">
    <title>Rewards - BackTrack</title>
    <meta name="description"
        content="Earn points by returning items and redeem premium school rewards through BackTrack.">

    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/nav-auth.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/leaderboard.css?v=3">

    <link rel="stylesheet" href="css/rewards.css">
</head>

<body>
    <nav>
        <a href="index.html" class="nav-left">
            <span class="brand-logo">
                <img class="logo-dark" src="logo.png" alt="BackTrack">
                <img class="logo-light" src="logo-white.png" alt="" aria-hidden="true">
            </span>
        </a>
        <div class="nav-center">
            <a href="index.html" class="nav-link">Home</a>
            <a href="browse.html" class="nav-link">Browse</a>
            <a href="map.html" class="nav-link">Map</a>
            <a href="submit.html" class="nav-link">Submit</a>
            <a href="rewards.html" class="nav-link active">Rewards</a>
            <a href="features.html" class="nav-link">Features</a>
            <a href="sources.html" class="nav-link">Sources</a>
        </div>
        <div class="nav-right">
            <a href="login.html" class="sign-in-btn">Log In</a>
        </div>
    </nav>
    <div class="nav-spacer"></div>

    <div class="page-wrap">
        <section class="hero">
            <h1>Good deeds pay off</h1>
            <p>Return items, earn points. Trade them for food, merch, and privileges. Your balance updates
                automatically.</p>
        </section>

        <section class="dashboard">
            <div class="vault-grid">
                <div class="points-side">
                    <p class="points-label">Balance</p>
                    <p class="points-value" id="pointsValue">--</p>
                    <div class="tier-row">
                        <span class="tier-name" id="tierName">Tier</span>
                        <div class="tier-meter" aria-hidden="true">
                            <div class="tier-fill" id="tierFill"></div>
                        </div>
                    </div>
                    <p class="tier-next" id="tierNext">Loading tier status...</p>
                </div>
                <div class="stats-side">
                    <div class="stat">
                        <p class="stat-label">Returns</p>
                        <p class="stat-value" id="returnsValue">0</p>
                    </div>
                    <div class="stat">
                        <p class="stat-label">Claims</p>
                        <p class="stat-value" id="claimsValue">0</p>
                    </div>
                    <div class="stat">
                        <p class="stat-label">Redeemed</p>
                        <p class="stat-value" id="redeemedValue">0</p>
                    </div>
                    <div class="stat">
                        <p class="stat-label">Spent</p>
                        <p class="stat-value" id="spentValue">0</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="filters" aria-label="Reward filters">
            <button class="filter-btn active" type="button" data-filter="all">All</button>
            <button class="filter-btn" type="button" data-filter="food">Food</button>
            <button class="filter-btn" type="button" data-filter="merch">Merch</button>
            <button class="filter-btn" type="button" data-filter="privilege">Privilege</button>
            <button class="filter-btn" type="button" data-filter="events">Events</button>
        </section>

        <section class="rewards-section">
            <div class="rewards-grid" id="rewardsGrid">
                <!-- Food -->
                <article class="reward-card" data-category="food" data-cost="55" data-name="$10 Chick-fil-A Gift Card">
                    <div class="reward-body">
                        <div class="reward-head">
                            <div class="reward-mini-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                                </svg>
                            </div>
                            <h3 class="reward-title">$10 Chick-fil-A</h3>
                            <span class="reward-chip-inline">Food</span>
                        </div>
                        <p class="reward-desc">Nuggets, spicy deluxe, whatever you want. Valid at any location.</p>
                        <div class="reward-footer">
                            <div class="reward-cost">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 7v5l3 3"></path>
                                </svg>
                                55 pts
                            </div>
                            <button class="redeem-btn" type="button">Redeem</button>
                        </div>
                    </div>
                </article>

                <!-- Merch -->
                <article class="reward-card" data-category="merch" data-cost="95" data-name="BackTrack Hoodie">
                    <div class="reward-body">
                        <div class="reward-head">
                            <div class="reward-mini-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M20.38 3.4a2 2 0 0 0-2-1H5.62a2 2 0 0 0-2 1L2 5.8A2 2 0 0 0 2 6v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0 0-.2L20.38 3.4z">
                                    </path>
                                    <path d="M12 10v10"></path>
                                    <path d="M12 10l4-4"></path>
                                    <path d="M12 10l-4-4"></path>
                                </svg>
                            </div>
                            <h3 class="reward-title">School Hoodie</h3>
                            <span class="reward-chip-inline">Merch</span>
                        </div>
                        <p class="reward-desc">Cozy fleece with the school logo. Runs S to XL.</p>
                        <div class="reward-footer">
                            <div class="reward-cost">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 7v5l3 3"></path>
                                </svg>
                                95 pts
                            </div>
                            <button class="redeem-btn" type="button">Redeem</button>
                        </div>
                    </div>
                </article>

                <!-- Privilege -->
                <article class="reward-card" data-category="privilege" data-cost="35"
                    data-name="Front of Lunch Line Pass">
                    <div class="reward-body">
                        <div class="reward-head">
                            <div class="reward-mini-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                </svg>
                            </div>
                            <h3 class="reward-title">Lunch Line Fast Pass</h3>
                            <span class="reward-chip-inline">Privilege</span>
                        </div>
                        <p class="reward-desc">Cut straight to the front for a full week. No waiting.</p>
                        <div class="reward-footer">
                            <div class="reward-cost">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 7v5l3 3"></path>
                                </svg>
                                35 pts
                            </div>
                            <button class="redeem-btn" type="button">Redeem</button>
                        </div>
                    </div>
                </article>

                <!-- Privilege -->
                <article class="reward-card" data-category="privilege" data-cost="170"
                    data-name="VIP Parking for a Week">
                    <div class="reward-body">
                        <div class="reward-head">
                            <div class="reward-mini-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <path d="M9 17V7h4a3 3 0 0 1 0 6H9"></path>
                                </svg>
                            </div>
                            <h3 class="reward-title">VIP Parking (Week)</h3>
                            <span class="reward-chip-inline">Privilege</span>
                        </div>
                        <p class="reward-desc">Reserved spot by the front entrance for 5 days.</p>
                        <div class="reward-footer">
                            <div class="reward-cost">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 7v5l3 3"></path>
                                </svg>
                                170 pts
                            </div>
                            <button class="redeem-btn" type="button">Redeem</button>
                        </div>
                    </div>
                </article>

                <!-- Events -->
                <article class="reward-card" data-category="events" data-cost="88" data-name="Two Movie Tickets">
                    <div class="reward-body">
                        <div class="reward-head">
                            <div class="reward-mini-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                                    <path d="M6 6v12"></path>
                                    <path d="M18 6v12"></path>
                                </svg>
                            </div>
                            <h3 class="reward-title">2 Movie Tickets</h3>
                            <span class="reward-chip-inline">Events</span>
                        </div>
                        <p class="reward-desc">Valid at AMC or Regal. Includes small popcorn voucher.</p>
                        <div class="reward-footer">
                            <div class="reward-cost">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 7v5l3 3"></path>
                                </svg>
                                88 pts
                            </div>
                            <button class="redeem-btn" type="button">Redeem</button>
                        </div>
                    </div>
                </article>

                <!-- Food -->
                <article class="reward-card" data-category="food" data-cost="42" data-name="Cafe Combo Voucher">
                    <div class="reward-body">
                        <div class="reward-head">
                            <div class="reward-mini-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                                    <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                                    <line x1="6" y1="1" x2="6" y2="4"></line>
                                    <line x1="10" y1="1" x2="10" y2="4"></line>
                                    <line x1="14" y1="1" x2="14" y2="4"></line>
                                </svg>
                            </div>
                            <h3 class="reward-title">Cafe Combo</h3>
                            <span class="reward-chip-inline">Food</span>
                        </div>
                        <p class="reward-desc">Free drink and snack from the school cafe.</p>
                        <div class="reward-footer">
                            <div class="reward-cost">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 7v5l3 3"></path>
                                </svg>
                                42 pts
                            </div>
                            <button class="redeem-btn" type="button">Redeem</button>
                        </div>
                    </div>
                </article>

                <!-- Merch -->
                <article class="reward-card" data-category="merch" data-cost="115" data-name="BackTrack Windbreaker">
                    <div class="reward-body">
                        <div class="reward-head">
                            <div class="reward-mini-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="reward-title">Windbreaker</h3>
                            <span class="reward-chip-inline">Merch</span>
                        </div>
                        <p class="reward-desc">Light jacket with logo. Perfect for rainy mornings.</p>
                        <div class="reward-footer">
                            <div class="reward-cost">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 7v5l3 3"></path>
                                </svg>
                                115 pts
                            </div>
                            <button class="redeem-btn" type="button">Redeem</button>
                        </div>
                    </div>
                </article>

                <!-- Events -->
                <article class="reward-card" data-category="events" data-cost="220" data-name="Prom Ticket Upgrade">
                    <div class="reward-body">
                        <div class="reward-head">
                            <div class="reward-mini-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path
                                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z">
                                    </path>
                                </svg>
                            </div>
                            <h3 class="reward-title">Prom Upgrade</h3>
                            <span class="reward-chip-inline">Events</span>
                        </div>
                        <p class="reward-desc">Priority entry, better seating zone, and photo pass.</p>
                        <div class="reward-footer">
                            <div class="reward-cost">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <path d="M12 7v5l3 3"></path>
                                </svg>
                                220 pts
                            </div>
                            <button class="redeem-btn" type="button">Redeem</button>
                        </div>
                    </div>
                </article>
            </div>
        </section>

        <!-- Leaderboard Section -->
        <section class="lb-section" aria-labelledby="lb-heading">
            <div class="lb-shell">
                <div class="lb-head">
                    <p class="lb-kicker">Live Rankings</p>
                    <h2 class="lb-title" id="lb-heading">Finder Leaderboard</h2>
                    <p class="lb-subtitle">Top contributors by found items and bounty recoveries.</p>
                </div>

                <div class="lb-range" role="tablist" aria-label="Leaderboard time range">
                    <button class="lb-range-btn active" type="button" data-range="month">Monthly</button>
                    <button class="lb-range-btn" type="button" data-range="all">All Time</button>
                </div>

                <div class="lb-podium-wrap" id="lbPodium">
                    <!-- Populated by JS -->
                </div>



                <div class="lb-table-wrap">
                    <div class="lb-table-head" aria-hidden="true">
                        <span>Rank</span>
                        <span>User</span>
                        <span>Found</span>
                        <span>Bounties</span>
                        <span>Score</span>
                    </div>
                    <div class="lb-table" id="lbTableRows">
                        <!-- Populated by JS -->
                    </div>
                </div>


            </div>
        </section>

        <footer>
            <div class="footer-row">
                <div>&copy; 2025 BackTrack. Built for FBLA Website Coding &amp; Development.</div>
                <div>Rewards handled by school administration.</div>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/nav-auth.js"></script>
    <script src="js/accessibility.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="js/leaderboard.js?v=3"></script>
    <script>
        const POINTS_PER_RETURN = 20;
        const POINTS_PER_APPROVED_CLAIM = 5;

        const tierThresholds = [
            { name: 'Bronze', min: 0 },
            { name: 'Silver', min: 120 },
            { name: 'Gold', min: 260 },
            { name: 'Platinum', min: 450 }
        ];

        const state = {
            user: null,
            points: 0,
            stats: {
                returns: 0,
                claims: 0,
                redeemed: 0,
                spent: 0
            }
        };

        const ui = {
            pointsValue: document.getElementById('pointsValue'),
            tierName: document.getElementById('tierName'),
            tierNext: document.getElementById('tierNext'),
            tierFill: document.getElementById('tierFill'),
            returnsValue: document.getElementById('returnsValue'),
            claimsValue: document.getElementById('claimsValue'),
            redeemedValue: document.getElementById('redeemedValue'),
            spentValue: document.getElementById('spentValue'),
            rewardsGrid: document.getElementById('rewardsGrid')
        };

        function getTier(points) {
            let active = tierThresholds[0];
            for (const tier of tierThresholds) {
                if (points >= tier.min) {
                    active = tier;
                }
            }
            return active;
        }

        function getNextTier(points) {
            return tierThresholds.find(t => points < t.min) || null;
        }

        function getTierProgress(points) {
            const current = getTier(points);
            const next = getNextTier(points);
            if (!next) {
                return 100;
            }
            const range = next.min - current.min;
            if (range <= 0) {
                return 100;
            }
            return Math.max(0, Math.min(100, ((points - current.min) / range) * 100));
        }

        function notify(message, type = 'info') {
            if (window.BackTrackToast) {
                window.BackTrackToast(message, type);
                return;
            }
            alert(message);
        }

        function formatNumber(value) {
            return new Intl.NumberFormat().format(value);
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizeRewardCategory(value) {
            const raw = String(value || 'other').trim().toLowerCase();
            const map = {
                event: 'events',
                events: 'events',
                merch: 'merch',
                merchandise: 'merch',
                food: 'food',
                privilege: 'privilege',
                privileges: 'privilege',
                other: 'other'
            };
            return map[raw] || raw || 'other';
        }

        function rewardCategoryLabel(value) {
            const category = normalizeRewardCategory(value);
            return category.charAt(0).toUpperCase() + category.slice(1);
        }

        function rewardIconMarkup(category) {
            const kind = normalizeRewardCategory(category);

            if (kind === 'food') {
                return `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                        <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                    </svg>
                `;
            }

            if (kind === 'merch') {
                return `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4"></path>
                        <path d="M17 9l-5 5-5-5"></path>
                        <path d="M12 14V3"></path>
                    </svg>
                `;
            }

            if (kind === 'privilege') {
                return `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                    </svg>
                `;
            }

            if (kind === 'events') {
                return `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="6" width="20" height="12" rx="2"></rect>
                        <path d="M6 6v12"></path>
                        <path d="M18 6v12"></path>
                    </svg>
                `;
            }

            return `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 3l2.2 4.46 4.92.72-3.56 3.46.84 4.89L12 14.2l-4.4 2.32.84-4.89L4.88 8.18l4.92-.72L12 3z"></path>
                </svg>
            `;
        }

        async function loadRewardCatalogFromBackend() {
            if (typeof BackTrackDB === 'undefined' || typeof BackTrackDB.getRewardCatalog !== 'function') {
                return false;
            }

            const rewards = await BackTrackDB.getRewardCatalog({ activeOnly: true });
            if (!Array.isArray(rewards) || rewards.length === 0) {
                return false;
            }

            ui.rewardsGrid.innerHTML = rewards
                .sort((a, b) => {
                    const costDelta = Number(a.points_cost || 0) - Number(b.points_cost || 0);
                    if (costDelta !== 0) return costDelta;
                    return String(a.name || '').localeCompare(String(b.name || ''));
                })
                .map((reward) => {
                    const category = normalizeRewardCategory(reward.category);
                    const name = escapeHtml(reward.name || 'Reward');
                    const description = escapeHtml(reward.description || 'Redeem this reward from the BackTrack store.');
                    const cost = Number(reward.points_cost || 0);
                    return `
                        <article class="reward-card" data-category="${escapeHtml(category)}" data-cost="${cost}" data-name="${name}">
                            <div class="reward-body">
                                <div class="reward-head">
                                    <div class="reward-mini-icon">${rewardIconMarkup(category)}</div>
                                    <h3 class="reward-title">${name}</h3>
                                    <span class="reward-chip-inline">${escapeHtml(rewardCategoryLabel(category))}</span>
                                </div>
                                <p class="reward-desc">${description}</p>
                                <div class="reward-footer">
                                    <div class="reward-cost">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="9"></circle>
                                            <path d="M12 7v5l3 3"></path>
                                        </svg>
                                        ${cost} pts
                                    </div>
                                    <button class="redeem-btn" type="button">Redeem</button>
                                </div>
                            </div>
                        </article>
                    `;
                }).join('');

            return true;
        }

        function renderRewardsDashboard() {
            if (ui.pointsValue) ui.pointsValue.textContent = formatNumber(state.points);
            if (ui.returnsValue) ui.returnsValue.textContent = formatNumber(state.stats.returns);
            if (ui.claimsValue) ui.claimsValue.textContent = formatNumber(state.stats.claims);
            if (ui.redeemedValue) ui.redeemedValue.textContent = formatNumber(state.stats.redeemed);
            if (ui.spentValue) ui.spentValue.textContent = formatNumber(state.stats.spent);

            if (!state.user) {
                if (ui.tierName) ui.tierName.textContent = 'Tier Locked';
                if (ui.tierNext) ui.tierNext.textContent = 'Log in to see your tier and start redeeming.';
                if (ui.tierFill) ui.tierFill.style.width = '0%';
                return;
            }

            const activeTier = getTier(state.points);
            const nextTier = getNextTier(state.points);
            const progress = getTierProgress(state.points);

            if (ui.tierName) ui.tierName.textContent = activeTier.name + ' Tier';
            if (ui.tierFill) ui.tierFill.style.width = progress.toFixed(2) + '%';

            if (!nextTier) {
                if (ui.tierNext) ui.tierNext.textContent = 'Max tier reached — keep stacking though.';
            } else {
                const delta = nextTier.min - state.points;
                if (ui.tierNext) ui.tierNext.textContent = delta + ' points to ' + nextTier.name + ' tier';
            }
        }

        function updateRewardButtons() {
            const buttons = document.querySelectorAll('.reward-card .redeem-btn');
            buttons.forEach(button => {
                const card = button.closest('.reward-card');
                const cost = Number(card?.dataset.cost || 0);

                if (!state.user) {
                    button.disabled = false;
                    button.textContent = 'Log In';
                    return;
                }

                if (state.points >= cost) {
                    button.disabled = false;
                    button.textContent = 'Redeem';
                } else {
                    button.disabled = true;
                    button.textContent = 'Need ' + (cost - state.points) + ' more';
                }
            });
        }

        function applyFilter(filter) {
            const cards = document.querySelectorAll('.reward-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const isVisible = filter === 'all' || card.dataset.category === filter;
                card.style.display = isVisible ? '' : 'none';
                if (isVisible) {
                    visibleCount += 1;
                }
            });

            const existingEmpty = ui.rewardsGrid.querySelector('.empty-state');
            if (existingEmpty) {
                existingEmpty.remove();
            }

            if (visibleCount === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = 'Nothing here yet. More rewards coming soon.';
                ui.rewardsGrid.appendChild(empty);
            }
        }

        async function redeemReward(card, button) {
            const rewardName = card.dataset.name || 'Reward';
            const rewardCost = Number(card.dataset.cost || 0);

            if (!state.user) {
                notify('You need to log in first.', 'warning');
                window.location.href = 'login.html';
                return;
            }

            if (state.points < rewardCost) {
                notify('Not enough points yet — keep returning items!', 'warning');
                return;
            }

            const confirmed = window.confirm('Redeem ' + rewardName + ' for ' + rewardCost + ' points?');
            if (!confirmed) {
                return;
            }

            const prevText = button.textContent;
            button.classList.add('is-loading');
            button.disabled = true;
            button.textContent = 'Processing...';

            try {
                const { error } = await BackTrackDB.supabase
                    .from('redemptions')
                    .insert([{
                        user_id: state.user.id,
                        reward_name: rewardName,
                        points_cost: rewardCost,
                        status: 'approved'
                    }]);

                if (error) {
                    throw error;
                }

                notify('Redeemed: ' + rewardName + '.', 'success');
                await loadPointsAndStats();
            } catch (error) {
                const message = String(error?.message || 'Failed to redeem reward.');
                if (message.includes('relation') && message.includes('redemptions')) {
                    notify('Redemptions table not set up yet. Ask your admin to run the latest schema.', 'error');
                } else {
                    notify('Something went wrong. Try again in a sec.', 'error');
                }
            } finally {
                button.classList.remove('is-loading');
                if (button.textContent === 'Processing...') {
                    button.textContent = prevText;
                }
                updateRewardButtons();
            }
        }

        async function loadPointsAndStats() {
            state.user = null;
            state.points = 0;
            state.stats = { returns: 0, claims: 0, redeemed: 0, spent: 0 };

            try {
                if (typeof BackTrackDB === 'undefined' || !BackTrackDB.isSupabaseConfigured()) {
                    renderRewardsDashboard();
                    updateRewardButtons();
                    return;
                }

                const { data: { user }, error: userError } = await BackTrackDB.supabase.auth.getUser();
                if (userError || !user) {
                    renderRewardsDashboard();
                    updateRewardButtons();
                    return;
                }

                state.user = user;
                const statuses = ['found', 'claimed'];
                const email = String(user.email || '').trim();

                const [
                    { data: returnsByUserId, error: returnsByUserIdError },
                    { data: returnsByEmail, error: returnsByEmailError },
                    { data: claimsByUserId, error: claimsByUserIdError },
                    { data: claimsByEmail, error: claimsByEmailError },
                    { data: redemptions, error: redemptionsError }
                ] = await Promise.all([
                    BackTrackDB.supabase.from('items').select('id').eq('submitted_by', user.id).in('status', statuses),
                    email
                        ? BackTrackDB.supabase.from('items').select('id').ilike('contact_email', email).in('status', statuses)
                        : Promise.resolve({ data: [], error: null }),
                    BackTrackDB.supabase.from('claims').select('id').eq('claimer_id', user.id).eq('status', 'approved'),
                    email
                        ? BackTrackDB.supabase.from('claims').select('id').ilike('claimer_email', email).eq('status', 'approved')
                        : Promise.resolve({ data: [], error: null }),
                    BackTrackDB.supabase.from('redemptions').select('id, points_cost').eq('user_id', user.id)
                ]);

                if (returnsByUserIdError) throw returnsByUserIdError;
                if (returnsByEmailError) throw returnsByEmailError;
                if (claimsByUserIdError) throw claimsByUserIdError;
                if (claimsByEmailError) throw claimsByEmailError;

                const returnIds = new Set();
                (returnsByUserId || []).forEach(row => {
                    if (row && row.id) returnIds.add(row.id);
                });
                (returnsByEmail || []).forEach(row => {
                    if (row && row.id) returnIds.add(row.id);
                });

                const claimIds = new Set();
                (claimsByUserId || []).forEach(row => {
                    if (row && row.id) claimIds.add(row.id);
                });
                (claimsByEmail || []).forEach(row => {
                    if (row && row.id) claimIds.add(row.id);
                });

                let spentPoints = 0;
                let redeemedCount = 0;
                if (!redemptionsError && Array.isArray(redemptions)) {
                    redeemedCount = redemptions.length;
                    spentPoints = redemptions.reduce((sum, row) => sum + Number(row.points_cost || 0), 0);
                }

                const returns = returnIds.size;
                const claims = claimIds.size;
                const earned = (returns * POINTS_PER_RETURN) + (claims * POINTS_PER_APPROVED_CLAIM);

                state.points = Math.max(0, earned - spentPoints);
                state.stats.returns = returns;
                state.stats.claims = claims;
                state.stats.redeemed = redeemedCount;
                state.stats.spent = spentPoints;

                renderRewardsDashboard();
                updateRewardButtons();
            } catch (error) {
                console.error('Failed loading rewards dashboard', error);
                if (ui.tierName) ui.tierName.textContent = 'Something went wrong';
                if (ui.tierNext) ui.tierNext.textContent = 'Couldn\'t load your points. Try refreshing.';
                if (ui.tierFill) ui.tierFill.style.width = '0%';
                updateRewardButtons();
            }
        }

        function setupEvents() {
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    applyFilter(button.dataset.filter || 'all');
                });
            });

            ui.rewardsGrid.addEventListener('click', async (event) => {
                const button = event.target.closest('.redeem-btn');
                if (!button) return;
                const card = button.closest('.reward-card');
                if (!card) return;
                await redeemReward(card, button);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadRewardCatalogFromBackend();
            setupEvents();
            applyFilter('all');
            if (typeof BackTrackDB !== 'undefined' && BackTrackDB.onAuthStateChange) {
                BackTrackDB.onAuthStateChange(() => {
                    loadPointsAndStats();
                });
            }
            await loadPointsAndStats();
        });
    </script>
</body>

</html>
