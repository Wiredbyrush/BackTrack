<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Campus Map - BackTrack | Denmark High School</title>
    <script>window.__DISABLE_ANIMATIONS__ = true;</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/nav-auth.css">
    <link rel="stylesheet" href="css/theme.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#030712;color:#fff;min-height:100vh;overflow:hidden}
        .nav-spacer{height:70px}
        .map-page{display:flex;height:calc(100vh - 70px)}

        /* ── Sidebar ── */
        .sidebar{
            width:280px;flex-shrink:0;overflow-y:auto;
            background:rgba(3,7,18,0.96);border-right:1px solid rgba(148,163,184,0.1);padding:20px;
        }
        .sidebar h2{font-size:17px;font-weight:700;color:#e2e8f0;margin-bottom:4px}
        .sidebar .sub{font-size:12px;color:#64748b;line-height:1.5;margin-bottom:20px}
        .legend-title{font-size:10px;font-weight:700;color:#475569;letter-spacing:1.2px;text-transform:uppercase;margin-bottom:10px}
        .legend{margin-bottom:16px}
        .legend-row{display:flex;align-items:center;gap:10px;margin-bottom:7px;font-size:12px;color:#94a3b8}
        .dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
        .dot.bl{background:#3b82f6;box-shadow:0 0 6px #3b82f6}
        .dot.gr{background:#22c55e;box-shadow:0 0 6px #22c55e}
        .dot.rd{background:#ef4444;box-shadow:0 0 6px #ef4444}
        .kpi-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
        .kpi{background:rgba(15,23,42,0.5);border:1px solid rgba(148,163,184,0.1);border-radius:10px;padding:12px}
        .kpi-val{font-size:20px;font-weight:700;color:#3b82f6}
        .kpi-lbl{font-size:9px;font-weight:600;color:#475569;letter-spacing:.8px;text-transform:uppercase;margin-top:2px}

        .loc-btn{
            display:flex;align-items:center;justify-content:space-between;width:100%;
            padding:9px 10px;margin-bottom:4px;border-radius:8px;cursor:pointer;
            background:rgba(15,23,42,0.35);border:1px solid rgba(148,163,184,0.08);
            color:#94a3b8;font-size:12px;font-family:inherit;transition:all .15s;
        }
        .loc-btn:hover{background:rgba(30,41,59,0.6);border-color:rgba(96,165,250,0.25);color:#e2e8f0}
        .loc-btn.active{background:rgba(37,99,235,0.12);border-color:rgba(96,165,250,0.4);color:#e2e8f0}
        .loc-btn .badge{font-size:10px;font-weight:600;padding:1px 7px;border-radius:99px;background:rgba(148,163,184,0.08);color:#475569}
        .loc-btn.has-items .badge{background:rgba(239,68,68,0.12);color:#f87171}

        /* ── Back button (floor plan mode) ── */
        .back-btn{
            display:none;align-items:center;gap:6px;width:100%;padding:10px 12px;margin-bottom:12px;
            border-radius:8px;cursor:pointer;font-family:inherit;font-size:12px;font-weight:600;
            background:rgba(37,99,235,0.1);border:1px solid rgba(96,165,250,0.25);color:#93c5fd;
            transition:all .15s;
        }
        .back-btn:hover{background:rgba(37,99,235,0.18);border-color:rgba(96,165,250,0.4);color:#bfdbfe}
        .back-btn svg{width:14px;height:14px;flex-shrink:0}
        body.floor-mode .back-btn{display:flex}

        /* ── Floor Tabs ── */
        .floor-tabs{
            display:none;gap:4px;margin-bottom:12px;
        }
        body.floor-mode .floor-tabs{display:flex}
        .floor-tab{
            flex:1;padding:8px 0;text-align:center;border-radius:8px;cursor:pointer;
            font-family:inherit;font-size:11px;font-weight:600;letter-spacing:.5px;
            background:rgba(15,23,42,0.4);border:1px solid rgba(148,163,184,0.1);color:#64748b;
            transition:all .15s;
        }
        .floor-tab:hover{background:rgba(30,41,59,0.6);color:#94a3b8}
        .floor-tab.active{background:rgba(37,99,235,0.15);border-color:rgba(96,165,250,0.4);color:#93c5fd}

        /* ── Room list (floor plan sidebar) ── */
        .room-list{display:none}
        body.floor-mode .room-list{display:block}
        body.floor-mode .campus-list{display:none}

        /* ── Map ── */
        .map-wrap{flex:1;position:relative;overflow:hidden;background:radial-gradient(ellipse 80% 60% at 40% 40%,rgba(15,23,42,0.6),#030712)}
        .map-inner{width:100%;height:100%;cursor:grab;user-select:none;transform-origin:0 0;transition:opacity .3s}
        .map-inner:active{cursor:grabbing}
        .map-inner svg{width:100%;height:100%}

        /* ── Campus SVG ── */
        .zone{cursor:pointer;transition:filter .2s,opacity .2s}
        .zone:hover{filter:brightness(1.4) drop-shadow(0 0 12px currentColor)}
        .zone.active-zone{filter:brightness(1.5) drop-shadow(0 0 16px currentColor)}
        .zone-fill-b{fill:rgba(59,130,246,0.08);stroke:#3b82f6;stroke-width:2}
        .zone-fill-g{fill:rgba(34,197,94,0.06);stroke:#22c55e;stroke-width:2}
        .zone-fill-b:hover{fill:rgba(59,130,246,0.18)}
        .zone-fill-g:hover{fill:rgba(34,197,94,0.16)}
        .zone.has-items .zone-fill-b{fill:rgba(59,130,246,0.14);stroke-width:2.5}
        .zone.has-items .zone-fill-g{fill:rgba(34,197,94,0.12);stroke-width:2.5}
        .lbl{font-family:'Inter',sans-serif;pointer-events:none;text-anchor:middle;dominant-baseline:central}
        .road-path{fill:none;stroke:#1e293b;stroke-linecap:round;stroke-linejoin:round}
        .pk-line{stroke:rgba(148,163,184,0.06);stroke-width:0.5}
        .field-line{stroke-width:1;opacity:0.2}

        /* ── Floor Plan SVG ── */
        #floorPlan{display:none;width:100%;height:100%}
        body.floor-mode #floorPlan{display:block}
        body.floor-mode #campusSvg{display:none}
        .room{cursor:pointer;transition:fill .15s,filter .15s}
        .room-shape{fill:rgba(59,130,246,0.05);stroke:#3b82f6;stroke-width:1.5;transition:fill .15s,stroke-width .15s}
        .room:hover .room-shape{fill:rgba(59,130,246,0.15);stroke-width:2}
        .room.has-items .room-shape{fill:rgba(239,68,68,0.1);stroke:#f87171;stroke-width:2}
        .room.active-room .room-shape{fill:rgba(59,130,246,0.22);stroke-width:2.5;filter:drop-shadow(0 0 8px rgba(59,130,246,0.4))}
        .room-lbl{font-family:'Inter',sans-serif;pointer-events:none;text-anchor:middle;dominant-baseline:central;fill:#64748b;font-size:9px;font-weight:600}
        .room.has-items .room-lbl{fill:#f87171}
        .hallway{fill:rgba(30,41,59,0.15);stroke:none}
        .wall{stroke:rgba(148,163,184,0.2);stroke-width:1;fill:none}
        .floor-layer{transition:opacity .25s}

        /* ── Item pins on floor plan ── */
        .item-pin{cursor:pointer;transition:transform .15s}
        .item-pin:hover{transform:scale(1.2)}
        .pin-circle{fill:#ef4444;stroke:#fff;stroke-width:1.5;filter:drop-shadow(0 0 4px rgba(239,68,68,0.6))}
        .pin-count{fill:#fff;font-family:'Inter',sans-serif;font-size:8px;font-weight:700;text-anchor:middle;dominant-baseline:central;pointer-events:none}

        /* ── Marker dots (campus view) ── */
        .marker-dot{fill:#ef4444;stroke:#1e1e2e;stroke-width:2;cursor:pointer;filter:drop-shadow(0 0 4px #ef4444)}
        .marker-dot:hover{fill:#fca5a5;filter:drop-shadow(0 0 8px #ef4444)}

        /* ── Enter Building Hint ── */
        .enter-hint{
            position:absolute;bottom:70px;left:50%;transform:translateX(-50%);
            padding:8px 16px;border-radius:99px;font-size:12px;font-weight:500;
            background:rgba(37,99,235,0.15);border:1px solid rgba(96,165,250,0.3);
            color:#93c5fd;backdrop-filter:blur(8px);pointer-events:none;
            opacity:0;transition:opacity .3s;white-space:nowrap;
        }
        .enter-hint.show{opacity:1}

        /* ── Popup ── */
        .popup{
            position:absolute;display:none;z-index:1000;
            background:rgba(3,7,18,0.97);border:1px solid rgba(148,163,184,0.15);
            border-radius:12px;padding:16px;min-width:240px;max-width:320px;
            box-shadow:0 20px 60px rgba(0,0,0,0.7);backdrop-filter:blur(20px);
        }
        .popup.open{display:block}
        .popup-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
        .popup-head h3{font-size:14px;font-weight:700;color:#e2e8f0}
        .popup-x{background:none;border:none;color:#475569;font-size:18px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:6px}
        .popup-x:hover{background:rgba(255,255,255,0.06);color:#e2e8f0}
        .popup-body{max-height:240px;overflow-y:auto}
        .p-item{padding:8px 10px;background:rgba(15,23,42,0.4);border:1px solid rgba(148,163,184,0.08);border-radius:7px;margin-bottom:4px;font-size:12px;cursor:pointer;transition:border-color .15s}
        .p-item:hover{border-color:rgba(96,165,250,0.3)}
        .p-item-name{font-weight:600;color:#e2e8f0;margin-bottom:2px}
        .p-item-meta{color:#64748b;font-size:11px}
        .p-item-status{display:inline-block;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:600;margin-left:4px}
        .p-item-status.found{background:rgba(34,197,94,0.12);color:#4ade80}
        .p-item-status.claimed{background:rgba(251,191,36,0.12);color:#fbbf24}
        .p-empty{text-align:center;padding:14px 6px;color:#475569;font-size:12px}

        /* ── Controls ── */
        .ctrls{position:absolute;bottom:20px;right:20px;display:flex;flex-direction:column;gap:4px;z-index:100}
        .ctrl{
            width:36px;height:36px;border-radius:8px;cursor:pointer;font-family:inherit;
            background:rgba(3,7,18,0.9);border:1px solid rgba(148,163,184,0.12);
            color:#94a3b8;font-size:16px;display:flex;align-items:center;justify-content:center;
            backdrop-filter:blur(8px);transition:all .15s;
        }
        .ctrl:hover{background:rgba(37,99,235,0.12);border-color:rgba(96,165,250,0.3);color:#e2e8f0}

        @media(max-width:820px){.sidebar{display:none}}
    </style>
</head>
<body>
    <nav aria-label="Main navigation" role="navigation">
        <a href="index.html" class="nav-left" aria-label="BackTrack Home">
            <span class="brand-logo">
                <img class="logo-dark" src="logo.png" alt="BackTrack">
                <img class="logo-light" src="logo-white.png" alt="" aria-hidden="true">
            </span>
        </a>
        <div class="nav-center" role="menubar">
            <a href="browse.html" class="nav-link" role="menuitem">Browse</a>
            <a href="map.html" class="nav-link active" role="menuitem" aria-current="page">Map</a>
            <a href="submit.html" class="nav-link" role="menuitem">Submit</a>
            <a href="features.html" class="nav-link" role="menuitem">Features</a>
            <a href="sources.html" class="nav-link" role="menuitem">Sources</a>
        </div>
        <div class="nav-right">
            <a class="sign-in-btn" href="login.html" aria-label="Log in to your account">Log In</a>
        </div>
    </nav>
    <div class="nav-spacer"></div>

    <div class="map-page">
        <div class="sidebar">
            <h2 id="sidebarTitle">Denmark High School</h2>
            <p class="sub" id="sidebarSub">Click any zone to see lost items. Click the main building to explore inside.</p>

            <!-- Back to campus (only in floor mode) -->
            <button class="back-btn" id="backBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                Back to Campus
            </button>

            <!-- Floor tabs (only in floor mode) -->
            <div class="floor-tabs" id="floorTabs">
                <button class="floor-tab active" data-floor="1">Floor 1</button>
                <button class="floor-tab" data-floor="2">Floor 2</button>
            </div>

            <div class="legend">
                <div class="legend-title">Legend</div>
                <div class="legend-row"><span class="dot bl"></span>Academic / Indoor</div>
                <div class="legend-row"><span class="dot gr"></span>Athletic / Outdoor</div>
                <div class="legend-row"><span class="dot rd"></span>Lost Item Reported</div>
            </div>

            <div class="kpi-row">
                <div class="kpi"><div class="kpi-val" id="totalItems">0</div><div class="kpi-lbl">Lost Items</div></div>
                <div class="kpi"><div class="kpi-val" id="activeLocations">0</div><div class="kpi-lbl">Active Areas</div></div>
            </div>

            <div class="campus-list">
                <div class="legend-title">Locations</div>
                <div id="locList"></div>
            </div>

            <div class="room-list">
                <div class="legend-title" id="roomListTitle">Floor 1 Rooms</div>
                <div id="roomLocList"></div>
            </div>
        </div>

        <div class="map-wrap">
            <div class="map-inner" id="mapInner">

                <!-- ════════════════════════════════════════════
                     CAMPUS VIEW SVG
                     ════════════════════════════════════════════ -->
                <svg id="campusSvg" viewBox="0 0 1200 900" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                            <path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(148,163,184,0.03)" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="1200" height="900" fill="url(#grid)"/>

                    <!-- Roads -->
                    <path d="M 80,110 C 80,70 110,50 150,50 L 440,50 C 460,50 475,55 480,70 L 480,140 L 560,140 L 560,50 L 1100,50 C 1140,50 1160,80 1160,110 L 1160,760 C 1160,800 1130,830 1100,830 L 150,830 C 110,830 80,800 80,760 Z" class="road-path" stroke-width="28" opacity="0.2"/>
                    <line x1="560" y1="50" x2="560" y2="830" class="road-path" stroke-width="20" opacity="0.15"/>
                    <line x1="80" y1="520" x2="560" y2="520" class="road-path" stroke-width="16" opacity="0.12"/>
                    <line x1="300" y1="830" x2="300" y2="720" class="road-path" stroke-width="12" opacity="0.1"/>

                    <!-- Parking -->
                    <g opacity="0.35">
                        <rect x="475" y="80" width="90" height="360" rx="3" fill="rgba(30,41,59,0.3)" stroke="#1e293b" stroke-width="1"/>
                        <line x1="480" y1="110" x2="560" y2="110" class="pk-line"/><line x1="480" y1="140" x2="560" y2="140" class="pk-line"/>
                        <line x1="480" y1="170" x2="560" y2="170" class="pk-line"/><line x1="480" y1="200" x2="560" y2="200" class="pk-line"/>
                        <line x1="480" y1="230" x2="560" y2="230" class="pk-line"/><line x1="480" y1="260" x2="560" y2="260" class="pk-line"/>
                        <line x1="480" y1="290" x2="560" y2="290" class="pk-line"/><line x1="480" y1="320" x2="560" y2="320" class="pk-line"/>
                        <line x1="480" y1="350" x2="560" y2="350" class="pk-line"/><line x1="480" y1="380" x2="560" y2="380" class="pk-line"/>
                        <line x1="480" y1="410" x2="560" y2="410" class="pk-line"/>
                    </g>
                    <g opacity="0.3">
                        <rect x="420" y="470" width="130" height="50" rx="2" fill="rgba(30,41,59,0.3)" stroke="#1e293b" stroke-width="0.8"/>
                        <line x1="445" y1="472" x2="445" y2="518" class="pk-line"/><line x1="470" y1="472" x2="470" y2="518" class="pk-line"/>
                        <line x1="495" y1="472" x2="495" y2="518" class="pk-line"/><line x1="520" y1="472" x2="520" y2="518" class="pk-line"/>
                    </g>

                    <!-- Tennis Courts -->
                    <g class="zone" data-zone="Tennis Courts">
                        <rect x="100" y="75" width="75" height="95" rx="3" class="zone-fill-b"/>
                        <rect x="185" y="75" width="75" height="95" rx="3" class="zone-fill-b"/>
                        <rect x="270" y="75" width="75" height="95" rx="3" class="zone-fill-b"/>
                        <rect x="100" y="180" width="75" height="95" rx="3" class="zone-fill-b"/>
                        <rect x="185" y="180" width="75" height="95" rx="3" class="zone-fill-b"/>
                        <rect x="270" y="180" width="75" height="95" rx="3" class="zone-fill-b"/>
                        <line x1="137" y1="78" x2="137" y2="167" stroke="#3b82f6" stroke-width="0.6" opacity="0.3"/>
                        <line x1="222" y1="78" x2="222" y2="167" stroke="#3b82f6" stroke-width="0.6" opacity="0.3"/>
                        <line x1="307" y1="78" x2="307" y2="167" stroke="#3b82f6" stroke-width="0.6" opacity="0.3"/>
                        <line x1="137" y1="183" x2="137" y2="272" stroke="#3b82f6" stroke-width="0.6" opacity="0.3"/>
                        <line x1="222" y1="183" x2="222" y2="272" stroke="#3b82f6" stroke-width="0.6" opacity="0.3"/>
                        <line x1="307" y1="183" x2="307" y2="272" stroke="#3b82f6" stroke-width="0.6" opacity="0.3"/>
                        <text x="222" y="155" class="lbl" fill="#3b82f6" font-size="11" font-weight="600">TENNIS COURTS</text>
                    </g>

                    <!-- Main Building (clickable to enter floor plan) -->
                    <g class="zone" data-zone="Main Building" id="mainBuildingZone">
                        <path d="M 130,310 L 130,300 L 180,300 L 180,310 L 260,310 L 260,300 L 340,300 L 340,310 L 455,310 L 455,520 L 400,520 L 400,560 L 340,560 L 340,520 L 210,520 L 210,560 L 160,560 L 160,520 L 110,520 L 110,310 Z" class="zone-fill-b" stroke-width="2.5"/>
                        <line x1="220" y1="315" x2="220" y2="515" stroke="#3b82f6" stroke-width="0.4" opacity="0.12"/>
                        <line x1="340" y1="315" x2="340" y2="515" stroke="#3b82f6" stroke-width="0.4" opacity="0.12"/>
                        <line x1="115" y1="400" x2="450" y2="400" stroke="#3b82f6" stroke-width="0.4" opacity="0.12"/>
                        <text x="280" y="400" class="lbl" fill="#3b82f6" font-size="14" font-weight="700">MAIN BUILDING</text>
                        <text x="280" y="420" class="lbl" fill="#3b82f6" font-size="9" font-weight="500" opacity="0.5">Click to explore floors</text>
                    </g>

                    <!-- Cafeteria -->
                    <g class="zone" data-zone="Cafeteria">
                        <rect x="110" y="590" width="150" height="110" rx="4" class="zone-fill-b"/>
                        <text x="185" y="650" class="lbl" fill="#3b82f6" font-size="11" font-weight="600">CAFETERIA</text>
                    </g>

                    <!-- Student Commons -->
                    <g class="zone" data-zone="Student Commons">
                        <rect x="280" y="600" width="110" height="85" rx="4" class="zone-fill-b"/>
                        <text x="335" y="647" class="lbl" fill="#3b82f6" font-size="10" font-weight="600">COMMONS</text>
                    </g>

                    <!-- Portables -->
                    <g class="zone" data-zone="Portables">
                        <rect x="105" y="730" width="40" height="32" rx="2" class="zone-fill-b"/>
                        <rect x="155" y="730" width="40" height="32" rx="2" class="zone-fill-b"/>
                        <rect x="105" y="772" width="40" height="32" rx="2" class="zone-fill-b"/>
                        <rect x="155" y="772" width="40" height="32" rx="2" class="zone-fill-b"/>
                        <text x="150" y="822" class="lbl" fill="#3b82f6" font-size="9" font-weight="600" opacity="0.6">PORTABLES</text>
                    </g>

                    <!-- Media Center -->
                    <g class="zone" data-zone="Media Center">
                        <rect x="320" y="740" width="120" height="60" rx="4" class="zone-fill-b"/>
                        <text x="380" y="775" class="lbl" fill="#3b82f6" font-size="10" font-weight="600">MEDIA CENTER</text>
                    </g>

                    <!-- Track & Stadium -->
                    <g class="zone" data-zone="Track & Stadium">
                        <rect x="780" y="60" width="340" height="220" rx="100" class="zone-fill-g" stroke-width="3"/>
                        <rect x="820" y="95" width="260" height="150" rx="70" fill="none" stroke="#22c55e" stroke-width="0.8" opacity="0.2"/>
                        <line x1="870" y1="105" x2="870" y2="235" stroke="#22c55e" class="field-line"/>
                        <line x1="910" y1="100" x2="910" y2="240" stroke="#22c55e" class="field-line"/>
                        <line x1="950" y1="98" x2="950" y2="242" stroke="#22c55e" class="field-line"/>
                        <line x1="990" y1="100" x2="990" y2="240" stroke="#22c55e" class="field-line"/>
                        <line x1="1030" y1="105" x2="1030" y2="235" stroke="#22c55e" class="field-line"/>
                        <text x="950" y="170" class="lbl" fill="#22c55e" font-size="13" font-weight="700">TRACK &amp; STADIUM</text>
                    </g>

                    <!-- Soccer Field -->
                    <g class="zone" data-zone="Soccer Field">
                        <rect x="770" y="330" width="300" height="175" rx="4" class="zone-fill-g"/>
                        <line x1="920" y1="334" x2="920" y2="501" stroke="#22c55e" class="field-line"/>
                        <circle cx="920" cy="417" r="30" fill="none" stroke="#22c55e" stroke-width="1" opacity="0.2"/>
                        <rect x="774" y="390" width="45" height="55" fill="none" stroke="#22c55e" stroke-width="0.8" opacity="0.15"/>
                        <rect x="1021" y="390" width="45" height="55" fill="none" stroke="#22c55e" stroke-width="0.8" opacity="0.15"/>
                        <text x="920" y="422" class="lbl" fill="#22c55e" font-size="12" font-weight="700">SOCCER FIELD</text>
                    </g>

                    <!-- Baseball Field 1 -->
                    <g class="zone" data-zone="Baseball Field 1">
                        <path d="M 750,680 L 750,590 Q 750,560 780,560 L 820,560 Q 850,560 850,590 L 850,680 Q 850,750 800,780 Q 750,750 750,680 Z" class="zone-fill-g"/>
                        <path d="M 800,600 L 825,630 L 800,660 L 775,630 Z" fill="none" stroke="#22c55e" stroke-width="1" opacity="0.3"/>
                        <path d="M 755,590 Q 800,540 845,590" fill="none" stroke="#22c55e" stroke-width="1" opacity="0.25"/>
                        <text x="800" y="720" class="lbl" fill="#22c55e" font-size="10" font-weight="600">FIELD 1</text>
                    </g>

                    <!-- Baseball Field 2 -->
                    <g class="zone" data-zone="Baseball Field 2">
                        <path d="M 920,680 L 920,590 Q 920,560 950,560 L 990,560 Q 1020,560 1020,590 L 1020,680 Q 1020,750 970,780 Q 920,750 920,680 Z" class="zone-fill-g"/>
                        <path d="M 970,600 L 995,630 L 970,660 L 945,630 Z" fill="none" stroke="#22c55e" stroke-width="1" opacity="0.3"/>
                        <path d="M 925,590 Q 970,540 1015,590" fill="none" stroke="#22c55e" stroke-width="1" opacity="0.25"/>
                        <text x="970" y="720" class="lbl" fill="#22c55e" font-size="10" font-weight="600">FIELD 2</text>
                    </g>

                    <!-- Practice Field -->
                    <g class="zone" data-zone="Practice Field">
                        <rect x="600" y="540" width="120" height="80" rx="3" class="zone-fill-g" stroke-dasharray="6,3"/>
                        <text x="660" y="585" class="lbl" fill="#22c55e" font-size="9" font-weight="600" opacity="0.6">PRACTICE</text>
                    </g>
                </svg>

                <!-- ════════════════════════════════════════════
                     FLOOR PLAN SVG (hidden until user clicks Main Building)
                     ════════════════════════════════════════════ -->
                <svg id="floorPlan" viewBox="0 0 900 650" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <pattern id="fpGrid" width="30" height="30" patternUnits="userSpaceOnUse">
                            <path d="M 30 0 L 0 0 0 30" fill="none" stroke="rgba(148,163,184,0.04)" stroke-width="0.5"/>
                        </pattern>
                    </defs>
                    <rect width="900" height="650" fill="url(#fpGrid)"/>

                    <!-- Building outer wall -->
                    <rect x="40" y="30" width="820" height="590" rx="6" class="wall" stroke-width="2.5" stroke="rgba(59,130,246,0.35)"/>

                    <!-- ── FLOOR 1 ── -->
                    <g id="floor1" class="floor-layer">
                        <!-- Main Hallway (horizontal) -->
                        <rect x="40" y="270" width="820" height="60" class="hallway"/>
                        <!-- Vertical connector hallway -->
                        <rect x="420" y="30" width="55" height="590" class="hallway"/>

                        <!-- FRONT OFFICE / ADMIN -->
                        <g class="room" data-room="Front Office" data-floor="1">
                            <rect x="50" y="40" width="180" height="100" rx="4" class="room-shape"/>
                            <text x="140" y="90" class="room-lbl" font-size="11">FRONT OFFICE</text>
                        </g>

                        <!-- GUIDANCE -->
                        <g class="room" data-room="Guidance" data-floor="1">
                            <rect x="240" y="40" width="170" height="100" rx="4" class="room-shape"/>
                            <text x="325" y="90" class="room-lbl" font-size="11">GUIDANCE</text>
                        </g>

                        <!-- GYMNASIUM -->
                        <g class="room" data-room="Gymnasium" data-floor="1">
                            <rect x="485" y="40" width="365" height="220" rx="4" class="room-shape"/>
                            <text x="668" y="140" class="room-lbl" font-size="14">GYMNASIUM</text>
                            <text x="668" y="160" class="room-lbl" font-size="8" opacity="0.5">Basketball · Volleyball</text>
                            <!-- Court lines -->
                            <rect x="540" y="70" width="255" height="160" rx="0" fill="none" stroke="#3b82f6" stroke-width="0.5" opacity="0.15"/>
                            <circle cx="668" cy="150" r="30" fill="none" stroke="#3b82f6" stroke-width="0.5" opacity="0.1"/>
                            <line x1="668" y1="70" x2="668" y2="230" stroke="#3b82f6" stroke-width="0.5" opacity="0.1"/>
                        </g>

                        <!-- ROOM 101 -->
                        <g class="room" data-room="Room 101" data-floor="1">
                            <rect x="50" y="150" width="130" height="110" rx="4" class="room-shape"/>
                            <text x="115" y="205" class="room-lbl">RM 101</text>
                        </g>

                        <!-- ROOM 102 -->
                        <g class="room" data-room="Room 102" data-floor="1">
                            <rect x="190" y="150" width="120" height="110" rx="4" class="room-shape"/>
                            <text x="250" y="205" class="room-lbl">RM 102</text>
                        </g>

                        <!-- ROOM 103 -->
                        <g class="room" data-room="Room 103" data-floor="1">
                            <rect x="320" y="150" width="90" height="110" rx="4" class="room-shape"/>
                            <text x="365" y="205" class="room-lbl">RM 103</text>
                        </g>

                        <!-- WEIGHT ROOM -->
                        <g class="room" data-room="Weight Room" data-floor="1">
                            <rect x="485" y="270" width="180" height="100" rx="4" class="room-shape"/>
                            <text x="575" y="325" class="room-lbl" font-size="10">WEIGHT ROOM</text>
                        </g>

                        <!-- ROOM 104 -->
                        <g class="room" data-room="Room 104" data-floor="1">
                            <rect x="675" y="270" width="175" height="100" rx="4" class="room-shape"/>
                            <text x="762" y="325" class="room-lbl">RM 104</text>
                        </g>

                        <!-- ROOM 105 -->
                        <g class="room" data-room="Room 105" data-floor="1">
                            <rect x="50" y="340" width="170" height="110" rx="4" class="room-shape"/>
                            <text x="135" y="400" class="room-lbl">RM 105</text>
                        </g>

                        <!-- ROOM 106 -->
                        <g class="room" data-room="Room 106" data-floor="1">
                            <rect x="230" y="340" width="180" height="110" rx="4" class="room-shape"/>
                            <text x="320" y="400" class="room-lbl">RM 106</text>
                        </g>

                        <!-- LIBRARY -->
                        <g class="room" data-room="Library" data-floor="1">
                            <rect x="485" y="380" width="365" height="120" rx="4" class="room-shape"/>
                            <text x="668" y="440" class="room-lbl" font-size="12">LIBRARY</text>
                            <text x="668" y="458" class="room-lbl" font-size="8" opacity="0.5">Media Center · Study</text>
                        </g>

                        <!-- ROOM 107 -->
                        <g class="room" data-room="Room 107" data-floor="1">
                            <rect x="50" y="460" width="130" height="150" rx="4" class="room-shape"/>
                            <text x="115" y="540" class="room-lbl">RM 107</text>
                        </g>

                        <!-- ROOM 108 -->
                        <g class="room" data-room="Room 108" data-floor="1">
                            <rect x="190" y="460" width="120" height="150" rx="4" class="room-shape"/>
                            <text x="250" y="540" class="room-lbl">RM 108</text>
                        </g>

                        <!-- ROOM 109 -->
                        <g class="room" data-room="Room 109" data-floor="1">
                            <rect x="320" y="460" width="90" height="150" rx="4" class="room-shape"/>
                            <text x="365" y="540" class="room-lbl">RM 109</text>
                        </g>

                        <!-- RESTROOMS F1 -->
                        <g class="room" data-room="Restrooms" data-floor="1">
                            <rect x="485" y="510" width="120" height="100" rx="4" class="room-shape" stroke-dasharray="4,2"/>
                            <text x="545" y="565" class="room-lbl" font-size="9">RESTROOMS</text>
                        </g>

                        <!-- TEACHER LOUNGE -->
                        <g class="room" data-room="Teacher Lounge" data-floor="1">
                            <rect x="615" y="510" width="120" height="100" rx="4" class="room-shape"/>
                            <text x="675" y="555" class="room-lbl" font-size="9">TEACHERS</text>
                            <text x="675" y="570" class="room-lbl" font-size="8" opacity="0.5">LOUNGE</text>
                        </g>

                        <!-- STORAGE -->
                        <g class="room" data-room="Storage" data-floor="1">
                            <rect x="745" y="510" width="105" height="100" rx="4" class="room-shape" stroke-dasharray="4,2"/>
                            <text x="798" y="565" class="room-lbl" font-size="9">STORAGE</text>
                        </g>
                    </g>

                    <!-- ── FLOOR 2 ── -->
                    <g id="floor2" class="floor-layer" opacity="0" style="pointer-events:none">
                        <!-- Main Hallway -->
                        <rect x="40" y="270" width="820" height="60" class="hallway"/>
                        <rect x="420" y="30" width="55" height="590" class="hallway"/>

                        <!-- ROOM 201 -->
                        <g class="room" data-room="Room 201" data-floor="2">
                            <rect x="50" y="40" width="170" height="110" rx="4" class="room-shape"/>
                            <text x="135" y="95" class="room-lbl">RM 201</text>
                        </g>

                        <!-- ROOM 202 -->
                        <g class="room" data-room="Room 202" data-floor="2">
                            <rect x="230" y="40" width="180" height="110" rx="4" class="room-shape"/>
                            <text x="320" y="95" class="room-lbl">RM 202</text>
                        </g>

                        <!-- SCIENCE LAB 1 -->
                        <g class="room" data-room="Science Lab 1" data-floor="2">
                            <rect x="485" y="40" width="180" height="110" rx="4" class="room-shape"/>
                            <text x="575" y="90" class="room-lbl" font-size="10">SCIENCE LAB 1</text>
                        </g>

                        <!-- SCIENCE LAB 2 -->
                        <g class="room" data-room="Science Lab 2" data-floor="2">
                            <rect x="675" y="40" width="175" height="110" rx="4" class="room-shape"/>
                            <text x="762" y="90" class="room-lbl" font-size="10">SCIENCE LAB 2</text>
                        </g>

                        <!-- ROOM 203 -->
                        <g class="room" data-room="Room 203" data-floor="2">
                            <rect x="50" y="160" width="130" height="100" rx="4" class="room-shape"/>
                            <text x="115" y="210" class="room-lbl">RM 203</text>
                        </g>

                        <!-- ROOM 204 -->
                        <g class="room" data-room="Room 204" data-floor="2">
                            <rect x="190" y="160" width="120" height="100" rx="4" class="room-shape"/>
                            <text x="250" y="210" class="room-lbl">RM 204</text>
                        </g>

                        <!-- ROOM 205 -->
                        <g class="room" data-room="Room 205" data-floor="2">
                            <rect x="320" y="160" width="90" height="100" rx="4" class="room-shape"/>
                            <text x="365" y="210" class="room-lbl">RM 205</text>
                        </g>

                        <!-- COMPUTER LAB -->
                        <g class="room" data-room="Computer Lab" data-floor="2">
                            <rect x="485" y="160" width="180" height="100" rx="4" class="room-shape"/>
                            <text x="575" y="210" class="room-lbl" font-size="10">COMPUTER LAB</text>
                        </g>

                        <!-- ART ROOM -->
                        <g class="room" data-room="Art Room" data-floor="2">
                            <rect x="675" y="160" width="175" height="100" rx="4" class="room-shape"/>
                            <text x="762" y="210" class="room-lbl" font-size="10">ART ROOM</text>
                        </g>

                        <!-- ROOM 206 -->
                        <g class="room" data-room="Room 206" data-floor="2">
                            <rect x="50" y="340" width="170" height="130" rx="4" class="room-shape"/>
                            <text x="135" y="410" class="room-lbl">RM 206</text>
                        </g>

                        <!-- ROOM 207 -->
                        <g class="room" data-room="Room 207" data-floor="2">
                            <rect x="230" y="340" width="180" height="130" rx="4" class="room-shape"/>
                            <text x="320" y="410" class="room-lbl">RM 207</text>
                        </g>

                        <!-- MUSIC ROOM -->
                        <g class="room" data-room="Music Room" data-floor="2">
                            <rect x="485" y="340" width="180" height="130" rx="4" class="room-shape"/>
                            <text x="575" y="410" class="room-lbl" font-size="10">MUSIC ROOM</text>
                        </g>

                        <!-- ROOM 208 -->
                        <g class="room" data-room="Room 208" data-floor="2">
                            <rect x="675" y="340" width="175" height="130" rx="4" class="room-shape"/>
                            <text x="762" y="410" class="room-lbl">RM 208</text>
                        </g>

                        <!-- ROOM 209 -->
                        <g class="room" data-room="Room 209" data-floor="2">
                            <rect x="50" y="480" width="170" height="130" rx="4" class="room-shape"/>
                            <text x="135" y="550" class="room-lbl">RM 209</text>
                        </g>

                        <!-- ROOM 210 -->
                        <g class="room" data-room="Room 210" data-floor="2">
                            <rect x="230" y="480" width="180" height="130" rx="4" class="room-shape"/>
                            <text x="320" y="550" class="room-lbl">RM 210</text>
                        </g>

                        <!-- RESTROOMS F2 -->
                        <g class="room" data-room="Restrooms" data-floor="2">
                            <rect x="485" y="480" width="120" height="130" rx="4" class="room-shape" stroke-dasharray="4,2"/>
                            <text x="545" y="550" class="room-lbl" font-size="9">RESTROOMS</text>
                        </g>

                        <!-- ROOM 211 -->
                        <g class="room" data-room="Room 211" data-floor="2">
                            <rect x="615" y="480" width="120" height="130" rx="4" class="room-shape"/>
                            <text x="675" y="550" class="room-lbl">RM 211</text>
                        </g>

                        <!-- ROOM 212 -->
                        <g class="room" data-room="Room 212" data-floor="2">
                            <rect x="745" y="480" width="105" height="130" rx="4" class="room-shape"/>
                            <text x="798" y="550" class="room-lbl">RM 212</text>
                        </g>
                    </g>

                    <!-- Floor label -->
                    <text id="floorLabel" x="450" y="645" class="lbl" fill="rgba(148,163,184,0.3)" font-size="11" font-weight="600">FLOOR 1 — MAIN BUILDING</text>
                </svg>
            </div>

            <!-- Hint for main building -->
            <div class="enter-hint" id="enterHint">Double-click to explore inside</div>

            <div class="ctrls">
                <button class="ctrl" id="zIn" title="Zoom In">+</button>
                <button class="ctrl" id="zOut" title="Zoom Out">&minus;</button>
                <button class="ctrl" id="zReset" title="Reset">&#x21BA;</button>
            </div>

            <div class="popup" id="popup">
                <div class="popup-head">
                    <h3 id="popTitle">Location</h3>
                    <button class="popup-x" id="popClose">&times;</button>
                </div>
                <div class="popup-body" id="popBody"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
    (function(){
        /* ══════════════ STATE ══════════════ */
        let items = [];
        let scale = 1, tx = 0, ty = 0, dragging = false, sx, sy;
        let currentFloor = 1;
        let inFloorMode = false;

        const mapInner = document.getElementById('mapInner');
        const popup = document.getElementById('popup');
        const popTitle = document.getElementById('popTitle');
        const popBody = document.getElementById('popBody');
        const locList = document.getElementById('locList');
        const roomLocList = document.getElementById('roomLocList');
        const enterHint = document.getElementById('enterHint');

        const CAMPUS_ZONES = [
            'Main Building','Cafeteria','Student Commons','Tennis Courts',
            'Media Center','Portables',
            'Track & Stadium','Soccer Field','Baseball Field 1','Baseball Field 2','Practice Field'
        ];

        /* All rooms per floor */
        const FLOOR_ROOMS = {
            1: ['Front Office','Guidance','Gymnasium','Room 101','Room 102','Room 103',
                'Weight Room','Room 104','Room 105','Room 106','Library',
                'Room 107','Room 108','Room 109','Restrooms','Teacher Lounge','Storage'],
            2: ['Room 201','Room 202','Science Lab 1','Science Lab 2','Room 203','Room 204',
                'Room 205','Computer Lab','Art Room','Room 206','Room 207','Music Room',
                'Room 208','Room 209','Room 210','Restrooms','Room 211','Room 212']
        };

        /* ══════════════ LOCATION MAPPING ══════════════ */

        /* Campus-level zone mapping */
        function zoneFor(loc) {
            if (!loc) return 'Main Building';
            const l = loc.toLowerCase();
            if (l.includes('cafeteria') || l.includes('lunch')) return 'Cafeteria';
            if (l.includes('soccer')) return 'Soccer Field';
            if (l.includes('track') || l.includes('stadium') || l.includes('football')) return 'Track & Stadium';
            if (l.includes('baseball') || l.includes('diamond') || l.includes('softball')) return 'Baseball Field 1';
            if (l.includes('tennis') || l.includes('court')) return 'Tennis Courts';
            if (l.includes('commons')) return 'Student Commons';
            if (l.includes('portable') || l.includes('trailer')) return 'Portables';
            if (l.includes('practice')) return 'Practice Field';
            return 'Main Building';
        }

        /* Room-level mapping (for items inside Main Building) */
        function roomFor(loc) {
            if (!loc) return null;
            const l = loc.toLowerCase();
            /* Exact room numbers */
            const rmMatch = l.match(/(?:room|rm)\s*(\d+)/);
            if (rmMatch) return 'Room ' + rmMatch[1];
            /* Named rooms */
            if (l.includes('front office') || l.includes('admin') || l.includes('office')) return 'Front Office';
            if (l.includes('guidance') || l.includes('counselor')) return 'Guidance';
            if (l.includes('gym')) return 'Gymnasium';
            if (l.includes('weight')) return 'Weight Room';
            if (l.includes('library') || l.includes('media center')) return 'Library';
            if (l.includes('science lab 2') || l.includes('chem')) return 'Science Lab 2';
            if (l.includes('science') || l.includes('lab 1') || l.includes('bio')) return 'Science Lab 1';
            if (l.includes('computer') || l.includes('tech')) return 'Computer Lab';
            if (l.includes('art')) return 'Art Room';
            if (l.includes('music') || l.includes('band')) return 'Music Room';
            if (l.includes('teacher') || l.includes('lounge') || l.includes('staff')) return 'Teacher Lounge';
            if (l.includes('restroom') || l.includes('bathroom')) return 'Restrooms';
            if (l.includes('storage')) return 'Storage';
            return null;
        }

        /* Which floor is a room on? */
        function floorForRoom(roomName) {
            if (FLOOR_ROOMS[1].includes(roomName)) return 1;
            if (FLOOR_ROOMS[2].includes(roomName)) return 2;
            return 1;
        }

        /* Items that belong inside the main building */
        function mainBuildingItems() {
            return items.filter(i => zoneFor(i.location) === 'Main Building');
        }

        /* ══════════════ DATA LOADING ══════════════ */
        async function loadItems() {
            if (typeof BackTrackDB === 'undefined') return;
            try {
                const data = await BackTrackDB.getItems({ status: ['found', 'claimed'] });
                items = data || [];
                refreshCampus();
                if (inFloorMode) refreshFloorPlan();
            } catch(e) { console.error('Map load error:', e); }
        }

        /* ══════════════ CAMPUS VIEW ══════════════ */
        function refreshCampus() {
            document.getElementById('totalItems').textContent = items.length;
            document.getElementById('activeLocations').textContent =
                new Set(items.map(i => i.location).filter(Boolean)).size;

            const counts = {};
            items.forEach(i => { const z = zoneFor(i.location); counts[z] = (counts[z]||0) + 1; });

            document.querySelectorAll('.zone').forEach(g => {
                g.classList.toggle('has-items', (counts[g.dataset.zone]||0) > 0);
            });

            /* Remove old campus markers */
            document.querySelectorAll('#campusSvg .marker-dot, #campusSvg .marker-count').forEach(el => el.remove());

            const svg = document.getElementById('campusSvg');
            Object.entries(counts).forEach(([zone, count]) => {
                const el = svg.querySelector(`[data-zone="${zone}"]`);
                if (!el) return;
                const shape = el.querySelector('rect, path');
                if (!shape) return;
                const bb = shape.getBBox();
                const cx = bb.x + bb.width / 2, cy = bb.y + 16;

                const dot = document.createElementNS('http://www.w3.org/2000/svg','circle');
                dot.setAttribute('cx', cx); dot.setAttribute('cy', cy);
                dot.setAttribute('r', Math.min(10, 5 + count));
                dot.classList.add('marker-dot'); dot.dataset.zone = zone;
                dot.addEventListener('click', e => { e.stopPropagation(); openCampusPopup(zone, e); });
                svg.appendChild(dot);

                if (count > 1) {
                    const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
                    txt.setAttribute('x', cx); txt.setAttribute('y', cy + 3.5);
                    txt.setAttribute('text-anchor','middle'); txt.setAttribute('fill','#fff');
                    txt.setAttribute('font-size','8'); txt.setAttribute('font-weight','700');
                    txt.setAttribute('font-family','Inter,sans-serif'); txt.setAttribute('pointer-events','none');
                    txt.classList.add('marker-count'); txt.textContent = count;
                    svg.appendChild(txt);
                }
            });

            renderCampusList(counts);
        }

        function renderCampusList(counts) {
            if (!counts) { counts = {}; items.forEach(i => { const z = zoneFor(i.location); counts[z] = (counts[z]||0) + 1; }); }
            locList.innerHTML = CAMPUS_ZONES.map(z => {
                const c = counts[z] || 0;
                return `<button class="loc-btn${c ? ' has-items' : ''}" data-zone="${z}">
                    <span>${z}</span><span class="badge">${c}</span>
                </button>`;
            }).join('');

            locList.querySelectorAll('.loc-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    document.querySelectorAll('.zone').forEach(g => g.classList.remove('active-zone'));
                    const zoneEl = document.querySelector(`[data-zone="${btn.dataset.zone}"]`);
                    if (zoneEl) zoneEl.classList.add('active-zone');
                    openCampusPopup(btn.dataset.zone, e);
                });
            });
        }

        function openCampusPopup(zone, event) {
            const zoneItems = items.filter(i => zoneFor(i.location) === zone);
            if (zoneItems.length === 0) {
                popTitle.textContent = zone;
                popBody.innerHTML = '<div class="p-empty">No lost items reported here</div>';
            } else {
                popTitle.textContent = zone + ' (' + zoneItems.length + ')';
                popBody.innerHTML = zoneItems.map(i => `
                    <div class="p-item" onclick="window.open('claim.html?id=${i.id}','_self')">
                        <div class="p-item-name">${i.name || 'Unknown Item'}
                            <span class="p-item-status ${i.status||''}">${i.status||''}</span>
                        </div>
                        <div class="p-item-meta">${i.location || ''} &middot; ${i.category || ''}</div>
                    </div>`).join('');
            }
            positionPopup(event);
        }

        /* ══════════════ FLOOR PLAN VIEW ══════════════ */
        function enterFloorMode() {
            inFloorMode = true;
            document.body.classList.add('floor-mode');
            scale = 1; tx = 0; ty = 0; setTransform();
            document.getElementById('sidebarTitle').textContent = 'Main Building';
            document.getElementById('sidebarSub').textContent = 'Floor plan view — click any room to see items.';
            document.getElementById('roomListTitle').textContent = 'Floor ' + currentFloor + ' Rooms';
            closePopup();
            refreshFloorPlan();
        }

        function exitFloorMode() {
            inFloorMode = false;
            document.body.classList.remove('floor-mode');
            scale = 1; tx = 0; ty = 0; setTransform();
            document.getElementById('sidebarTitle').textContent = 'Denmark High School';
            document.getElementById('sidebarSub').textContent = 'Click any zone to see lost items. Click the main building to explore inside.';
            closePopup();
        }

        function switchFloor(floor) {
            currentFloor = floor;
            document.querySelectorAll('.floor-tab').forEach(t => t.classList.toggle('active', +t.dataset.floor === floor));
            document.getElementById('floor1').style.opacity = floor === 1 ? '1' : '0';
            document.getElementById('floor1').style.pointerEvents = floor === 1 ? 'auto' : 'none';
            document.getElementById('floor2').style.opacity = floor === 2 ? '1' : '0';
            document.getElementById('floor2').style.pointerEvents = floor === 2 ? 'auto' : 'none';
            document.getElementById('floorLabel').textContent = 'FLOOR ' + floor + ' — MAIN BUILDING';
            document.getElementById('roomListTitle').textContent = 'Floor ' + floor + ' Rooms';
            closePopup();
            refreshFloorPlan();
        }

        function refreshFloorPlan() {
            const mbItems = mainBuildingItems();

            /* Count per room */
            const roomCounts = {};
            mbItems.forEach(i => {
                const r = roomFor(i.location);
                if (r) roomCounts[r] = (roomCounts[r] || 0) + 1;
            });

            /* Mark rooms with items */
            document.querySelectorAll('.room').forEach(r => {
                r.classList.toggle('has-items', (roomCounts[r.dataset.room] || 0) > 0);
                r.classList.remove('active-room');
            });

            /* Remove old pins */
            document.querySelectorAll('.item-pin').forEach(el => el.remove());

            /* Add item pins to rooms on current floor */
            const fpSvg = document.getElementById('floorPlan');
            Object.entries(roomCounts).forEach(([room, count]) => {
                if (floorForRoom(room) !== currentFloor) return;
                const roomEl = fpSvg.querySelector(`[data-room="${room}"][data-floor="${currentFloor}"]`);
                if (!roomEl) return;
                const shape = roomEl.querySelector('.room-shape');
                if (!shape) return;
                const bb = shape.getBBox();
                const cx = bb.x + bb.width - 14, cy = bb.y + 14;

                const g = document.createElementNS('http://www.w3.org/2000/svg','g');
                g.classList.add('item-pin'); g.dataset.room = room;
                const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
                circle.setAttribute('cx', cx); circle.setAttribute('cy', cy);
                circle.setAttribute('r', Math.min(12, 7 + count));
                circle.classList.add('pin-circle');
                g.appendChild(circle);
                const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
                txt.setAttribute('x', cx); txt.setAttribute('y', cy);
                txt.classList.add('pin-count'); txt.textContent = count;
                g.appendChild(txt);
                g.addEventListener('click', e => { e.stopPropagation(); openRoomPopup(room, e); });
                fpSvg.appendChild(g);
            });

            /* Sidebar room list */
            renderRoomList(roomCounts);
        }

        function renderRoomList(roomCounts) {
            const rooms = FLOOR_ROOMS[currentFloor] || [];
            roomLocList.innerHTML = rooms.map(r => {
                const c = roomCounts[r] || 0;
                return `<button class="loc-btn${c ? ' has-items' : ''}" data-room="${r}">
                    <span>${r}</span><span class="badge">${c}</span>
                </button>`;
            }).join('');

            roomLocList.querySelectorAll('.loc-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    document.querySelectorAll('.room').forEach(r => r.classList.remove('active-room'));
                    const roomEl = document.querySelector(`[data-room="${btn.dataset.room}"][data-floor="${currentFloor}"]`);
                    if (roomEl) roomEl.classList.add('active-room');
                    openRoomPopup(btn.dataset.room, e);
                });
            });
        }

        function openRoomPopup(room, event) {
            const roomItems = mainBuildingItems().filter(i => roomFor(i.location) === room);
            if (roomItems.length === 0) {
                popTitle.textContent = room;
                popBody.innerHTML = '<div class="p-empty">No lost items in this room</div>';
            } else {
                popTitle.textContent = room + ' (' + roomItems.length + ')';
                popBody.innerHTML = roomItems.map(i => `
                    <div class="p-item" onclick="window.open('claim.html?id=${i.id}','_self')">
                        <div class="p-item-name">${i.name || 'Unknown Item'}
                            <span class="p-item-status ${i.status||''}">${i.status||''}</span>
                        </div>
                        <div class="p-item-meta">${i.location || ''} &middot; ${i.category || ''}</div>
                    </div>`).join('');
            }
            positionPopup(event);
        }

        /* ══════════════ SHARED POPUP ══════════════ */
        function positionPopup(event) {
            const wrap = document.querySelector('.map-wrap').getBoundingClientRect();
            let left = event.clientX - wrap.left + 12;
            let top = event.clientY - wrap.top - 8;
            if (left + 280 > wrap.width) left = wrap.width - 290;
            if (top + 200 > wrap.height) top = wrap.height - 210;
            if (left < 8) left = 8; if (top < 8) top = 8;
            popup.style.left = left + 'px'; popup.style.top = top + 'px';
            popup.classList.add('open');
        }

        function closePopup() {
            popup.classList.remove('open');
            document.querySelectorAll('.zone').forEach(z => z.classList.remove('active-zone'));
            document.querySelectorAll('.room').forEach(r => r.classList.remove('active-room'));
        }

        /* ══════════════ EVENT HANDLERS ══════════════ */

        /* Campus zone clicks */
        document.querySelectorAll('.zone').forEach(g => {
            g.addEventListener('click', e => {
                e.stopPropagation();
                document.querySelectorAll('.zone').forEach(z => z.classList.remove('active-zone'));
                g.classList.add('active-zone');
                openCampusPopup(g.dataset.zone, e);
            });
        });

        /* Double-click main building to enter floor plan */
        document.getElementById('mainBuildingZone').addEventListener('dblclick', e => {
            e.stopPropagation();
            enterFloorMode();
        });

        /* Show hint on hover over main building */
        let hintTimer;
        document.getElementById('mainBuildingZone').addEventListener('mouseenter', () => {
            if (inFloorMode) return;
            hintTimer = setTimeout(() => enterHint.classList.add('show'), 400);
        });
        document.getElementById('mainBuildingZone').addEventListener('mouseleave', () => {
            clearTimeout(hintTimer);
            enterHint.classList.remove('show');
        });

        /* Floor plan room clicks */
        document.getElementById('floorPlan').addEventListener('click', e => {
            const room = e.target.closest('.room');
            if (room) {
                e.stopPropagation();
                document.querySelectorAll('.room').forEach(r => r.classList.remove('active-room'));
                room.classList.add('active-room');
                openRoomPopup(room.dataset.room, e);
            }
        });

        /* Back button */
        document.getElementById('backBtn').addEventListener('click', exitFloorMode);

        /* Floor tabs */
        document.querySelectorAll('.floor-tab').forEach(tab => {
            tab.addEventListener('click', () => switchFloor(+tab.dataset.floor));
        });

        /* Close popup */
        document.getElementById('popClose').addEventListener('click', closePopup);
        document.addEventListener('click', e => {
            if (!popup.contains(e.target) && !e.target.closest('.zone,.loc-btn,.marker-dot,.room,.item-pin')) closePopup();
        });

        /* ══════════════ PAN & ZOOM ══════════════ */
        function setTransform() {
            mapInner.style.transform = 'translate(' + tx + 'px,' + ty + 'px) scale(' + scale + ')';
        }
        mapInner.addEventListener('mousedown', e => {
            if (e.target.closest('.zone,.marker-dot,.ctrl,.room,.item-pin')) return;
            dragging = true; sx = e.clientX - tx; sy = e.clientY - ty;
            mapInner.style.cursor = 'grabbing';
        });
        document.addEventListener('mousemove', e => { if (!dragging) return; tx = e.clientX - sx; ty = e.clientY - sy; setTransform(); });
        document.addEventListener('mouseup', () => { dragging = false; mapInner.style.cursor = 'grab'; });
        mapInner.addEventListener('wheel', e => {
            e.preventDefault();
            scale = Math.max(0.4, Math.min(4, scale * (e.deltaY > 0 ? 0.92 : 1.08)));
            setTransform();
        }, { passive: false });
        document.getElementById('zIn').addEventListener('click', () => { scale = Math.min(4, scale * 1.25); setTransform(); });
        document.getElementById('zOut').addEventListener('click', () => { scale = Math.max(0.4, scale / 1.25); setTransform(); });
        document.getElementById('zReset').addEventListener('click', () => { scale = 1; tx = 0; ty = 0; setTransform(); });

        /* Touch */
        let lastTouchDist = 0;
        mapInner.addEventListener('touchstart', e => {
            if (e.touches.length === 1) { dragging = true; sx = e.touches[0].clientX - tx; sy = e.touches[0].clientY - ty; }
            else if (e.touches.length === 2) { lastTouchDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); }
        }, { passive: true });
        mapInner.addEventListener('touchmove', e => {
            if (e.touches.length === 1 && dragging) { tx = e.touches[0].clientX - sx; ty = e.touches[0].clientY - sy; setTransform(); }
            else if (e.touches.length === 2) { const d = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); if (lastTouchDist > 0) { scale = Math.max(0.4, Math.min(4, scale * (d / lastTouchDist))); setTransform(); } lastTouchDist = d; }
        }, { passive: true });
        mapInner.addEventListener('touchend', () => { dragging = false; lastTouchDist = 0; });

        /* ══════════════ INIT ══════════════ */
        function init() {
            if (typeof BackTrackDB === 'undefined') { setTimeout(init, 200); return; }
            loadItems();
            if (BackTrackDB.supabase) {
                BackTrackDB.supabase.channel('map_live')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => loadItems())
                    .subscribe();
            }
        }
        renderCampusList({});
        init();
    })();
    </script>
    <script src="js/nav-auth.js"></script>
</body>
</html>
