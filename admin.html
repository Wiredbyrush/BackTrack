<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Admin Panel - BackTrack</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/nav-auth.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            height: 70px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            z-index: 100;
        }

        .nav-spacer {
            height: 70px;
        }

        .nav-left {
            display: flex;
            align-items: center;
            text-decoration: none;
        }

        .nav-left img {
            height: 60px;
            width: auto;
        }

        .nav-center {
            display: flex;
            gap: 40px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.45);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: rgba(255, 255, 255, 0.8);
        }

        .nav-link.active {
            color: #fff;
        }

        .nav-right {
            display: flex;
            align-items: center;
        }

        .sign-in-btn {
            background: linear-gradient(180deg, #2e2e2e 0%, #1a1a1a 100%);
            color: #f3f4f6;
            border: 1px solid #3f3f3f;
            padding: 8px 18px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
        }

        /* Admin Layout */
        .admin-layout {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        /* Sidebar */
        .admin-sidebar {
            width: 240px;
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid rgba(255, 255, 255, 0.06);
            padding: 28px 16px;
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .sidebar-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #555;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 28px;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 11px 12px;
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.5);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-base);
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            position: relative;
        }

        /* Animated left border */
        .sidebar-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #3b82f6, #60a5fa);
            transform: scaleY(0);
            transition: transform var(--transition-base);
        }

        .sidebar-link:hover::before,
        .sidebar-link.active::before {
            transform: scaleY(1);
        }

        .sidebar-link:hover {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(59, 130, 246, 0.08);
            transform: translateX(2px);
        }

        .sidebar-link.active {
            color: #fff;
            background: rgba(59, 130, 246, 0.12);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
        }

        .sidebar-link .link-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
            transition: transform var(--transition-base);
        }

        .sidebar-link:hover .link-icon,
        .sidebar-link.active .link-icon {
            transform: scale(1.1);
        }

        .sidebar-link .link-badge {
            margin-left: auto;
            background: rgba(148, 163, 184, 0.15);
            padding: 3px 9px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 700;
            color: #94a3b8;
            transition: all var(--transition-base);
        }

        .sidebar-link.active .link-badge {
            background: rgba(37, 99, 235, 0.2);
            color: #60a5fa;
        }

        .sidebar-link:hover .link-badge {
            transform: scale(1.05);
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            padding: 36px 40px 80px;
            max-width: 960px;
        }

        .admin-main-title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }

        .admin-main-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 32px;
        }

        /* Panel visibility */
        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dashboard Stats */
        .dash-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
            margin-bottom: 36px;
        }

        .dash-stat {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 20px;
        }

        .dash-stat-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .dash-stat-value {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .dash-stat-value.pending {
            color: #f59e0b;
        }

        .dash-stat-value.claims {
            color: #6366f1;
        }

        .dash-stat-value.bounties {
            color: #ec4899;
        }

        .dash-stat-value.active {
            color: #22c55e;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            margin-bottom: 36px;
        }

        .quick-action {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .quick-action:hover {
            border-color: rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.04);
        }

        .quick-action-icon {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .quick-action-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .quick-action-title {
            font-size: 14px;
            font-weight: 700;
        }

        .quick-action-desc {
            font-size: 12px;
            color: #666;
        }

        /* Status Banner */
        .admin-status {
            padding: 14px 18px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            color: #fca5a5;
            font-size: 14px;
            margin-bottom: 24px;
            display: none;
        }

        .admin-status.visible {
            display: block;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
        }

        .section-count {
            background: rgba(255, 255, 255, 0.06);
            padding: 3px 10px;
            border-radius: 99px;
            font-size: 12px;
            color: #999;
            font-weight: 600;
        }

        /* Cards */
        .cards-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .review-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 20px 24px;
            transition: border-color 0.2s;
        }

        .review-card:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .card-info {
            flex: 1;
            min-width: 0;
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .card-meta {
            color: #777;
            font-size: 13px;
            line-height: 1.6;
        }

        .card-proof {
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            color: #aaa;
            font-size: 13px;
            line-height: 1.5;
        }

        .card-proof strong {
            color: #ccc;
            font-weight: 600;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .btn {
            padding: clamp(7px, 1.5vw, 10px) clamp(14px, 3vw, 18px);
            border-radius: var(--radius-sm);
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-approve {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25);
        }

        .btn-approve:hover {
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.35);
        }

        .btn-reject {
            background: rgba(239, 68, 68, 0.12);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-reject:hover {
            background: rgba(239, 68, 68, 0.18);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .card-status {
            margin-top: 10px;
            font-size: 13px;
            color: #22c55e;
        }

        .card-status.error {
            color: #fca5a5;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: #555;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #555;
            font-size: 14px;
        }

        /* Urgency Badges */
        .urgency-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 11px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            border: 1px solid;
            transition: all var(--transition-base);
        }

        .urgency-low {
            background: rgba(37, 99, 235, 0.12);
            color: #60a5fa;
            border-color: rgba(37, 99, 235, 0.3);
        }

        .urgency-medium {
            background: rgba(245, 158, 11, 0.12);
            color: #fbbf24;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .urgency-high {
            background: rgba(239, 68, 68, 0.12);
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.3);
            animation: pulse-urgent 2s ease-in-out infinite;
        }

        @keyframes pulse-urgent {
            0%, 100% { box-shadow: 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 12px rgba(239, 68, 68, 0.4); }
        }

        /* Map filter buttons */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .filter-btn {
            padding: 7px 14px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: transparent;
            color: #888;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .filter-btn:hover {
            border-color: rgba(255, 255, 255, 0.15);
            color: #ccc;
        }

        .filter-btn.active {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .dash-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                display: none;
            }

            .admin-main {
                padding: 24px 20px 60px;
            }

            .dash-stats {
                grid-template-columns: 1fr 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .card-top {
                flex-direction: column;
            }

            .card-actions {
                width: 100%;
            }

            .btn {
                flex: 1;
                text-align: center;
            }

            nav {
                padding: 0 20px;
            }

            /* Mobile nav tabs */
            .mobile-tabs {
                display: flex;
                gap: 4px;
                padding: 12px 20px;
                overflow-x: auto;
                border-bottom: 1px solid rgba(255, 255, 255, 0.06);
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
            }

            .mobile-tab {
                padding: 8px 14px;
                border-radius: 8px;
                border: none;
                background: transparent;
                color: #888;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                white-space: nowrap;
                font-family: inherit;
            }

            .mobile-tab.active {
                background: rgba(255, 255, 255, 0.08);
                color: #fff;
            }
        }

        @media (min-width: 769px) {
            .mobile-tabs {
                display: none;
            }
        }

        /* ===== DASHBOARD REDESIGN ===== */
        .dash-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .dash-header-actions {
            display: flex;
            gap: 8px;
        }

        .dash-export-btn {
            padding: 7px 16px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
            color: #aaa;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .dash-export-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .analytics-range-select {
            padding: 7px 14px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.04);
            color: #aaa;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            -webkit-appearance: none;
            appearance: none;
        }

        .analytics-range-select option {
            background: #111;
            color: #ccc;
        }

        /* KPI Cards */
        .dash-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(220px, 100%), 1fr));
            gap: clamp(10px, 2vw, 14px);
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .dash-stats {
                grid-template-columns: repeat(auto-fit, minmax(min(220px, 100%), 1fr));
            }
        }

        .dash-kpi {
            background: var(--gradient-card);
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: var(--radius-md);
            padding: clamp(14px, 3vw, 20px);
            position: relative;
            overflow: hidden;
        }

        .kpi-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .kpi-label {
            font-size: 11px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .kpi-spark {
            display: block;
        }

        .kpi-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .kpi-badge.positive {
            background: rgba(34, 197, 94, 0.12);
            color: #4ade80;
        }

        .kpi-value {
            font-size: clamp(24px, 5vw, 32px);
            font-weight: 800;
            letter-spacing: -1.2px;
            line-height: 1;
            margin-bottom: 6px;
            background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .kpi-unit {
            font-size: 18px;
            font-weight: 600;
            color: #888;
        }

        .kpi-sub {
            font-size: 11px;
            color: #555;
            font-weight: 500;
        }

        /* Trend Chart */
        .dash-chart-wrap {
            background: rgba(255, 255, 255, 0.025);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .dash-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .dash-chart-title {
            font-size: 14px;
            font-weight: 700;
            color: #e5e5e5;
        }

        .dash-chart-subtitle {
            font-size: 11px;
            color: #555;
            margin-top: 2px;
            font-weight: 500;
        }

        .dash-chart-legend {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #888;
            font-weight: 500;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        #dashTrendChart {
            width: 100%;
            height: 200px;
        }

        /* Bottom Grid */
        .dash-bottom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(400px, 100%), 1fr));
            gap: clamp(12px, 2vw, 16px);
        }

        @media (max-width: 900px) {
            .dash-bottom-grid {
                grid-template-columns: 1fr;
            }
        }

        .dash-recent-card,
        .dash-actions-card {
            background: rgba(255, 255, 255, 0.025);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 18px;
        }

        .dash-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .dash-card-title {
            font-size: 13px;
            font-weight: 700;
            color: #ccc;
        }

        .dash-card-link {
            font-size: 11px;
            color: #3b82f6;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            font-family: inherit;
        }

        .dash-card-link:hover {
            color: #60a5fa;
        }

        /* Recent Activity Mini-Feed */
        .dash-recent-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }

        .dash-recent-item:last-child {
            border-bottom: none;
        }

        .dash-recent-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .dash-recent-text {
            font-size: 12px;
            color: #aaa;
            flex: 1;
            font-weight: 500;
        }

        .dash-recent-time {
            font-size: 10px;
            color: #555;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Quick Actions Grid */
        .dash-qa-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .dash-qa {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: transparent;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            text-align: left;
        }

        .dash-qa:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.08);
        }

        .qa-icon {
            font-size: 14px;
            flex-shrink: 0;
        }

        .qa-text {
            font-size: 11px;
            color: #aaa;
            font-weight: 600;
            flex: 1;
        }

        .qa-count {
            font-size: 10px;
            color: #666;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.06);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* ===== ANALYTICS REDESIGN ===== */
        .metric-strip {
            display: flex;
            align-items: center;
            gap: 0;
            background: rgba(255, 255, 255, 0.025);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 16px 4px;
            margin-bottom: 20px;
        }

        .metric-item {
            flex: 1;
            text-align: center;
            padding: 0 12px;
        }

        .metric-value {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: #fff;
        }

        .metric-label {
            font-size: 10px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .metric-change {
            font-size: 10px;
            font-weight: 700;
            margin-top: 4px;
        }

        .metric-change.positive {
            color: #4ade80;
        }

        .metric-change.negative {
            color: #f87171;
        }

        .metric-divider {
            width: 1px;
            height: 36px;
            background: rgba(255, 255, 255, 0.06);
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .metric-strip {
                flex-wrap: wrap;
                gap: 12px;
            }

            .metric-divider {
                display: none;
            }

            .metric-item {
                min-width: 80px;
            }
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(380px, 100%), 1fr));
            gap: clamp(12px, 2vw, 16px);
            margin-bottom: 16px;
        }

        @media (max-width: 900px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.025);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 20px;
        }

        .chart-card canvas {
            width: 100%;
            display: block;
        }

        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-card-title {
            font-size: 14px;
            font-weight: 700;
            color: #e5e5e5;
        }

        .chart-card-subtitle {
            font-size: 11px;
            color: #555;
            font-weight: 500;
        }

        .chart-card-tabs {
            display: flex;
            gap: 2px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 6px;
            padding: 2px;
        }

        .chart-tab {
            padding: 4px 12px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }

        .chart-tab.active {
            background: rgba(255, 255, 255, 0.08);
            color: #ddd;
        }

        /* Doughnut */
        .doughnut-wrap {
            position: relative;
            display: flex;
            justify-content: center;
            padding: 10px 0;
        }

        .doughnut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .doughnut-center-val {
            font-size: 24px;
            font-weight: 800;
            color: #fff;
        }

        .doughnut-center-label {
            font-size: 10px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
        }

        .doughnut-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #888;
            font-weight: 500;
        }

        .legend-swatch {
            width: 8px;
            height: 8px;
            border-radius: 2px;
        }

        /* Location List */
        .loc-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .loc-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .loc-row-rank {
            width: 20px;
            font-size: 11px;
            font-weight: 700;
            color: #555;
            text-align: center;
        }

        .loc-row-name {
            min-width: 100px;
            flex: 0 0 auto;
            font-size: 12px;
            color: #bbb;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .loc-row-bar-bg {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 3px;
            overflow: hidden;
        }

        .loc-row-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 3px;
            transition: width 0.6s ease;
        }

        .loc-row-val {
            font-size: 11px;
            color: #888;
            font-weight: 700;
            width: 28px;
            text-align: right;
        }

        /* Heatmap */
        .heatmap-scale {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
            font-size: 10px;
            color: #555;
            font-weight: 600;
        }

        .heatmap-blocks {
            display: flex;
            gap: 3px;
        }

        .heatmap-blocks span {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* ===== MESSAGES ===== */
        .messages-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(400px, 100%), 1fr));
            gap: clamp(12px, 2vw, 16px);
        }

        @media (max-width: 900px) {
            .messages-layout {
                grid-template-columns: 1fr;
            }
        }

        .compose-card,
        .templates-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 24px;
        }

        .compose-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .form-select,
        .form-input,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
            font-size: 13px;
            font-family: inherit;
            outline: none;
            transition: all var(--transition-base);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .form-select:focus,
        .form-input:focus,
        .form-textarea:focus {
            border-color: #3b82f6;
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15), 0 4px 12px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }

        .form-select:hover:not(:focus),
        .form-input:hover:not(:focus),
        .form-textarea:hover:not(:focus) {
            border-color: rgba(148, 163, 184, 0.3);
            background: rgba(15, 23, 42, 0.7);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-select option {
            background: #1a1a2e;
            color: #fff;
        }

        .send-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border-radius: var(--radius-sm);
            border: none;
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: #fff;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all var(--transition-base);
            font-family: inherit;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.45);
        }

        .send-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .template-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(255, 255, 255, 0.02);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 10px;
            text-align: left;
            font-family: inherit;
        }

        .template-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.12);
        }

        .template-icon {
            font-size: 24px;
        }

        .template-name {
            font-size: 13px;
            font-weight: 600;
            color: #ddd;
        }

        .template-desc {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }

        .empty-state {
            padding: 32px;
            text-align: center;
            color: #555;
            font-size: 13px;
        }

        /* Sent message card */
        .sent-msg-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .sent-msg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .sent-msg-subject {
            font-size: 14px;
            font-weight: 700;
        }

        .sent-msg-time {
            font-size: 11px;
            color: #666;
        }

        .sent-msg-recipient {
            font-size: 12px;
            color: #60a5fa;
            margin-bottom: 6px;
        }

        .sent-msg-body {
            font-size: 12px;
            color: #888;
            line-height: 1.5;
        }

        /* ===== USERS TABLE ===== */
        .users-table-wrap {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: var(--admin-bg-card);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .users-table th {
            text-align: left;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.04);
            font-size: 11px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .users-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            color: #ccc;
        }

        .users-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 11px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            border: 1px solid;
            transition: all var(--transition-base);
        }

        .role-badge.admin {
            background: rgba(37, 99, 235, 0.12);
            color: #60a5fa;
            border-color: rgba(37, 99, 235, 0.3);
        }

        .role-badge.user {
            background: rgba(148, 163, 184, 0.12);
            color: #94a3b8;
            border-color: rgba(148, 163, 184, 0.28);
        }

        /* Mobile: Switch users table to card layout */
        @media (max-width: 900px) {
            .users-table {
                display: block;
            }

            .users-table thead {
                display: none;
            }

            .users-table tbody,
            .users-table tr {
                display: block;
            }

            .users-table tr {
                margin-bottom: 16px;
                border-radius: var(--radius-md);
                border: 1px solid rgba(148, 163, 184, 0.2);
                background: var(--admin-bg-card);
                padding: 16px;
            }

            .users-table tr:hover {
                border-color: rgba(96, 165, 250, 0.4);
            }

            .users-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 0;
                border: none;
                border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            }

            .users-table td:last-child {
                border-bottom: none;
            }

            .users-table td::before {
                content: attr(data-label);
                font-weight: 700;
                font-size: 11px;
                color: #888;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
        }

        @media (max-width: 640px) {
            .users-table-wrap {
                border-radius: 10px;
                border: none;
            }

            .users-table tr {
                padding: 14px;
            }
        }

        /* ===== ACTIVITY LOG ===== */
        .activity-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 16px 18px;
            border-radius: var(--radius-md);
            background: var(--admin-glass-bg);
            border: 1px solid rgba(148, 163, 184, 0.12);
            transition: all var(--transition-base);
            position: relative;
        }

        /* Left border indicator */
        .activity-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--activity-color, #64748b);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .activity-item:hover::before {
            opacity: 1;
        }

        .activity-item:hover {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(148, 163, 184, 0.25);
            transform: translateX(4px);
            box-shadow: var(--shadow-card);
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .activity-icon.approval {
            background: rgba(34, 197, 94, 0.15);
        }

        .activity-icon.claim {
            background: rgba(37, 99, 235, 0.15);
        }

        .activity-icon.message {
            background: rgba(168, 85, 247, 0.15);
        }

        .activity-icon.system {
            background: rgba(245, 158, 11, 0.15);
        }

        /* Activity type colors for left border */
        .activity-item[data-type="approval"] {
            --activity-color: #22c55e;
        }

        .activity-item[data-type="claim"] {
            --activity-color: #2563eb;
        }

        .activity-item[data-type="message"] {
            --activity-color: #a855f7;
        }

        .activity-item[data-type="system"] {
            --activity-color: #f59e0b;
        }

        .activity-content {
            flex: 1;
        }

        .activity-desc {
            font-size: 13px;
            color: #ccc;
            font-weight: 500;
        }

        .activity-desc strong {
            color: #fff;
        }

        .activity-meta {
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        /* ===== PAGE POLISH + REWARDS ADMIN ===== */
        body {
            background:
                radial-gradient(1400px 800px at 25% -15%, rgba(30, 64, 175, 0.28), transparent 70%),
                radial-gradient(1100px 600px at 105% 25%, rgba(6, 182, 212, 0.18), transparent 65%),
                radial-gradient(900px 700px at 50% 100%, rgba(99, 102, 241, 0.12), transparent 68%),
                linear-gradient(180deg, rgba(4, 6, 11, 0.98), rgba(4, 6, 11, 0.95)),
                #04060b;
            background-attachment: fixed;
        }

        .admin-layout {
            width: min(1600px, 100%);
            margin: 0 auto;
            align-items: flex-start;
        }

        .admin-sidebar {
            width: 256px;
            background: linear-gradient(180deg, rgba(10, 14, 24, 0.95), rgba(8, 11, 20, 0.88));
        }

        .admin-main {
            max-width: none;
            width: 100%;
            padding: 28px clamp(18px, 3vw, 36px) 70px;
        }

        .admin-main-title {
            letter-spacing: -0.7px;
        }

        .admin-main-desc {
            color: #93a3bf;
            margin-bottom: 22px;
        }

        .review-card,
        .chart-card,
        .dash-kpi,
        .dash-chart-wrap,
        .dash-recent-card,
        .dash-actions-card,
        .compose-card,
        .templates-card {
            background: var(--admin-glass-bg);
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: var(--shadow-card);
            backdrop-filter: var(--admin-glass-blur);
            -webkit-backdrop-filter: var(--admin-glass-blur);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        /* Subtle top gradient on hover */
        .review-card::before,
        .chart-card::before,
        .dash-kpi::before,
        .dash-chart-wrap::before,
        .dash-recent-card::before,
        .dash-actions-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.3) 50%, transparent);
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .review-card:hover::before,
        .chart-card:hover::before,
        .dash-kpi:hover::before,
        .dash-chart-wrap:hover::before,
        .dash-recent-card:hover::before,
        .dash-actions-card:hover::before {
            opacity: 1;
        }

        .review-card:hover,
        .chart-card:hover,
        .dash-kpi:hover,
        .dash-chart-wrap:hover,
        .dash-recent-card:hover,
        .dash-actions-card:hover {
            border-color: rgba(96, 165, 250, 0.35);
            box-shadow: var(--shadow-elevated), 0 0 0 1px rgba(96, 165, 250, 0.1);
            transform: translateY(-2px);
        }

        .rewards-admin-stats {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .reward-stat-card {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(10, 14, 24, 0.88);
        }

        .reward-stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: #8fa0be;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .reward-stat-value {
            font-size: 28px;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.6px;
        }

        .rewards-admin-grid {
            display: grid;
            grid-template-columns: minmax(320px, 0.95fr) minmax(420px, 1.2fr);
            gap: 14px;
        }

        .reward-editor-card,
        .reward-catalog-card {
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 12px;
            padding: 18px;
            background: rgba(10, 14, 24, 0.88);
        }

        .reward-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
        }

        .checkbox-wrap {
            display: inline-flex;
            align-items: center;
            gap: 9px;
            font-size: 12px;
            color: #b6c2d8;
            font-weight: 500;
            cursor: pointer;
        }

        .checkbox-wrap input {
            accent-color: #3b82f6;
        }

        .reward-form-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-neutral {
            background: rgba(148, 163, 184, 0.12);
            color: #dbe4f4;
            border: 1px solid rgba(148, 163, 184, 0.28);
            transition: all var(--transition-base);
        }

        .btn-neutral:hover {
            border-color: rgba(96, 165, 250, 0.5);
            color: #fff;
            background: rgba(148, 163, 184, 0.18);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-neutral:active {
            transform: translateY(0) scale(0.98);
        }

        .reward-item-card {
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 10px;
            padding: 14px;
            background: rgba(5, 9, 18, 0.82);
        }

        .reward-item-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .reward-item-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .reward-item-meta {
            color: #a6b2c8;
            font-size: 12px;
            line-height: 1.45;
        }

        .reward-item-desc {
            color: #8d9ab2;
            font-size: 12px;
            margin-top: 8px;
            line-height: 1.5;
        }

        .reward-item-actions {
            display: flex;
            gap: 7px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .reward-chip {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            border: 1px solid rgba(96, 165, 250, 0.45);
            color: #7cb1ff;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            padding: 2px 7px;
            margin-left: 8px;
        }

        .reward-pill {
            display: inline-flex;
            align-items: center;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 999px;
            letter-spacing: 0.4px;
        }

        .reward-pill.active {
            color: #86efac;
            background: rgba(34, 197, 94, 0.16);
        }

        .reward-pill.inactive {
            color: #fca5a5;
            background: rgba(239, 68, 68, 0.15);
        }

        .redemption-row {
            border: 1px solid rgba(148, 163, 184, 0.2);
            background: rgba(10, 14, 24, 0.88);
            border-radius: 10px;
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .redemption-title {
            font-size: 13px;
            font-weight: 700;
        }

        .redemption-meta {
            font-size: 12px;
            color: #9aa8c0;
            margin-top: 3px;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 4px 11px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            font-weight: 700;
            border: 1px solid;
            transition: all var(--transition-base);
        }

        .status-pill.pending {
            color: #fde68a;
            border-color: rgba(245, 158, 11, 0.3);
            background: rgba(245, 158, 11, 0.12);
        }

        .status-pill.approved,
        .status-pill.delivered {
            color: #86efac;
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.12);
        }

        .status-pill.rejected,
        .status-pill.canceled {
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(239, 68, 68, 0.12);
        }

        .status-pill.other {
            color: #cbd5e1;
            border-color: rgba(148, 163, 184, 0.28);
            background: rgba(148, 163, 184, 0.12);
        }

        @media (max-width: 1150px) {
            .rewards-admin-stats {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .rewards-admin-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .admin-main {
                padding: 22px 14px 60px;
            }

            .reward-form-row {
                grid-template-columns: 1fr;
            }
        }

        /* ===== ADMIN DESIGN TOKENS ===== */
        :root {
            /* Enhanced backgrounds */
            --admin-bg-base: #04060b;
            --admin-bg-card: rgba(10, 14, 24, 0.88);
            --admin-glass-bg: rgba(15, 23, 42, 0.7);
            --admin-glass-border: rgba(148, 163, 184, 0.15);
            --admin-glass-blur: blur(16px);

            /* Enhanced shadows */
            --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.4), 0 1px 4px rgba(0, 0, 0, 0.2);
            --shadow-elevated: 0 8px 32px rgba(0, 0, 0, 0.5), 0 2px 8px rgba(0, 0, 0, 0.3);

            /* Gradients */
            --gradient-card: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(10, 14, 24, 0.9) 100%);
            --gradient-border: linear-gradient(135deg, rgba(96, 165, 250, 0.3), rgba(37, 99, 235, 0.1));

            /* Spacing */
            --spacing-section: clamp(20px, 4vw, 36px);
            --spacing-card: clamp(16px, 3vw, 24px);

            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;

            /* Transitions */
            --transition-base: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Custom Scrollbars */
        .admin-sidebar::-webkit-scrollbar,
        .admin-main::-webkit-scrollbar,
        .activity-feed::-webkit-scrollbar,
        .messages-layout::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .admin-sidebar::-webkit-scrollbar-track,
        .admin-main::-webkit-scrollbar-track,
        .activity-feed::-webkit-scrollbar-track,
        .messages-layout::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        .admin-sidebar::-webkit-scrollbar-thumb,
        .admin-main::-webkit-scrollbar-thumb,
        .activity-feed::-webkit-scrollbar-thumb,
        .messages-layout::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.25);
            border-radius: 3px;
        }

        .admin-sidebar::-webkit-scrollbar-thumb:hover,
        .admin-main::-webkit-scrollbar-thumb:hover,
        .activity-feed::-webkit-scrollbar-thumb:hover,
        .messages-layout::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.35);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 60px;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Loading skeleton for cards */
        .skeleton {
            background: linear-gradient(90deg, rgba(148, 163, 184, 0.05) 25%, rgba(148, 163, 184, 0.1) 50%, rgba(148, 163, 184, 0.05) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
            border-radius: var(--radius-md);
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
    <link rel="stylesheet" href="css/theme.css">
</head>

<body>
    <nav>
        <a class="nav-left" href="index.html"><span class="brand-logo">
                <img class="logo-dark" src="logo.png" alt="BackTrack">
                <img class="logo-light" src="logo-white.png" alt="" aria-hidden="true">
            </span></a>
        <div class="nav-center">
            <a class="nav-link" href="browse.html">Browse</a>
            <a class="nav-link" href="map.html">Map</a>
            <a class="nav-link" href="submit.html">Submit</a>
            <a class="nav-link" href="features.html">Features</a>
            <a class="nav-link" href="sources.html">Sources</a>
        </div>
        <div class="nav-right">
            <a class="sign-in-btn" href="login.html">Log In</a>
        </div>
    </nav>
    <div class="nav-spacer"></div>

    <!-- Mobile Tabs (visible on small screens) -->
    <div class="mobile-tabs">
        <button class="mobile-tab active" data-panel="dashboard">Dashboard</button>
        <button class="mobile-tab" data-panel="submissions">Submissions</button>
        <button class="mobile-tab" data-panel="claims">Claims</button>
        <button class="mobile-tab" data-panel="bounties">Bounties</button>
        <button class="mobile-tab" data-panel="rewards">Rewards</button>
        <button class="mobile-tab" data-panel="map">Map</button>
        <button class="mobile-tab" data-panel="analytics">Analytics</button>
        <button class="mobile-tab" data-panel="messages">Messages</button>
        <button class="mobile-tab" data-panel="users">Users</button>
        <button class="mobile-tab" data-panel="activity">Activity</button>
    </div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-label">Overview</div>
            <div class="sidebar-nav">
                <button class="sidebar-link active" data-panel="dashboard">
                    <span class="link-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7" />
                            <rect x="14" y="3" width="7" height="7" />
                            <rect x="14" y="14" width="7" height="7" />
                            <rect x="3" y="14" width="7" height="7" />
                        </svg></span> Dashboard
                </button>
            </div>

            <div class="sidebar-label">Manage</div>
            <div class="sidebar-nav">
                <button class="sidebar-link" data-panel="submissions">
                    <span class="link-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path
                                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
                            <polyline points="3.27 6.96 12 12.01 20.73 6.96" />
                            <line x1="12" y1="22.08" x2="12" y2="12" />
                        </svg></span> Submissions
                    <span class="link-badge" id="sidebarItemsBadge">0</span>
                </button>
                <button class="sidebar-link" data-panel="claims">
                    <span class="link-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg></span> Claims
                    <span class="link-badge" id="sidebarClaimsBadge">0</span>
                </button>
                <button class="sidebar-link" data-panel="bounties">
                    <span class="link-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <path d="M21 21l-4.35-4.35" />
                        </svg>
                    </span> Bounties
                    <span class="link-badge" id="sidebarBountiesBadge">0</span>
                </button>
                <button class="sidebar-link" data-panel="rewards">
                    <span class="link-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3l2.2 4.46 4.92.72-3.56 3.46.84 4.89L12 14.2l-4.4 2.32.84-4.89L4.88 8.18l4.92-.72L12 3z" />
                        </svg>
                    </span> Rewards
                    <span class="link-badge" id="sidebarRewardsBadge">0</span>
                </button>
                <button class="sidebar-link" data-panel="users">
                    <span class="link-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg></span> Users
                </button>
            </div>

            <div class="sidebar-label">Tools</div>
            <div class="sidebar-nav">
                <button class="sidebar-link" data-panel="map">
                    <span class="link-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6" />
                            <line x1="8" y1="2" x2="8" y2="18" />
                            <line x1="16" y1="6" x2="16" y2="22" />
                        </svg></span> Map Items
                    <span class="link-badge" id="sidebarMapBadge">0</span>
                </button>
                <button class="sidebar-link" data-panel="analytics">
                    <span class="link-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10" />
                            <line x1="12" y1="20" x2="12" y2="4" />
                            <line x1="6" y1="20" x2="6" y2="14" />
                        </svg></span> Analytics
                </button>
                <button class="sidebar-link" data-panel="messages">
                    <span class="link-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                        </svg></span> Messages
                </button>
                <button class="sidebar-link" data-panel="activity">
                    <span class="link-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                        </svg></span> Activity Log
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="admin-main">
            <div class="admin-status" id="adminStatus"></div>

            <!-- Dashboard Panel -->
            <div class="admin-panel active" id="panel-dashboard">
                <div class="dash-header-row">
                    <div>
                        <h1 class="admin-main-title">Dashboard</h1>
                        <p class="admin-main-desc" id="dashGreeting">Overview  <span id="dashDate"></span></p>
                    </div>
                    <div class="dash-header-actions">
                        <button class="dash-export-btn" onclick="alert('Report exported.')">Export Report</button>
                    </div>
                </div>

                <div class="dash-stats" id="dashStats">
                    <div class="dash-kpi">
                        <div class="kpi-top">
                            <span class="kpi-label">Pending Items</span>
                            <canvas class="kpi-spark" id="sparkPending" width="64" height="28"></canvas>
                        </div>
                        <div class="kpi-value" id="pendingCount">0</div>
                        <div class="kpi-sub">Awaiting review</div>
                    </div>
                    <div class="dash-kpi">
                        <div class="kpi-top">
                            <span class="kpi-label">Active Claims</span>
                            <canvas class="kpi-spark" id="sparkClaims" width="64" height="28"></canvas>
                        </div>
                        <div class="kpi-value" id="claimsCount">0</div>
                        <div class="kpi-sub">Need verification</div>
                    </div>
                    <div class="dash-kpi">
                        <div class="kpi-top">
                            <span class="kpi-label">Open Bounties</span>
                            <canvas class="kpi-spark" id="sparkBounties" width="64" height="28"></canvas>
                        </div>
                        <div class="kpi-value" id="bountiesCount">0</div>
                        <div class="kpi-sub">Students searching</div>
                    </div>
                    <div class="dash-kpi">
                        <div class="kpi-top">
                            <span class="kpi-label">Recovery Rate</span>
                            <span class="kpi-badge positive" id="recoveryRateBadge"></span>
                        </div>
                        <div class="kpi-value"><span id="recoveryRateKpi">0</span><span class="kpi-unit">%</span></div>
                        <div class="kpi-sub">Last 30 days</div>
                    </div>
                </div>

                <!-- Trend Chart -->
                <div class="dash-chart-wrap">
                    <div class="dash-chart-header">
                        <div>
                            <div class="dash-chart-title">Item Submissions</div>
                            <div class="dash-chart-subtitle">Last 30 days  found vs claimed</div>
                        </div>
                        <div class="dash-chart-legend">
                            <span class="legend-dot" style="background:#3b82f6"></span> Found
                            <span class="legend-dot" style="background:#22c55e;margin-left:12px"></span> Claimed
                        </div>
                    </div>
                    <canvas id="dashTrendChart" width="800" height="200"></canvas>
                </div>

                <!-- Bottom Row: Recent Activity + Quick Actions -->
                <div class="dash-bottom-grid">
                    <div class="dash-recent-card">
                        <div class="dash-card-header">
                            <span class="dash-card-title">Recent Activity</span>
                            <button class="dash-card-link" onclick="switchPanel('activity')">View all </button>
                        </div>
                        <div class="dash-recent-list" id="dashRecentList"></div>
                    </div>
                    <div class="dash-actions-card">
                        <div class="dash-card-header">
                            <span class="dash-card-title">Quick Actions</span>
                        </div>
                        <div class="dash-qa-grid">
                            <button class="dash-qa" onclick="switchPanel('submissions')">
                                <span class="qa-icon" style="color:#f59e0b"></span>
                                <span class="qa-text">Review Submissions</span>
                                <span class="qa-count" id="qaSubmissions">0</span>
                            </button>
                            <button class="dash-qa" onclick="switchPanel('claims')">
                                <span class="qa-icon" style="color:#818cf8"></span>
                                <span class="qa-text">Verify Claims</span>
                                <span class="qa-count" id="qaClaims">0</span>
                            </button>
                            <button class="dash-qa" onclick="switchPanel('bounties')">
                                <span class="qa-icon" style="color:#ec4899"></span>
                                <span class="qa-text">Manage Bounties</span>
                                <span class="qa-count" id="qaBounties">0</span>
                            </button>
                            <button class="dash-qa" onclick="switchPanel('rewards')">
                                <span class="qa-icon" style="color:#f59e0b"></span>
                                <span class="qa-text">Rewards Catalog</span>
                                <span class="qa-count" id="qaRewards">0</span>
                            </button>
                            <button class="dash-qa" onclick="switchPanel('map')">
                                <span class="qa-icon" style="color:#22c55e"></span>
                                <span class="qa-text">Map Items</span>
                                <span class="qa-count" id="qaMap">0</span>
                            </button>
                            <button class="dash-qa" onclick="switchPanel('messages')">
                                <span class="qa-icon" style="color:#60a5fa"></span>
                                <span class="qa-text">Send Message</span>
                            </button>
                            <button class="dash-qa" onclick="switchPanel('analytics')">
                                <span class="qa-icon" style="color:#a78bfa"></span>
                                <span class="qa-text">View Analytics</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submissions Panel -->
            <div class="admin-panel" id="panel-submissions">
                <h1 class="admin-main-title">Pending Submissions</h1>
                <p class="admin-main-desc">Review and approve found item reports</p>
                <div class="section-header">
                    <h2 class="section-title">Items</h2>
                    <span class="section-count" id="itemsCountBadge">0</span>
                </div>
                <div class="cards-list" id="pendingItems">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Claims Panel -->
            <div class="admin-panel" id="panel-claims">
                <h1 class="admin-main-title">Pending Claims</h1>
                <p class="admin-main-desc">Verify ownership claims from students</p>
                <div class="section-header">
                    <h2 class="section-title">Claims</h2>
                    <span class="section-count" id="claimsCountBadge">0</span>
                </div>
                <div class="cards-list" id="pendingClaims">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Bounties Panel -->
            <div class="admin-panel" id="panel-bounties">
                <h1 class="admin-main-title">Active Bounties</h1>
                <p class="admin-main-desc">Manage lost item bounty posts from students</p>
                <div class="section-header">
                    <h2 class="section-title">Bounties</h2>
                    <span class="section-count" id="bountiesCountBadge">0</span>
                </div>
                <div class="cards-list" id="bountyItems">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Rewards Panel -->
            <div class="admin-panel" id="panel-rewards">
                <h1 class="admin-main-title">Rewards &amp; Prizes</h1>
                <p class="admin-main-desc">Set live rewards, adjust points cost, and review redemption activity</p>

                <div class="rewards-admin-stats">
                    <div class="reward-stat-card">
                        <div class="reward-stat-label">Active Rewards</div>
                        <div class="reward-stat-value" id="rewardsActiveCount">0</div>
                    </div>
                    <div class="reward-stat-card">
                        <div class="reward-stat-label">Archived</div>
                        <div class="reward-stat-value" id="rewardsArchivedCount">0</div>
                    </div>
                    <div class="reward-stat-card">
                        <div class="reward-stat-label">Total Redemptions</div>
                        <div class="reward-stat-value" id="rewardsRedeemedCount">0</div>
                    </div>
                    <div class="reward-stat-card">
                        <div class="reward-stat-label">Pending Redemptions</div>
                        <div class="reward-stat-value" id="rewardsPendingCount">0</div>
                    </div>
                </div>

                <div class="rewards-admin-grid">
                    <div class="reward-editor-card">
                        <div class="section-header">
                            <h2 class="section-title" id="rewardFormTitle">Create Reward</h2>
                        </div>
                        <form id="rewardForm" class="reward-form">
                            <div class="form-group">
                                <label class="form-label" for="rewardName">Reward Name</label>
                                <input class="form-input" id="rewardName" type="text" maxlength="120" required
                                    placeholder="e.g. School Hoodie">
                            </div>
                            <div class="reward-form-row">
                                <div class="form-group">
                                    <label class="form-label" for="rewardCategory">Category</label>
                                    <select class="form-select" id="rewardCategory" required>
                                        <option value="food">Food</option>
                                        <option value="merch">Merch</option>
                                        <option value="privilege">Privilege</option>
                                        <option value="events">Events</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="rewardPoints">Points Cost</label>
                                    <input class="form-input" id="rewardPoints" type="number" min="1" max="5000"
                                        required placeholder="80">
                                </div>
                            </div>
                            <div class="reward-form-row">
                                <div class="form-group">
                                    <label class="form-label" for="rewardStock">Stock (optional)</label>
                                    <input class="form-input" id="rewardStock" type="number" min="0"
                                        placeholder="Leave blank for unlimited">
                                </div>
                                <div class="form-group checkbox-group">
                                    <label class="checkbox-wrap" for="rewardActive">
                                        <input id="rewardActive" type="checkbox" checked>
                                        <span>Visible to students right now</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="rewardDescription">Description</label>
                                <textarea class="form-textarea" id="rewardDescription" rows="4"
                                    placeholder="Short details students should see when redeeming."></textarea>
                            </div>
                            <div class="reward-form-actions">
                                <button class="send-btn" id="rewardSaveBtn" type="submit">Save Reward</button>
                                <button class="btn btn-neutral" id="rewardCancelBtn" type="button"
                                    onclick="clearRewardForm()">Cancel Edit</button>
                            </div>
                        </form>
                    </div>

                    <div class="reward-catalog-card">
                        <div class="section-header">
                            <h2 class="section-title">Catalog</h2>
                            <span class="section-count" id="rewardsCatalogCountBadge">0</span>
                        </div>
                        <div class="cards-list" id="rewardsCatalog">
                            <div class="loading">Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="section-header" style="margin-top:24px">
                    <h2 class="section-title">Recent Redemptions</h2>
                    <span class="section-count" id="rewardsRedemptionCountBadge">0</span>
                </div>
                <div class="cards-list" id="rewardRedemptions">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Map Panel -->
            <div class="admin-panel" id="panel-map">
                <h1 class="admin-main-title">Map Items</h1>
                <p class="admin-main-desc">Manage items pinned to the school map</p>
                <div class="section-header">
                    <h2 class="section-title">Items on Map</h2>
                    <span class="section-count" id="mapItemsCountBadge">0</span>
                </div>
                <div class="filter-bar">
                    <button class="filter-btn active" onclick="filterMapItems('all', this)">All Floors</button>
                    <button class="filter-btn" onclick="filterMapItems(1, this)">Floor 1</button>
                    <button class="filter-btn" onclick="filterMapItems(2, this)">Floor 2</button>
                </div>
                <div class="cards-list" id="mapItems"></div>
            </div>

            <!-- Analytics Panel -->
            <div class="admin-panel" id="panel-analytics">
                <div class="dash-header-row">
                    <div>
                        <h1 class="admin-main-title">Analytics</h1>
                        <p class="admin-main-desc">Performance overview  last 30 days</p>
                    </div>
                    <div class="dash-header-actions">
                        <select class="analytics-range-select" id="analyticsRange">
                            <option value="30">Last 30 days</option>
                            <option value="7">Last 7 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                </div>

                <!-- Metric Strip -->
                <div class="metric-strip">
                    <div class="metric-item">
                        <div class="metric-value" id="metricTotalItems">0</div>
                        <div class="metric-label">Total Items</div>
                        <div class="metric-change positive" id="metricTotalItemsChange"></div>
                    </div>
                    <div class="metric-divider"></div>
                    <div class="metric-item">
                        <div class="metric-value" id="metricThisWeek">0</div>
                        <div class="metric-label">This Week</div>
                        <div class="metric-change positive" id="metricThisWeekChange"></div>
                    </div>
                    <div class="metric-divider"></div>
                    <div class="metric-item">
                        <div class="metric-value" id="metricRecoveryRate">0%</div>
                        <div class="metric-label">Recovery Rate</div>
                        <div class="metric-change positive" id="metricRecoveryRateChange"></div>
                    </div>
                    <div class="metric-divider"></div>
                    <div class="metric-item">
                        <div class="metric-value" id="metricAvgResolution">0d</div>
                        <div class="metric-label">Avg Resolution</div>
                        <div class="metric-change positive" id="metricAvgResolutionChange"></div>
                    </div>
                    <div class="metric-divider"></div>
                    <div class="metric-item">
                        <div class="metric-value" id="metricActiveUsers">0</div>
                        <div class="metric-label">Active Users</div>
                        <div class="metric-change positive" id="metricActiveUsersChange"></div>
                    </div>
                </div>

                <!-- Charts Row 1: Line Chart + Doughnut -->
                <div class="analytics-grid">
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <div class="chart-card-title">Weekly Submissions</div>
                            <div class="chart-card-tabs">
                                <button class="chart-tab active" id="analyticsTabFound"
                                    data-metric="found">Found</button>
                                <button class="chart-tab" id="analyticsTabClaimed"
                                    data-metric="claimed">Claimed</button>
                            </div>
                        </div>
                        <canvas id="analyticsLineChart" height="220"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <div class="chart-card-title">Category Distribution</div>
                        </div>
                        <div class="doughnut-wrap">
                            <canvas id="analyticsDoughnut" width="200" height="200"></canvas>
                            <div class="doughnut-center">
                                <div class="doughnut-center-val" id="doughnutTotal">0</div>
                                <div class="doughnut-center-label">Total</div>
                            </div>
                        </div>
                        <div class="doughnut-legend" id="doughnutLegend"></div>
                    </div>
                </div>

                <!-- Charts Row 2: Locations + Heatmap -->
                <div class="analytics-grid">
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <div class="chart-card-title">Top Locations</div>
                            <div class="chart-card-subtitle">Where items are found most</div>
                        </div>
                        <div class="loc-list" id="analyticsLocations"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-card-header">
                            <div class="chart-card-title">Activity Heatmap</div>
                            <div class="chart-card-subtitle">Reports by day and hour</div>
                        </div>
                        <canvas id="analyticsHeatmap" height="180"></canvas>
                        <div class="heatmap-scale">
                            <span>Less</span>
                            <div class="heatmap-blocks">
                                <span style="background:rgba(59,130,246,0.08)"></span>
                                <span style="background:rgba(59,130,246,0.2)"></span>
                                <span style="background:rgba(59,130,246,0.4)"></span>
                                <span style="background:rgba(59,130,246,0.65)"></span>
                                <span style="background:#3b82f6"></span>
                            </div>
                            <span>More</span>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Messages Panel -->
            <div class="admin-panel" id="panel-messages">
                <h1 class="admin-main-title">Messages</h1>
                <p class="admin-main-desc">Send announcements and notifications to students</p>

                <div class="messages-layout">
                    <div class="compose-card">
                        <h3 class="compose-title">Compose Message</h3>
                        <div class="form-group">
                            <label class="form-label">Recipient</label>
                            <select class="form-select" id="msgRecipient">
                                <option value="all">All Students</option>
                                <option value="denmark">Denmark High School</option>
                                <option value="alliance">Alliance Academy</option>
                                <option value="south">South Forsyth</option>
                                <option value="individual">Individual Student</option>
                            </select>
                        </div>
                        <div class="form-group" id="individualEmailGroup" style="display:none">
                            <label class="form-label">Student Email</label>
                            <input type="email" class="form-input" id="msgEmail" placeholder="student@school.edu">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-input" id="msgSubject" placeholder="Enter subject line...">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Message</label>
                            <textarea class="form-textarea" id="msgBody" rows="5"
                                placeholder="Write your message here..."></textarea>
                        </div>
                        <button class="send-btn" onclick="sendMessage()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13" />
                                <polygon points="22 2 15 22 11 13 2 9 22 2" />
                            </svg>
                            Send Message
                        </button>
                    </div>
                    <div class="templates-card">
                        <h3 class="compose-title">Quick Templates</h3>
                        <button class="template-btn" onclick="useTemplate('new_items')">
                            <span class="template-icon"></span>
                            <div>
                                <div class="template-name">New Items Found</div>
                                <div class="template-desc">Notify about newly found items today</div>
                            </div>
                        </button>
                        <button class="template-btn" onclick="useTemplate('claim_reminder')">
                            <span class="template-icon"></span>
                            <div>
                                <div class="template-name">Claim Reminder</div>
                                <div class="template-desc">Remind students to check their claims</div>
                            </div>
                        </button>
                        <button class="template-btn" onclick="useTemplate('office_hours')">
                            <span class="template-icon"></span>
                            <div>
                                <div class="template-name">Office Hours Update</div>
                                <div class="template-desc">Share lost & found office hours</div>
                            </div>
                        </button>
                        <button class="template-btn" onclick="useTemplate('weekly_digest')">
                            <span class="template-icon"></span>
                            <div>
                                <div class="template-name">Weekly Digest</div>
                                <div class="template-desc">Weekly summary of activity</div>
                            </div>
                        </button>
                    </div>
                </div>

                <div class="section-header" style="margin-top:24px">
                    <h2 class="section-title">Sent Messages</h2>
                    <span class="section-count" id="sentMsgCount">0</span>
                </div>
                <div class="cards-list" id="sentMessagesList">
                    <div class="empty-state">No messages sent yet</div>
                </div>
            </div>

            <!-- Users Panel -->
            <div class="admin-panel" id="panel-users">
                <h1 class="admin-main-title">User Management</h1>
                <p class="admin-main-desc">View and manage registered users</p>

                <div class="analytics-stats-row">
                    <div class="analytics-stat-card">
                        <div class="stat-card-icon" style="background:rgba(37,99,235,0.15);color:#60a5fa">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                        </div>
                        <div class="stat-card-label">Total Users</div>
                        <div class="stat-card-value" id="usersTotalStat">0</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="stat-card-icon" style="background:rgba(34,197,94,0.15);color:#4ade80">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M12 6v6l4 2" />
                            </svg>
                        </div>
                        <div class="stat-card-label">Active Today</div>
                        <div class="stat-card-value" id="usersActiveTodayStat">0</div>
                    </div>
                    <div class="analytics-stat-card">
                        <div class="stat-card-icon" style="background:rgba(245,158,11,0.15);color:#fbbf24">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="8.5" cy="7" r="4" />
                                <line x1="20" y1="8" x2="20" y2="14" />
                                <line x1="23" y1="11" x2="17" y2="11" />
                            </svg>
                        </div>
                        <div class="stat-card-label">New This Week</div>
                        <div class="stat-card-value" id="usersNewWeekStat">0</div>
                    </div>
                </div>

                <div class="section-header" style="margin-top:24px">
                    <h2 class="section-title">All Users</h2>
                    <span class="section-count" id="usersCountBadge">0</span>
                </div>
                <div class="users-table-wrap">
                    <table class="users-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>School</th>
                                <th>Items</th>
                                <th>Claims</th>
                                <th>Joined</th>
                                <th>Role</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Activity Log Panel -->
            <div class="admin-panel" id="panel-activity">
                <h1 class="admin-main-title">Activity Log</h1>
                <p class="admin-main-desc">Chronological feed of all admin actions</p>

                <div class="activity-filters">
                    <button class="filter-btn active" onclick="filterActivity('all', this)">All</button>
                    <button class="filter-btn" onclick="filterActivity('approval', this)">Approvals</button>
                    <button class="filter-btn" onclick="filterActivity('claim', this)">Claims</button>
                    <button class="filter-btn" onclick="filterActivity('message', this)">Messages</button>
                    <button class="filter-btn" onclick="filterActivity('system', this)">System</button>
                </div>

                <div class="activity-feed" id="activityFeed"></div>
            </div>

        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
        (function () {
            'use strict';

            const pendingItemsEl = document.getElementById('pendingItems');
            const pendingClaimsEl = document.getElementById('pendingClaims');
            const bountyItemsEl = document.getElementById('bountyItems');
            const adminStatus = document.getElementById('adminStatus');
            const dashStats = document.getElementById('dashStats');
            const usersTableBody = document.getElementById('usersTableBody');
            const mapItemsEl = document.getElementById('mapItems');
            const analyticsRangeEl = document.getElementById('analyticsRange');
            const rewardsCatalogEl = document.getElementById('rewardsCatalog');
            const rewardRedemptionsEl = document.getElementById('rewardRedemptions');
            const rewardFormEl = document.getElementById('rewardForm');
            const rewardNameEl = document.getElementById('rewardName');
            const rewardCategoryEl = document.getElementById('rewardCategory');
            const rewardPointsEl = document.getElementById('rewardPoints');
            const rewardStockEl = document.getElementById('rewardStock');
            const rewardDescriptionEl = document.getElementById('rewardDescription');
            const rewardActiveEl = document.getElementById('rewardActive');
            const rewardFormTitleEl = document.getElementById('rewardFormTitle');
            const rewardSaveBtnEl = document.getElementById('rewardSaveBtn');

            const state = {
                currentMapFilter: 'all',
                currentActivityFilter: 'all',
                analyticsDays: 30,
                analyticsMetric: 'found',
                user: null,
                isAdmin: false,
                pendingItems: [],
                pendingClaims: [],
                bounties: [],
                allItems: [],
                allClaims: [],
                admins: [],
                mapItems: [],
                rewardCatalog: [],
                redemptions: [],
                editingRewardId: null,
                users: [],
                activityData: [],
                sentMessages: []
            };

            // ==========================================
            // PANEL NAVIGATION
            // ==========================================
            function switchPanel(name) {
                document.querySelectorAll('.admin-panel').forEach((panel) => panel.classList.remove('active'));
                const panel = document.getElementById('panel-' + name);
                if (panel) panel.classList.add('active');

                document.querySelectorAll('.sidebar-link').forEach((link) => link.classList.remove('active'));
                const activeLink = document.querySelector(`.sidebar-link[data-panel="${name}"]`);
                if (activeLink) activeLink.classList.add('active');

                document.querySelectorAll('.mobile-tab').forEach((tab) => tab.classList.remove('active'));
                const activeTab = document.querySelector(`.mobile-tab[data-panel="${name}"]`);
                if (activeTab) activeTab.classList.add('active');

                if (name === 'analytics') {
                    setTimeout(renderAnalyticsCharts, 60);
                }
                if (name === 'dashboard') {
                    setTimeout(() => {
                        drawDashTrend();
                        drawDashboardSparklines();
                    }, 60);
                }
            }

            window.switchPanel = switchPanel;

            document.querySelectorAll('.sidebar-link').forEach((link) => {
                link.addEventListener('click', () => switchPanel(link.dataset.panel));
            });
            document.querySelectorAll('.mobile-tab').forEach((tab) => {
                tab.addEventListener('click', () => switchPanel(tab.dataset.panel));
            });

            // ==========================================
            // HELPERS
            // ==========================================
            function showStatus(msg) {
                adminStatus.textContent = msg || '';
                adminStatus.classList.toggle('visible', !!msg);
            }

            function renderEmpty(container, text) {
                if (!container) return;
                container.innerHTML = `<div class="empty-state"><p>${escapeHtml(text)}</p></div>`;
            }

            function escapeHtml(value) {
                return String(value || '')
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }

            function setText(id, value) {
                const el = document.getElementById(id);
                if (el) el.textContent = String(value);
            }

            function normalizeRewardCategory(value) {
                const raw = String(value || 'other').trim().toLowerCase();
                const map = {
                    event: 'events',
                    events: 'events',
                    merch: 'merch',
                    merchandise: 'merch',
                    food: 'food',
                    privilege: 'privilege',
                    privileges: 'privilege',
                    other: 'other'
                };
                return map[raw] || raw || 'other';
            }

            function formatRewardCategory(value) {
                const category = normalizeRewardCategory(value);
                return category.charAt(0).toUpperCase() + category.slice(1);
            }

            function asDate(value) {
                if (!value) return null;
                const d = new Date(value);
                return Number.isNaN(d.getTime()) ? null : d;
            }

            function startOfDay(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                return d;
            }

            function daysAgo(days) {
                const d = startOfDay(new Date());
                d.setDate(d.getDate() - days);
                return d;
            }

            function formatDateShort(value) {
                const d = asDate(value);
                if (!d) return '';
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            }

            function formatDateTime(value) {
                const d = asDate(value);
                if (!d) return '';
                return d.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
            }

            function formatRelative(value) {
                const d = asDate(value);
                if (!d) return 'Unknown';
                const diffMs = Date.now() - d.getTime();
                const minute = 60 * 1000;
                const hour = 60 * minute;
                const day = 24 * hour;
                if (diffMs < minute) return 'Just now';
                if (diffMs < hour) return `${Math.round(diffMs / minute)}m ago`;
                if (diffMs < day) return `${Math.round(diffMs / hour)}h ago`;
                if (diffMs < day * 7) return `${Math.round(diffMs / day)}d ago`;
                return formatDateShort(d);
            }

            function changePct(current, previous) {
                if (!previous) return current ? 100 : 0;
                return ((current - previous) / previous) * 100;
            }

            function withSign(value, digits = 0, suffix = '%') {
                const rounded = Number(value).toFixed(digits);
                const sign = Number(value) > 0 ? '+' : Number(value) < 0 ? '' : '';
                return `${sign}${rounded}${suffix}`;
            }

            function inferSchoolFromEmail(email) {
                const e = String(email || '').toLowerCase();
                if (!e) return 'Unknown';
                if (e.includes('denmark')) return 'Denmark HS';
                if (e.includes('alliance')) return 'Alliance Academy';
                if (e.includes('south')) return 'South Forsyth';
                const domain = e.split('@')[1] || '';
                if (domain.includes('denmark')) return 'Denmark HS';
                if (domain.includes('alliance')) return 'Alliance Academy';
                if (domain.includes('south')) return 'South Forsyth';
                return 'Unknown';
            }

            function inferFloorFromLocation(location) {
                const loc = String(location || '').toLowerCase();
                if (!loc) return 1;
                if (/\b2\d{2}\b/.test(loc) || loc.includes('floor 2') || loc.includes('second floor') || loc.includes('2nd')) return 2;
                if (/\b1\d{2}\b/.test(loc) || loc.includes('floor 1') || loc.includes('first floor') || loc.includes('1st')) return 1;
                if (/(biology|chemistry|physics|media center|library|computer lab|science)/.test(loc)) return 2;
                if (/(main office|cafeteria|commons|gym|auditorium|attendance|clinic|counseling)/.test(loc)) return 1;
                return 1;
            }

            function toMapItems(items) {
                return items
                    .filter((item) => String(item.location || '').trim().length > 0)
                    .map((item) => ({
                        id: item.id,
                        floor: inferFloorFromLocation(item.location),
                        name: item.name || 'Unnamed item',
                        location: item.location || 'Unknown location',
                        description: item.description || '',
                        status: item.status || 'pending',
                        created_at: item.created_at
                    }));
            }

            function buildUsers(items, claims, admins) {
                const adminsByEmail = new Set(
                    (admins || [])
                        .map((row) => String(row.email || '').toLowerCase())
                        .filter(Boolean)
                );
                if (state.user?.email) adminsByEmail.add(String(state.user.email).toLowerCase());

                const map = new Map();

                function ensureUser(key, email, nameSeed) {
                    if (!key) return null;
                    if (!map.has(key)) {
                        const emailValue = String(email || '').trim();
                        const fallbackName = emailValue ? emailValue.split('@')[0] : 'User';
                        map.set(key, {
                            key,
                            name: String(nameSeed || '').trim() || fallbackName,
                            email: emailValue,
                            school: inferSchoolFromEmail(emailValue),
                            items: 0,
                            claims: 0,
                            joinedAt: null,
                            lastActivityAt: null,
                            role: 'user'
                        });
                    }
                    return map.get(key);
                }

                items.forEach((item) => {
                    const email = item.contact_email || '';
                    const key = email ? `email:${email.toLowerCase()}` : (item.submitted_by ? `uid:${item.submitted_by}` : null);
                    const user = ensureUser(key, email, item.finder_name || item.contact_email);
                    if (!user) return;
                    user.items += 1;
                    const createdAt = asDate(item.created_at);
                    if (createdAt) {
                        if (!user.joinedAt || createdAt < user.joinedAt) user.joinedAt = createdAt;
                        if (!user.lastActivityAt || createdAt > user.lastActivityAt) user.lastActivityAt = createdAt;
                    }
                    if (user.email && adminsByEmail.has(user.email.toLowerCase())) user.role = 'admin';
                });

                claims.forEach((claim) => {
                    const email = claim.claimer_email || '';
                    const key = email ? `email:${email.toLowerCase()}` : (claim.claimer_id ? `uid:${claim.claimer_id}` : null);
                    const user = ensureUser(key, email, claim.claimer_name || claim.claimer_email);
                    if (!user) return;
                    user.claims += 1;
                    const createdAt = asDate(claim.created_at);
                    if (createdAt) {
                        if (!user.joinedAt || createdAt < user.joinedAt) user.joinedAt = createdAt;
                        if (!user.lastActivityAt || createdAt > user.lastActivityAt) user.lastActivityAt = createdAt;
                    }
                    if (user.email && adminsByEmail.has(user.email.toLowerCase())) user.role = 'admin';
                });

                return Array.from(map.values()).sort((a, b) => {
                    const aTime = a.lastActivityAt ? a.lastActivityAt.getTime() : 0;
                    const bTime = b.lastActivityAt ? b.lastActivityAt.getTime() : 0;
                    return bTime - aTime;
                });
            }

            function buildActivityData(items, claims, messages) {
                const entries = [];

                items.forEach((item) => {
                    const createdAt = item.created_at || item.updated_at;
                    const itemName = escapeHtml(item.name || 'Item');
                    const location = escapeHtml(item.location || 'Unknown location');
                    const status = String(item.status || '').toLowerCase();

                    if (status === 'pending') {
                        entries.push({
                            type: 'approval',
                            icon: '',
                            desc: `<strong>New submission</strong>: <strong>${itemName}</strong> at ${location}`,
                            created_at: createdAt
                        });
                    } else if (status === 'found') {
                        entries.push({
                            type: 'approval',
                            icon: '',
                            desc: `<strong>Approved item</strong>: <strong>${itemName}</strong>`,
                            created_at: createdAt
                        });
                    } else if (status === 'claimed') {
                        entries.push({
                            type: 'claim',
                            icon: '',
                            desc: `<strong>Item claimed</strong>: <strong>${itemName}</strong>`,
                            created_at: createdAt
                        });
                    } else if (status === 'bounty') {
                        entries.push({
                            type: 'system',
                            icon: '',
                            desc: `<strong>Bounty posted</strong>: <strong>${itemName}</strong>`,
                            created_at: createdAt
                        });
                    }
                });

                claims.forEach((claim) => {
                    const itemName = escapeHtml(claim.items?.name || 'Unknown item');
                    const claimer = escapeHtml(claim.claimer_name || claim.claimer_email || 'Student');
                    const status = String(claim.status || '').toLowerCase();
                    let desc = `<strong>${claimer}</strong> submitted a claim for <strong>${itemName}</strong>`;
                    if (status === 'approved') desc = `<strong>Claim approved</strong> for <strong>${itemName}</strong> (${claimer})`;
                    if (status === 'rejected') desc = `<strong>Claim rejected</strong> for <strong>${itemName}</strong> (${claimer})`;
                    entries.push({
                        type: 'claim',
                        icon: status === 'approved' ? '' : status === 'rejected' ? '' : '',
                        desc,
                        created_at: claim.updated_at || claim.created_at
                    });
                });

                messages.forEach((msg) => {
                    const recipient = escapeHtml(msg.recipient_label || msg.recipient_value || msg.recipient_type || 'Students');
                    const subject = escapeHtml(msg.subject || 'Message');
                    entries.push({
                        type: 'message',
                        icon: '',
                        desc: `Message sent to <strong>${recipient}</strong>: "${subject}"`,
                        created_at: msg.created_at
                    });
                });

                entries.push({
                    type: 'system',
                    icon: '',
                    desc: `System snapshot: <strong>${items.length}</strong> items, <strong>${claims.length}</strong> claims`,
                    created_at: new Date().toISOString()
                });

                entries.sort((a, b) => {
                    const at = asDate(a.created_at)?.getTime() || 0;
                    const bt = asDate(b.created_at)?.getTime() || 0;
                    return bt - at;
                });

                return entries.slice(0, 120);
            }

            function summarize() {
                const allItems = state.allItems;
                const allClaims = state.allClaims;
                const pendingCount = state.pendingItems.length;
                const claimPendingCount = state.pendingClaims.length;
                const bountyCount = state.bounties.length;
                const foundCount = allItems.filter((item) => item.status === 'found').length;
                const claimedCount = allItems.filter((item) => item.status === 'claimed').length;
                const activeCount = foundCount + claimedCount;
                const recoveryRate = activeCount ? (claimedCount / activeCount) * 100 : 0;

                const thisMonthStart = daysAgo(29);
                const prevMonthStart = daysAgo(59);
                const prevMonthEnd = daysAgo(30);

                function countItemsBetween(start, end) {
                    return allItems.filter((item) => {
                        const d = asDate(item.created_at);
                        return d && d >= start && d <= end;
                    }).length;
                }

                const thisPeriodItems = countItemsBetween(thisMonthStart, new Date());
                const prevPeriodItems = countItemsBetween(prevMonthStart, prevMonthEnd);

                const thisWeekStart = daysAgo(6);
                const thisWeekItems = allItems.filter((item) => {
                    const d = asDate(item.created_at);
                    return d && d >= thisWeekStart;
                }).length;
                const prevWeekStart = daysAgo(13);
                const prevWeekEnd = daysAgo(7);
                const prevWeekItems = allItems.filter((item) => {
                    const d = asDate(item.created_at);
                    return d && d >= prevWeekStart && d <= prevWeekEnd;
                }).length;

                let avgResolutionDays = 0;
                let resolvedCount = 0;
                const approvedClaimsByItem = new Map();
                allClaims.forEach((claim) => {
                    if (claim.status !== 'approved' || !claim.item_id) return;
                    const claimDate = asDate(claim.updated_at || claim.created_at);
                    if (!claimDate) return;
                    const key = String(claim.item_id);
                    const existing = approvedClaimsByItem.get(key);
                    if (!existing || claimDate < existing) approvedClaimsByItem.set(key, claimDate);
                });
                allItems.forEach((item) => {
                    if (item.status !== 'claimed') return;
                    const itemDate = asDate(item.created_at);
                    const claimDate = approvedClaimsByItem.get(String(item.id));
                    if (!itemDate || !claimDate) return;
                    const days = Math.max(0, (claimDate.getTime() - itemDate.getTime()) / (1000 * 60 * 60 * 24));
                    avgResolutionDays += days;
                    resolvedCount += 1;
                });
                avgResolutionDays = resolvedCount ? avgResolutionDays / resolvedCount : 0;

                const activeUsers = state.users.filter((u) => {
                    const d = u.lastActivityAt;
                    return d && d >= thisMonthStart;
                }).length;
                const prevActiveUsers = state.users.filter((u) => {
                    const d = u.lastActivityAt;
                    return d && d >= prevMonthStart && d <= prevMonthEnd;
                }).length;

                return {
                    pendingCount,
                    claimPendingCount,
                    bountyCount,
                    activeCount,
                    foundCount,
                    claimedCount,
                    recoveryRate,
                    thisPeriodItems,
                    prevPeriodItems,
                    thisWeekItems,
                    prevWeekItems,
                    avgResolutionDays,
                    activeUsers,
                    prevActiveUsers
                };
            }

            function setChangeLabel(id, current, previous, unit, betterDirection = 'up') {
                const el = document.getElementById(id);
                if (!el) return;
                const delta = current - previous;
                let valueText = '';
                if (unit === '%') {
                    valueText = withSign(changePct(current, previous), 0, '%');
                } else if (unit === 'count') {
                    valueText = `${delta > 0 ? '+' : ''}${delta}`;
                } else if (unit === 'days') {
                    valueText = `${delta > 0 ? '+' : ''}${delta.toFixed(1)}d`;
                }
                el.textContent = valueText;
                const good = betterDirection === 'down' ? delta <= 0 : delta >= 0;
                el.classList.toggle('positive', good);
                el.classList.toggle('negative', !good);
            }

            function renderDashboardStats(summary) {
                setText('pendingCount', summary.pendingCount);
                setText('claimsCount', summary.claimPendingCount);
                setText('bountiesCount', summary.bountyCount);
                setText('itemsCountBadge', summary.pendingCount);
                setText('claimsCountBadge', summary.claimPendingCount);
                setText('bountiesCountBadge', summary.bountyCount);
                setText('sidebarItemsBadge', summary.pendingCount);
                setText('sidebarClaimsBadge', summary.claimPendingCount);
                setText('sidebarBountiesBadge', summary.bountyCount);
                setText('sidebarRewardsBadge', state.rewardCatalog.filter((reward) => reward.is_active !== false).length);
                setText('qaSubmissions', summary.pendingCount);
                setText('qaClaims', summary.claimPendingCount);
                setText('qaBounties', summary.bountyCount);
                setText('qaRewards', state.rewardCatalog.filter((reward) => reward.is_active !== false).length);
                setText('qaMap', state.mapItems.length);

                const recoveryRounded = Math.round(summary.recoveryRate);
                setText('recoveryRateKpi', recoveryRounded);
                const recoveryBadge = document.getElementById('recoveryRateBadge');
                if (recoveryBadge) recoveryBadge.textContent = withSign(changePct(summary.claimedCount, summary.foundCount || 0), 0, '%');

                setText('metricTotalItems', state.allItems.length);
                setText('metricThisWeek', summary.thisWeekItems);
                setText('metricRecoveryRate', `${recoveryRounded}%`);
                setText('metricAvgResolution', `${summary.avgResolutionDays.toFixed(1)}d`);
                setText('metricActiveUsers', summary.activeUsers);

                setChangeLabel('metricTotalItemsChange', summary.thisPeriodItems, summary.prevPeriodItems, '%', 'up');
                setChangeLabel('metricThisWeekChange', summary.thisWeekItems, summary.prevWeekItems, 'count', 'up');
                setChangeLabel('metricRecoveryRateChange', summary.claimedCount, summary.foundCount || 0, '%', 'up');
                setChangeLabel('metricAvgResolutionChange', summary.avgResolutionDays, 2.8, 'days', 'down');
                setChangeLabel('metricActiveUsersChange', summary.activeUsers, summary.prevActiveUsers, 'count', 'up');
            }

            function renderPendingItems() {
                if (!state.pendingItems.length) {
                    renderEmpty(pendingItemsEl, 'No pending submissions. All caught up!');
                    return;
                }

                pendingItemsEl.innerHTML = state.pendingItems.map((item) => {
                    const title = escapeHtml(item.name || 'Untitled Item');
                    const category = escapeHtml(item.category || 'Uncategorized');
                    const location = escapeHtml(item.location || 'Unknown location');
                    const dateLost = escapeHtml(item.date_lost || 'No date');
                    const contact = escapeHtml(item.contact_email || 'N/A');
                    const phone = item.contact_phone ? ` &middot; ${escapeHtml(item.contact_phone)}` : '';
                    const description = item.description ? `<div class="card-proof">${escapeHtml(item.description)}</div>` : '';
                    return `
                        <div class="review-card" id="item-card-${item.id}">
                            <div class="card-top">
                                <div class="card-info">
                                    <div class="card-title">${title}</div>
                                    <div class="card-meta">${category} &middot; ${location} &middot; ${dateLost}</div>
                                    <div class="card-meta">Contact: ${contact}${phone}</div>
                                    ${description}
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-approve" onclick="approveItem('${item.id}')">Approve</button>
                                    <button class="btn btn-reject" onclick="rejectItem('${item.id}')">Reject</button>
                                </div>
                            </div>
                            <div class="card-status" id="item-status-${item.id}"></div>
                        </div>
                    `;
                }).join('');
            }

            function renderPendingClaims() {
                if (!state.pendingClaims.length) {
                    renderEmpty(pendingClaimsEl, 'No pending claims to review.');
                    return;
                }

                pendingClaimsEl.innerHTML = state.pendingClaims.map((claim) => {
                    const itemName = escapeHtml(claim.items?.name || 'Unknown Item');
                    const category = escapeHtml(claim.items?.category || 'N/A');
                    const location = escapeHtml(claim.items?.location || 'N/A');
                    const claimer = escapeHtml(claim.claimer_name || 'Unknown');
                    const email = escapeHtml(claim.claimer_email || 'N/A');
                    const proof = claim.proof_description ? `<div class="card-proof"><strong>Proof:</strong> ${escapeHtml(claim.proof_description)}</div>` : '';
                    return `
                        <div class="review-card" id="claim-card-${claim.id}">
                            <div class="card-top">
                                <div class="card-info">
                                    <div class="card-title">${itemName}</div>
                                    <div class="card-meta">${category} &middot; ${location}</div>
                                    <div class="card-meta">Claimed by: <strong style="color:#ccc">${claimer}</strong> (${email})</div>
                                    ${proof}
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-approve" onclick="approveClaim('${claim.id}', '${claim.item_id || ''}')">Approve</button>
                                    <button class="btn btn-reject" onclick="rejectClaim('${claim.id}')">Reject</button>
                                </div>
                            </div>
                            <div class="card-status" id="claim-status-${claim.id}"></div>
                        </div>
                    `;
                }).join('');
            }

            function renderBounties() {
                if (!state.bounties.length) {
                    renderEmpty(bountyItemsEl, 'No active bounties.');
                    return;
                }

                bountyItemsEl.innerHTML = state.bounties.map((item) => {
                    const urgencyRaw = String(item.urgency || '').toLowerCase();
                    const urgency = urgencyRaw ? `<span class="urgency-badge urgency-${escapeHtml(urgencyRaw)}">${escapeHtml(urgencyRaw)}</span>` : '';
                    return `
                        <div class="review-card" id="bounty-card-${item.id}">
                            <div class="card-top">
                                <div class="card-info">
                                    <div class="card-title">${escapeHtml(item.name || 'Untitled')} ${urgency}</div>
                                    <div class="card-meta">${escapeHtml(item.category || 'N/A')} &middot; Last seen: ${escapeHtml(item.location || 'N/A')} &middot; ${escapeHtml(item.date_lost || 'No date')}</div>
                                    <div class="card-meta">Posted by: ${escapeHtml(item.contact_email || 'N/A')}${item.contact_phone ? ` &middot; ${escapeHtml(item.contact_phone)}` : ''}</div>
                                    ${item.description ? `<div class="card-proof">${escapeHtml(item.description)}</div>` : ''}
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-reject" onclick="removeBounty('${item.id}')">Remove</button>
                                </div>
                            </div>
                            <div class="card-status" id="bounty-status-${item.id}"></div>
                        </div>
                    `;
                }).join('');
            }

            function renderMapItems() {
                let items = state.mapItems;
                if (state.currentMapFilter !== 'all') {
                    items = items.filter((item) => item.floor === Number(state.currentMapFilter));
                }

                setText('mapItemsCountBadge', items.length);
                setText('sidebarMapBadge', state.mapItems.length);

                if (!items.length) {
                    renderEmpty(mapItemsEl, 'No map items found.');
                    return;
                }

                mapItemsEl.innerHTML = items.map((item) => `
                    <div class="review-card" id="mapitem-${item.id}">
                        <div class="card-top">
                            <div class="card-info">
                                <div class="card-title">${escapeHtml(item.name)}</div>
                                <div class="card-meta">Floor ${item.floor} &middot; ${escapeHtml(item.location)}</div>
                                ${item.description ? `<div class="card-proof">${escapeHtml(item.description)}</div>` : ''}
                                <div class="card-meta">Status: ${escapeHtml(item.status)} &middot; ${formatDateShort(item.created_at)}</div>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-reject" onclick="removeMapItem('${item.id}')">Remove</button>
                            </div>
                        </div>
                        <div class="card-status" id="mapitem-status-${item.id}"></div>
                    </div>
                `).join('');
            }

            function redemptionStatusClass(value) {
                const status = String(value || '').toLowerCase();
                if (status === 'pending') return 'pending';
                if (status === 'approved' || status === 'delivered') return 'approved';
                if (status === 'rejected' || status === 'canceled' || status === 'cancelled') return 'rejected';
                return 'other';
            }

            function setRewardFormMode(isEdit) {
                if (rewardFormTitleEl) rewardFormTitleEl.textContent = isEdit ? 'Edit Reward' : 'Create Reward';
                if (rewardSaveBtnEl) rewardSaveBtnEl.textContent = isEdit ? 'Update Reward' : 'Save Reward';
                const cancelBtn = document.getElementById('rewardCancelBtn');
                if (cancelBtn) cancelBtn.style.display = isEdit ? 'inline-flex' : 'none';
            }

            function clearRewardForm() {
                state.editingRewardId = null;
                if (rewardFormEl) rewardFormEl.reset();
                if (rewardCategoryEl) rewardCategoryEl.value = 'food';
                if (rewardActiveEl) rewardActiveEl.checked = true;
                setRewardFormMode(false);
            }

            function renderRewardsPanel() {
                if (!rewardsCatalogEl || !rewardRedemptionsEl) return;

                const rewards = [...state.rewardCatalog].sort((a, b) => {
                    const costDelta = Number(a.points_cost || 0) - Number(b.points_cost || 0);
                    if (costDelta !== 0) return costDelta;
                    return String(a.name || '').localeCompare(String(b.name || ''));
                });

                const activeRewards = rewards.filter((reward) => reward.is_active !== false).length;
                const archivedRewards = Math.max(0, rewards.length - activeRewards);
                const redemptionCount = state.redemptions.length;
                const pendingRedemptions = state.redemptions.filter((row) => String(row.status || '').toLowerCase() === 'pending').length;

                setText('rewardsActiveCount', activeRewards);
                setText('rewardsArchivedCount', archivedRewards);
                setText('rewardsRedeemedCount', redemptionCount);
                setText('rewardsPendingCount', pendingRedemptions);
                setText('rewardsCatalogCountBadge', rewards.length);
                setText('rewardsRedemptionCountBadge', redemptionCount);

                if (!rewards.length) {
                    renderEmpty(rewardsCatalogEl, 'No rewards in the catalog yet.');
                } else {
                    rewardsCatalogEl.innerHTML = rewards.map((reward) => {
                        const statusClass = reward.is_active === false ? 'inactive' : 'active';
                        const statusLabel = reward.is_active === false ? 'Inactive' : 'Active';
                        const stock = reward.stock === null || reward.stock === undefined || reward.stock === ''
                            ? 'Unlimited'
                            : String(Number(reward.stock));
                        const category = formatRewardCategory(reward.category);

                        return `
                            <div class="reward-item-card" id="reward-card-${reward.id}">
                                <div class="reward-item-top">
                                    <div>
                                        <div class="reward-item-title">
                                            ${escapeHtml(reward.name || 'Untitled Reward')}
                                            <span class="reward-chip">${escapeHtml(category)}</span>
                                        </div>
                                        <div class="reward-item-meta">${Number(reward.points_cost || 0)} points &middot; Stock: ${escapeHtml(stock)}</div>
                                    </div>
                                    <span class="reward-pill ${statusClass}">${statusLabel}</span>
                                </div>
                                ${reward.description ? `<div class="reward-item-desc">${escapeHtml(reward.description)}</div>` : ''}
                                <div class="reward-item-actions" style="margin-top:12px">
                                    <button class="btn btn-neutral" onclick="editReward('${reward.id}')">Edit</button>
                                    <button class="btn ${reward.is_active === false ? 'btn-approve' : 'btn-neutral'}" onclick="toggleRewardActive('${reward.id}')">${reward.is_active === false ? 'Activate' : 'Hide'}</button>
                                    <button class="btn btn-reject" onclick="deleteReward('${reward.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                const recent = [...state.redemptions].slice(0, 40);
                if (!recent.length) {
                    renderEmpty(rewardRedemptionsEl, 'No redemptions yet.');
                    return;
                }

                rewardRedemptionsEl.innerHTML = recent.map((row) => {
                    const status = String(row.status || 'approved').toLowerCase();
                    const badgeClass = redemptionStatusClass(status);
                    const user = escapeHtml(row.user_id ? `User ${String(row.user_id).slice(0, 8)}` : 'Unknown user');
                    const createdAt = formatDateTime(row.created_at);
                    const actions = status === 'pending'
                        ? `
                            <button class="btn btn-approve" onclick="setRedemptionStatus('${row.id}', 'approved')">Approve</button>
                            <button class="btn btn-reject" onclick="setRedemptionStatus('${row.id}', 'rejected')">Reject</button>
                        `
                        : '';

                    return `
                        <div class="redemption-row" id="redemption-${row.id}">
                            <div>
                                <div class="redemption-title">${escapeHtml(row.reward_name || 'Reward')}</div>
                                <div class="redemption-meta">${user} &middot; ${Number(row.points_cost || 0)} pts &middot; ${createdAt}</div>
                            </div>
                            <div class="card-actions">
                                <span class="status-pill ${badgeClass}">${escapeHtml(status)}</span>
                                ${actions}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            window.clearRewardForm = clearRewardForm;

            function renderUsersTable() {
                if (!usersTableBody) return;
                if (!state.users.length) {
                    usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#666;padding:20px">No users found yet.</td></tr>';
                    setText('usersTotalStat', 0);
                    setText('usersActiveTodayStat', 0);
                    setText('usersNewWeekStat', 0);
                    setText('usersCountBadge', 0);
                    return;
                }

                const todayStart = startOfDay(new Date());
                const weekStart = daysAgo(6);
                const activeToday = state.users.filter((u) => u.lastActivityAt && u.lastActivityAt >= todayStart).length;
                const newThisWeek = state.users.filter((u) => u.joinedAt && u.joinedAt >= weekStart).length;

                setText('usersTotalStat', state.users.length);
                setText('usersActiveTodayStat', activeToday);
                setText('usersNewWeekStat', newThisWeek);
                setText('usersCountBadge', state.users.length);

                usersTableBody.innerHTML = state.users.map((u) => `
                    <tr>
                        <td data-label="Name"><strong>${escapeHtml(u.name || 'User')}</strong></td>
                        <td data-label="Email" style="color:#888">${escapeHtml(u.email || '')}</td>
                        <td data-label="School">${escapeHtml(u.school || 'Unknown')}</td>
                        <td data-label="Items">${u.items}</td>
                        <td data-label="Claims">${u.claims}</td>
                        <td data-label="Joined" style="color:#888">${u.joinedAt ? formatDateShort(u.joinedAt) : ''}</td>
                        <td data-label="Role"><span class="role-badge ${u.role}">${escapeHtml(u.role)}</span></td>
                    </tr>
                `).join('');
            }

            function renderActivity() {
                const feed = document.getElementById('activityFeed');
                if (!feed) return;

                const filtered = state.currentActivityFilter === 'all'
                    ? state.activityData
                    : state.activityData.filter((entry) => entry.type === state.currentActivityFilter);

                if (!filtered.length) {
                    feed.innerHTML = '<div class="empty-state">No activity matching this filter</div>';
                    return;
                }

                feed.innerHTML = filtered.map((entry) => `
                    <div class="activity-item" data-type="${escapeHtml(entry.type)}">
                        <div class="activity-icon ${escapeHtml(entry.type)}">${entry.icon}</div>
                        <div class="activity-content">
                            <div class="activity-desc">${entry.desc}</div>
                            <div class="activity-meta">${formatRelative(entry.created_at)}</div>
                        </div>
                    </div>
                `).join('');
            }

            function renderDashRecent() {
                const recentList = document.getElementById('dashRecentList');
                if (!recentList) return;

                const recent = state.activityData.slice(0, 6);
                if (!recent.length) {
                    recentList.innerHTML = '<div class="empty-state">No recent activity</div>';
                    return;
                }

                const colorForType = {
                    approval: '#f59e0b',
                    claim: '#22c55e',
                    message: '#60a5fa',
                    system: '#a78bfa'
                };

                recentList.innerHTML = recent.map((entry) => `
                    <div class="dash-recent-item">
                        <span class="dash-recent-dot" style="background:${colorForType[entry.type] || '#64748b'}"></span>
                        <span class="dash-recent-text">${entry.desc.replace(/<[^>]+>/g, '')}</span>
                        <span class="dash-recent-time">${formatRelative(entry.created_at)}</span>
                    </div>
                `).join('');
            }

            function renderSentMessages() {
                const list = document.getElementById('sentMessagesList');
                if (!list) return;

                setText('sentMsgCount', state.sentMessages.length);
                if (!state.sentMessages.length) {
                    list.innerHTML = '<div class="empty-state">No messages sent yet</div>';
                    return;
                }

                list.innerHTML = state.sentMessages.map((msg) => {
                    const recipient = escapeHtml(msg.recipient_label || msg.recipient_value || msg.recipient_type || 'Students');
                    const unsynced = msg.localOnly ? '<span style="color:#f59e0b;font-size:11px"> (local draft)</span>' : '';
                    return `
                        <div class="sent-msg-card">
                            <div class="sent-msg-header">
                                <div class="sent-msg-subject">${escapeHtml(msg.subject || 'Message')}${unsynced}</div>
                                <div class="sent-msg-time">${formatDateTime(msg.created_at)}</div>
                            </div>
                            <div class="sent-msg-recipient">To: ${recipient}</div>
                            <div class="sent-msg-body">${escapeHtml(msg.body || '').replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }).join('');
            }

            // ==========================================
            // DATABASE LOADING
            // ==========================================
            async function loadAdminData() {
                if (typeof BackTrackDB === 'undefined') {
                    showStatus('Supabase is not configured.');
                    return false;
                }

                state.user = await BackTrackDB.getCurrentUser();
                state.isAdmin = await BackTrackDB.isAdmin();
                const isOwnerFallback = String(state.user?.email || '').toLowerCase() === 'rushwanthmahendran1@gmail.com';

                if (!state.user || (!state.isAdmin && !isOwnerFallback)) {
                    showStatus('Admin access required. Log in with an admin account.');
                    return false;
                }

                showStatus('');
                if (dashStats) dashStats.style.display = 'grid';

                const allStatuses = ['pending', 'found', 'claimed', 'lost', 'bounty'];
                const [pendingItems, pendingClaims, allItems, allClaims, admins, messages, rewardCatalog, redemptions] = await Promise.all([
                    BackTrackDB.getPendingItems(),
                    BackTrackDB.getPendingClaims(),
                    BackTrackDB.getItems({ status: allStatuses }),
                    typeof BackTrackDB.getClaims === 'function' ? BackTrackDB.getClaims() : BackTrackDB.getPendingClaims(),
                    typeof BackTrackDB.getAdmins === 'function' ? BackTrackDB.getAdmins() : Promise.resolve([]),
                    typeof BackTrackDB.getAdminMessages === 'function' ? BackTrackDB.getAdminMessages(100) : Promise.resolve([]),
                    typeof BackTrackDB.getRewardCatalog === 'function' ? BackTrackDB.getRewardCatalog() : Promise.resolve([]),
                    typeof BackTrackDB.getRedemptions === 'function' ? BackTrackDB.getRedemptions({ limit: 200 }) : Promise.resolve([])
                ]);

                state.pendingItems = Array.isArray(pendingItems) ? pendingItems : [];
                state.pendingClaims = Array.isArray(pendingClaims) ? pendingClaims : [];
                state.allItems = Array.isArray(allItems) ? allItems : [];
                state.allClaims = Array.isArray(allClaims) ? allClaims : [];
                state.admins = Array.isArray(admins) ? admins : [];
                state.sentMessages = Array.isArray(messages) ? messages : [];
                state.rewardCatalog = Array.isArray(rewardCatalog) ? rewardCatalog : [];
                state.redemptions = Array.isArray(redemptions) ? redemptions : [];
                state.bounties = state.allItems.filter((item) => item.status === 'bounty');
                state.mapItems = toMapItems(state.allItems.filter((item) => ['pending', 'found', 'claimed', 'bounty'].includes(String(item.status || ''))));
                state.users = buildUsers(state.allItems, state.allClaims, state.admins);
                state.activityData = buildActivityData(state.allItems, state.allClaims, state.sentMessages);

                return true;
            }

            async function refreshDashboard() {
                const ok = await loadAdminData();
                if (!ok) return;

                const summary = summarize();
                renderDashboardStats(summary);
                renderPendingItems();
                renderPendingClaims();
                renderBounties();
                renderRewardsPanel();
                renderMapItems();
                renderUsersTable();
                renderActivity();
                renderDashRecent();
                renderSentMessages();

                drawDashboardSparklines();
                drawDashTrend();
                renderAnalyticsCharts();
            }

            // ==========================================
            // ACTIONS
            // ==========================================
            async function approveItem(id) {
                const statusEl = document.getElementById(`item-status-${id}`);
                if (statusEl) statusEl.textContent = 'Approving...';
                const updated = await BackTrackDB.setItemStatus(id, 'found');
                if (!updated) {
                    if (statusEl) {
                        statusEl.textContent = 'Failed.';
                        statusEl.className = 'card-status error';
                    }
                    return;
                }
                await refreshDashboard();
            }

            async function rejectItem(id) {
                if (!confirm('Remove this submission?')) return;
                const statusEl = document.getElementById(`item-status-${id}`);
                if (statusEl) statusEl.textContent = 'Removing...';
                const ok = await BackTrackDB.deleteItem(id);
                if (!ok) {
                    if (statusEl) {
                        statusEl.textContent = 'Failed.';
                        statusEl.className = 'card-status error';
                    }
                    return;
                }
                await refreshDashboard();
            }

            async function approveClaim(claimId, itemId) {
                const statusEl = document.getElementById(`claim-status-${claimId}`);
                if (statusEl) statusEl.textContent = 'Approving...';
                const claim = await BackTrackDB.updateClaimStatus(claimId, 'approved');
                if (!claim) {
                    if (statusEl) {
                        statusEl.textContent = 'Failed.';
                        statusEl.className = 'card-status error';
                    }
                    return;
                }
                if (itemId) await BackTrackDB.setItemStatus(itemId, 'claimed');
                await refreshDashboard();
            }

            async function rejectClaim(claimId) {
                if (!confirm('Reject this claim?')) return;
                const statusEl = document.getElementById(`claim-status-${claimId}`);
                if (statusEl) statusEl.textContent = 'Rejecting...';
                const claim = await BackTrackDB.updateClaimStatus(claimId, 'rejected');
                if (!claim) {
                    if (statusEl) {
                        statusEl.textContent = 'Failed.';
                        statusEl.className = 'card-status error';
                    }
                    return;
                }
                await refreshDashboard();
            }

            async function removeBounty(id) {
                if (!confirm('Remove this bounty?')) return;
                const statusEl = document.getElementById(`bounty-status-${id}`);
                if (statusEl) statusEl.textContent = 'Removing...';
                const ok = await BackTrackDB.deleteItem(id);
                if (!ok) {
                    if (statusEl) {
                        statusEl.textContent = 'Failed.';
                        statusEl.className = 'card-status error';
                    }
                    return;
                }
                await refreshDashboard();
            }

            async function removeMapItem(id) {
                if (!confirm('Remove this map item?')) return;
                const statusEl = document.getElementById(`mapitem-status-${id}`);
                if (statusEl) statusEl.textContent = 'Removing...';
                const ok = await BackTrackDB.deleteItem(id);
                if (!ok) {
                    if (statusEl) {
                        statusEl.textContent = 'Failed.';
                        statusEl.className = 'card-status error';
                    }
                    return;
                }
                await refreshDashboard();
            }

            function editReward(id) {
                const reward = state.rewardCatalog.find((row) => String(row.id) === String(id));
                if (!reward) return;

                state.editingRewardId = reward.id;
                if (rewardNameEl) rewardNameEl.value = reward.name || '';
                if (rewardCategoryEl) rewardCategoryEl.value = normalizeRewardCategory(reward.category);
                if (rewardPointsEl) rewardPointsEl.value = Number(reward.points_cost || 0);
                if (rewardStockEl) rewardStockEl.value = reward.stock === null || reward.stock === undefined ? '' : Number(reward.stock);
                if (rewardDescriptionEl) rewardDescriptionEl.value = reward.description || '';
                if (rewardActiveEl) rewardActiveEl.checked = reward.is_active !== false;

                setRewardFormMode(true);
                switchPanel('rewards');
                rewardFormEl?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            async function saveReward(event) {
                event.preventDefault();

                if (typeof BackTrackDB.addRewardCatalogItem !== 'function' || typeof BackTrackDB.updateRewardCatalogItem !== 'function') {
                    showStatus('Reward catalog is not configured in this environment.');
                    return;
                }

                const name = String(rewardNameEl?.value || '').trim();
                const category = normalizeRewardCategory(rewardCategoryEl?.value || 'other');
                const pointsCost = Number(rewardPointsEl?.value || 0);
                const stockRaw = String(rewardStockEl?.value || '').trim();
                const stock = stockRaw === '' ? null : Number(stockRaw);
                const description = String(rewardDescriptionEl?.value || '').trim();
                const isActive = Boolean(rewardActiveEl?.checked);

                if (!name) {
                    showStatus('Reward name is required.');
                    return;
                }
                if (!Number.isFinite(pointsCost) || pointsCost < 1) {
                    showStatus('Points cost must be at least 1.');
                    return;
                }
                if (stock !== null && (!Number.isFinite(stock) || stock < 0)) {
                    showStatus('Stock must be blank or a non-negative number.');
                    return;
                }

                const payload = {
                    name,
                    category,
                    points_cost: Math.round(pointsCost),
                    stock: stock === null ? null : Math.round(stock),
                    description,
                    is_active: isActive
                };

                let saved = null;
                if (state.editingRewardId) {
                    saved = await BackTrackDB.updateRewardCatalogItem(state.editingRewardId, payload);
                } else {
                    saved = await BackTrackDB.addRewardCatalogItem({
                        ...payload,
                        created_by: state.user?.id || null
                    });
                }

                if (!saved) {
                    showStatus('Could not save reward. Run the latest SQL migration for reward_catalog.');
                    return;
                }

                clearRewardForm();
                await refreshDashboard();
                showStatus('Reward saved.');
                setTimeout(() => showStatus(''), 1500);
            }

            async function toggleRewardActive(id) {
                const reward = state.rewardCatalog.find((row) => String(row.id) === String(id));
                if (!reward) return;
                if (typeof BackTrackDB.updateRewardCatalogItem !== 'function') return;

                const updated = await BackTrackDB.updateRewardCatalogItem(id, { is_active: reward.is_active === false });
                if (!updated) {
                    showStatus('Failed to update reward status.');
                    return;
                }

                await refreshDashboard();
            }

            async function deleteReward(id) {
                if (!confirm('Delete this reward from the catalog?')) return;
                if (typeof BackTrackDB.deleteRewardCatalogItem !== 'function') return;

                const ok = await BackTrackDB.deleteRewardCatalogItem(id);
                if (!ok) {
                    showStatus('Failed to delete reward.');
                    return;
                }

                if (state.editingRewardId && String(state.editingRewardId) === String(id)) {
                    clearRewardForm();
                }
                await refreshDashboard();
            }

            async function setRedemptionStatus(id, status) {
                if (typeof BackTrackDB.updateRedemptionStatus !== 'function') {
                    showStatus('Redemption status updates are not configured.');
                    return;
                }

                const updated = await BackTrackDB.updateRedemptionStatus(id, status);
                if (!updated) {
                    showStatus('Failed to update redemption.');
                    return;
                }

                await refreshDashboard();
            }

            window.approveItem = approveItem;
            window.rejectItem = rejectItem;
            window.approveClaim = approveClaim;
            window.rejectClaim = rejectClaim;
            window.removeBounty = removeBounty;
            window.removeMapItem = removeMapItem;
            window.editReward = editReward;
            window.toggleRewardActive = toggleRewardActive;
            window.deleteReward = deleteReward;
            window.setRedemptionStatus = setRedemptionStatus;

            rewardFormEl?.addEventListener('submit', saveReward);
            setRewardFormMode(false);

            // ==========================================
            // MAP + ACTIVITY FILTERS
            // ==========================================
            function filterMapItems(filter, button) {
                state.currentMapFilter = filter === 'all' ? 'all' : Number(filter);
                document.querySelectorAll('#panel-map .filter-btn').forEach((btn) => btn.classList.remove('active'));
                if (button) button.classList.add('active');
                renderMapItems();
            }

            function filterActivity(type, button) {
                state.currentActivityFilter = type;
                document.querySelectorAll('#panel-activity .filter-btn').forEach((btn) => btn.classList.remove('active'));
                if (button) button.classList.add('active');
                renderActivity();
            }

            window.filterMapItems = filterMapItems;
            window.filterActivity = filterActivity;

            // ==========================================
            // MESSAGES
            // ==========================================
            const templates = {
                new_items: {
                    subject: 'New Items Found Today!',
                    body: 'Hello! New lost items have been turned in today. Please check BackTrack for details.'
                },
                claim_reminder: {
                    subject: 'Reminder: Check Your Pending Claims',
                    body: 'This is a reminder to verify your pending claims with the front office.'
                },
                office_hours: {
                    subject: 'Lost & Found Office Hours Update',
                    body: 'Office hours:\n- Monday-Friday: 7:30 AM - 3:30 PM\n- Main Office'
                },
                weekly_digest: {
                    subject: 'Weekly Lost & Found Digest',
                    body: 'Weekly summary:\n- New items\n- Claims approved\n- Recovery rate'
                }
            };

            document.getElementById('msgRecipient')?.addEventListener('change', function () {
                const emailGroup = document.getElementById('individualEmailGroup');
                if (emailGroup) emailGroup.style.display = this.value === 'individual' ? 'block' : 'none';
            });

            function useTemplate(type) {
                const template = templates[type];
                if (!template) return;
                const subjectEl = document.getElementById('msgSubject');
                const bodyEl = document.getElementById('msgBody');
                if (subjectEl) subjectEl.value = template.subject;
                if (bodyEl) bodyEl.value = template.body;
            }

            async function sendMessage() {
                const recipientEl = document.getElementById('msgRecipient');
                const subjectEl = document.getElementById('msgSubject');
                const bodyEl = document.getElementById('msgBody');
                const emailEl = document.getElementById('msgEmail');

                const recipientType = recipientEl ? recipientEl.value : 'all';
                const subject = subjectEl ? subjectEl.value.trim() : '';
                const body = bodyEl ? bodyEl.value.trim() : '';
                const email = emailEl ? emailEl.value.trim() : '';

                if (!subject || !body) {
                    alert('Please fill in subject and message.');
                    return;
                }
                if (recipientType === 'individual' && !email) {
                    alert('Please enter the student email.');
                    return;
                }

                const recipientLabelMap = {
                    all: 'All Students',
                    denmark: 'Denmark High School',
                    alliance: 'Alliance Academy',
                    south: 'South Forsyth',
                    individual: email
                };

                const payload = {
                    sender_id: state.user?.id || null,
                    sender_email: state.user?.email || null,
                    recipient_type: recipientType,
                    recipient_value: recipientType === 'individual' ? email : recipientType,
                    subject,
                    body
                };

                let saved = null;
                if (typeof BackTrackDB.addAdminMessage === 'function') {
                    saved = await BackTrackDB.addAdminMessage(payload);
                }

                if (saved) {
                    await refreshDashboard();
                    showStatus('Message sent.');
                    setTimeout(() => showStatus(''), 1600);
                } else {
                    state.sentMessages.unshift({
                        ...payload,
                        recipient_label: recipientLabelMap[recipientType] || recipientType,
                        created_at: new Date().toISOString(),
                        localOnly: true
                    });
                    renderSentMessages();
                    showStatus('Message saved locally only. Run SQL migration for admin_messages table.');
                }

                if (subjectEl) subjectEl.value = '';
                if (bodyEl) bodyEl.value = '';
                if (emailEl) emailEl.value = '';
            }

            window.useTemplate = useTemplate;
            window.sendMessage = sendMessage;

            // ==========================================
            // CHART DATA HELPERS
            // ==========================================
            function buildDailySeries(records, days, predicate, dateField = 'created_at') {
                const result = new Array(days).fill(0);
                const start = daysAgo(days - 1);
                const startTime = start.getTime();
                const dayMs = 24 * 60 * 60 * 1000;

                records.forEach((record) => {
                    if (predicate && !predicate(record)) return;
                    const d = asDate(record[dateField]);
                    if (!d) return;
                    const dayTime = startOfDay(d).getTime();
                    const index = Math.floor((dayTime - startTime) / dayMs);
                    if (index >= 0 && index < days) result[index] += 1;
                });

                return result;
            }

            function buildBinnedSeries(records, days, bins, predicate, dateField = 'created_at') {
                const safeBins = Math.max(1, bins);
                const values = new Array(safeBins).fill(0);
                const labels = new Array(safeBins).fill('');
                const start = daysAgo(days - 1);
                const end = new Date();
                const totalMs = end.getTime() - start.getTime();
                const binMs = totalMs / safeBins;

                records.forEach((record) => {
                    if (predicate && !predicate(record)) return;
                    const d = asDate(record[dateField]);
                    if (!d || d < start || d > end) return;
                    const idx = Math.min(safeBins - 1, Math.floor((d.getTime() - start.getTime()) / Math.max(binMs, 1)));
                    values[idx] += 1;
                });

                for (let i = 0; i < safeBins; i += 1) {
                    const labelDate = new Date(start.getTime() + ((i + 1) * binMs));
                    labels[i] = `${labelDate.getMonth() + 1}/${labelDate.getDate()}`;
                }

                return { labels, values };
            }

            function setupCanvas(id, fallbackHeight) {
                const canvas = document.getElementById(id);
                if (!canvas) return null;
                const rect = canvas.getBoundingClientRect();
                const width = Math.max(280, rect.width || canvas.width || 280);
                const height = fallbackHeight || rect.height || canvas.height || 180;
                const dpr = window.devicePixelRatio || 1;

                canvas.width = Math.round(width * dpr);
                canvas.height = Math.round(height * dpr);

                const ctx = canvas.getContext('2d');
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                ctx.clearRect(0, 0, width, height);

                return { canvas, ctx, width, height };
            }

            function drawSparkline(canvasId, data, color) {
                const setup = setupCanvas(canvasId, 28);
                if (!setup) return;
                const { ctx, width, height } = setup;

                if (!data.length) return;
                const max = Math.max(...data);
                const min = Math.min(...data);
                const range = max - min || 1;
                const step = width / Math.max(1, data.length - 1);

                ctx.beginPath();
                data.forEach((value, index) => {
                    const x = index * step;
                    const y = height - ((value - min) / range) * (height - 4) - 2;
                    if (index === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.strokeStyle = color;
                ctx.lineWidth = 1.6;
                ctx.lineJoin = 'round';
                ctx.stroke();
            }

            function drawDashboardSparklines() {
                const pendingSeries = buildDailySeries(state.allItems, 10, (item) => item.status === 'pending');
                const claimsSeries = buildDailySeries(state.allClaims, 10, (claim) => claim.status === 'pending');
                const bountySeries = buildDailySeries(state.allItems, 10, (item) => item.status === 'bounty');
                drawSparkline('sparkPending', pendingSeries, '#f59e0b');
                drawSparkline('sparkClaims', claimsSeries, '#818cf8');
                drawSparkline('sparkBounties', bountySeries, '#ec4899');
            }

            function drawLineChart(canvasId, labels, data, options = {}) {
                const setup = setupCanvas(canvasId, options.height || 220);
                if (!setup) return;

                const { ctx, width, height } = setup;
                const pad = { t: 12, r: 12, b: 26, l: 34 };
                const cw = width - pad.l - pad.r;
                const ch = height - pad.t - pad.b;
                const max = Math.max(1, ...data);

                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i += 1) {
                    const y = pad.t + (ch / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(pad.l, y);
                    ctx.lineTo(width - pad.r, y);
                    ctx.stroke();

                    ctx.fillStyle = '#4b5563';
                    ctx.font = '10px Inter';
                    ctx.textAlign = 'right';
                    ctx.fillText(String(Math.round(max - (max / 4) * i)), pad.l - 6, y + 3);
                }

                const step = cw / Math.max(1, data.length - 1);
                ctx.fillStyle = '#4b5563';
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';
                labels.forEach((label, index) => {
                    if (index % Math.ceil(labels.length / 6) !== 0 && index !== labels.length - 1) return;
                    ctx.fillText(label, pad.l + index * step, height - 6);
                });

                ctx.beginPath();
                data.forEach((value, index) => {
                    const x = pad.l + index * step;
                    const y = pad.t + ch - (value / max) * ch;
                    if (index === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });

                const fill = ctx.createLinearGradient(0, pad.t, 0, pad.t + ch);
                fill.addColorStop(0, options.fillTop || 'rgba(59,130,246,0.18)');
                fill.addColorStop(1, 'rgba(0,0,0,0)');

                ctx.lineTo(pad.l + (data.length - 1) * step, pad.t + ch);
                ctx.lineTo(pad.l, pad.t + ch);
                ctx.closePath();
                ctx.fillStyle = fill;
                ctx.fill();

                ctx.beginPath();
                data.forEach((value, index) => {
                    const x = pad.l + index * step;
                    const y = pad.t + ch - (value / max) * ch;
                    if (index === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.strokeStyle = options.stroke || '#3b82f6';
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.stroke();
            }

            function drawDashTrend() {
                const days = 30;
                const found = buildDailySeries(state.allItems, days, (item) => item.status === 'found');
                const claimed = buildDailySeries(state.allItems, days, (item) => item.status === 'claimed');
                const labels = new Array(days).fill('').map((_, idx) => {
                    const d = daysAgo(days - idx - 1);
                    return `${d.getMonth() + 1}/${d.getDate()}`;
                });

                const setup = setupCanvas('dashTrendChart', 200);
                if (!setup) return;
                const { ctx, width, height } = setup;
                const pad = { t: 10, r: 12, b: 24, l: 32 };
                const cw = width - pad.l - pad.r;
                const ch = height - pad.t - pad.b;
                const max = Math.max(1, ...found, ...claimed);
                const step = cw / Math.max(1, days - 1);

                ctx.strokeStyle = 'rgba(255,255,255,0.04)';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i += 1) {
                    const y = pad.t + (ch / 4) * i;
                    ctx.beginPath();
                    ctx.moveTo(pad.l, y);
                    ctx.lineTo(width - pad.r, y);
                    ctx.stroke();
                    ctx.fillStyle = '#444';
                    ctx.font = '10px Inter';
                    ctx.textAlign = 'right';
                    ctx.fillText(String(Math.round(max - (max / 4) * i)), pad.l - 6, y + 3);
                }

                function drawSeries(data, stroke, fillTop) {
                    ctx.beginPath();
                    data.forEach((value, index) => {
                        const x = pad.l + index * step;
                        const y = pad.t + ch - (value / max) * ch;
                        if (index === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                    });
                    ctx.strokeStyle = stroke;
                    ctx.lineWidth = 2;
                    ctx.lineJoin = 'round';
                    ctx.stroke();

                    ctx.lineTo(pad.l + (days - 1) * step, pad.t + ch);
                    ctx.lineTo(pad.l, pad.t + ch);
                    ctx.closePath();
                    const grad = ctx.createLinearGradient(0, pad.t, 0, pad.t + ch);
                    grad.addColorStop(0, fillTop);
                    grad.addColorStop(1, 'rgba(0,0,0,0)');
                    ctx.fillStyle = grad;
                    ctx.fill();
                }

                drawSeries(found, '#3b82f6', 'rgba(59,130,246,0.12)');
                drawSeries(claimed, '#22c55e', 'rgba(34,197,94,0.08)');

                ctx.fillStyle = '#444';
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';
                [0, 7, 14, 21, 29].forEach((idx) => {
                    const x = pad.l + idx * step;
                    ctx.fillText(labels[idx], x, height - 4);
                });
            }

            function drawAnalyticsLine() {
                const days = state.analyticsDays;
                const metric = state.analyticsMetric;
                const series = buildBinnedSeries(
                    state.allItems,
                    days,
                    12,
                    (item) => item.status === metric
                );
                drawLineChart('analyticsLineChart', series.labels, series.values, {
                    height: 220,
                    stroke: metric === 'claimed' ? '#22c55e' : '#3b82f6',
                    fillTop: metric === 'claimed' ? 'rgba(34,197,94,0.15)' : 'rgba(59,130,246,0.18)'
                });
            }

            function drawDoughnut() {
                const setup = setupCanvas('analyticsDoughnut', 200);
                if (!setup) return;
                const { ctx, width, height } = setup;
                const cx = width / 2;
                const cy = height / 2;
                const radius = Math.min(width, height) * 0.38;
                const thickness = 24;

                const rangeStart = daysAgo(state.analyticsDays - 1);
                const categoriesMap = new Map();
                state.allItems.forEach((item) => {
                    const d = asDate(item.created_at);
                    if (!d || d < rangeStart) return;
                    const key = String(item.category || 'Other');
                    categoriesMap.set(key, (categoriesMap.get(key) || 0) + 1);
                });

                let categories = Array.from(categoriesMap.entries()).map(([name, value]) => ({ name, value }));
                categories.sort((a, b) => b.value - a.value);
                categories = categories.slice(0, 7);

                if (!categories.length) {
                    categories = [{ name: 'No Data', value: 1 }];
                }

                const palette = ['#3b82f6', '#8b5cf6', '#f59e0b', '#22c55e', '#ef4444', '#06b6d4', '#64748b'];
                const total = categories.reduce((sum, c) => sum + c.value, 0);

                let angle = -Math.PI / 2;
                categories.forEach((cat, idx) => {
                    const sweep = (cat.value / total) * Math.PI * 2;
                    const color = palette[idx % palette.length];
                    ctx.beginPath();
                    ctx.arc(cx, cy, radius, angle, angle + sweep);
                    ctx.arc(cx, cy, radius - thickness, angle + sweep, angle, true);
                    ctx.closePath();
                    ctx.fillStyle = color;
                    ctx.fill();
                    angle += sweep + 0.03;
                    cat.color = color;
                });

                setText('doughnutTotal', total);
                const legend = document.getElementById('doughnutLegend');
                if (legend) {
                    legend.innerHTML = categories.map((cat) =>
                        `<span class="legend-item"><span class="legend-swatch" style="background:${cat.color}"></span>${escapeHtml(cat.name)} (${cat.value})</span>`
                    ).join('');
                }
            }

            function renderLocations() {
                const el = document.getElementById('analyticsLocations');
                if (!el) return;

                const rangeStart = daysAgo(state.analyticsDays - 1);
                const locMap = new Map();
                state.allItems.forEach((item) => {
                    const d = asDate(item.created_at);
                    if (!d || d < rangeStart) return;
                    const key = String(item.location || 'Unknown');
                    locMap.set(key, (locMap.get(key) || 0) + 1);
                });

                const rows = Array.from(locMap.entries())
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 7);

                if (!rows.length) {
                    el.innerHTML = '<div class="empty-state">No location data available.</div>';
                    return;
                }

                const max = rows[0].count || 1;
                el.innerHTML = rows.map((row, index) => `
                    <div class="loc-row">
                        <span class="loc-row-rank">${index + 1}</span>
                        <span class="loc-row-name">${escapeHtml(row.name)}</span>
                        <div class="loc-row-bar-bg"><div class="loc-row-bar" style="width:${((row.count / max) * 100).toFixed(0)}%"></div></div>
                        <span class="loc-row-val">${row.count}</span>
                    </div>
                `).join('');
            }

            function drawHeatmap() {
                const setup = setupCanvas('analyticsHeatmap', 180);
                if (!setup) return;

                const { ctx, width, height } = setup;
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
                const hours = ['7a', '8a', '9a', '10a', '11a', '12p', '1p', '2p', '3p'];
                const matrix = Array.from({ length: days.length }, () => new Array(hours.length).fill(0));

                const rangeStart = daysAgo(state.analyticsDays - 1);
                state.allItems.forEach((item) => {
                    const d = asDate(item.created_at);
                    if (!d || d < rangeStart) return;
                    const day = d.getDay();
                    const hour = d.getHours();
                    if (day < 1 || day > 5) return;
                    if (hour < 7 || hour > 15) return;
                    matrix[day - 1][hour - 7] += 1;
                });

                const max = Math.max(1, ...matrix.flat());
                const padL = 32;
                const padT = 16;
                const cellW = (width - padL - 8) / hours.length;
                const cellH = (height - padT - 8) / days.length;

                ctx.fillStyle = '#4b5563';
                ctx.font = '9px Inter';
                ctx.textAlign = 'center';
                hours.forEach((hr, j) => {
                    ctx.fillText(hr, padL + j * cellW + cellW / 2, 10);
                });

                days.forEach((dayLabel, i) => {
                    ctx.fillStyle = '#4b5563';
                    ctx.textAlign = 'right';
                    ctx.fillText(dayLabel, padL - 4, padT + i * cellH + cellH / 2 + 3);

                    hours.forEach((_, j) => {
                        const v = matrix[i][j];
                        const alpha = (v / max) * 0.85 + 0.06;
                        ctx.fillStyle = `rgba(59,130,246,${alpha.toFixed(3)})`;
                        const x = padL + j * cellW + 1;
                        const y = padT + i * cellH + 1;
                        const w = cellW - 2;
                        const h = cellH - 2;
                        if (ctx.roundRect) {
                            ctx.beginPath();
                            ctx.roundRect(x, y, w, h, 3);
                            ctx.fill();
                        } else {
                            ctx.fillRect(x, y, w, h);
                        }
                    });
                });
            }

            function renderAnalyticsCharts() {
                drawAnalyticsLine();
                drawDoughnut();
                renderLocations();
                drawHeatmap();
            }

            // ==========================================
            // RANGE/TABS
            // ==========================================
            analyticsRangeEl?.addEventListener('change', () => {
                state.analyticsDays = Number(analyticsRangeEl.value) || 30;
                const summary = summarize();
                renderDashboardStats(summary);
                renderAnalyticsCharts();
            });

            document.querySelectorAll('.chart-tab[data-metric]').forEach((tab) => {
                tab.addEventListener('click', () => {
                    state.analyticsMetric = tab.dataset.metric || 'found';
                    document.querySelectorAll('.chart-tab[data-metric]').forEach((btn) => btn.classList.remove('active'));
                    tab.classList.add('active');
                    drawAnalyticsLine();
                });
            });

            // ==========================================
            // INIT
            // ==========================================
            async function init() {
                const dateEl = document.getElementById('dashDate');
                if (dateEl) {
                    const now = new Date();
                    dateEl.textContent = now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        month: 'long',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }

                await refreshDashboard();
            }

            window.addEventListener('resize', () => {
                const active = document.querySelector('.admin-panel.active')?.id || '';
                if (active === 'panel-analytics') {
                    renderAnalyticsCharts();
                }
                if (active === 'panel-dashboard') {
                    drawDashTrend();
                    drawDashboardSparklines();
                }
            });

            init();
        })();
    </script>
    <script src="js/nav-auth.js"></script>
    <script src="js/accessibility.js"></script>
</body>

</html>
