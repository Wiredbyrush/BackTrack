<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <title>Admin Panel - BackTrack</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/design-system.css">
    <link rel="stylesheet" href="css/nav-auth.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            min-height: 100vh;
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            height: 70px;
            position: fixed;
            top: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            z-index: 100;
        }
        .nav-spacer { height: 70px; }
        .nav-left { display: flex; align-items: center; text-decoration: none; }
        .nav-left img { height: 60px; width: auto; }
        .nav-center { display: flex; gap: 40px; }
        .nav-link {
            color: rgba(255, 255, 255, 0.45);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
        }
        .nav-link:hover { color: rgba(255, 255, 255, 0.8); }
        .nav-link.active { color: #fff; }
        .nav-right { display: flex; align-items: center; }
        .sign-in-btn {
            background: linear-gradient(180deg, #2e2e2e 0%, #1a1a1a 100%);
            color: #f3f4f6;
            border: 1px solid #3f3f3f;
            padding: 8px 18px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 24px 80px;
        }
        .page-header { margin-bottom: 40px; }
        .page-header h1 {
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 8px;
        }
        .page-header p { color: #777; font-size: 15px; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 48px;
        }
        .stat-card {
            background: #0a0a0a;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 24px;
            text-align: center;
        }
        .stat-number {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 4px;
            letter-spacing: -1px;
        }
        .stat-number.pending { color: #f59e0b; }
        .stat-number.claims { color: #6366f1; }
        .stat-number.total { color: #22c55e; }
        .stat-label { color: #666; font-size: 13px; font-weight: 500; }

        .admin-status {
            padding: 14px 18px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            color: #fca5a5;
            font-size: 14px;
            margin-bottom: 24px;
            display: none;
        }
        .admin-status.visible { display: block; }

        .section { margin-bottom: 48px; }
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .section-title { font-size: 20px; font-weight: 700; }
        .section-count {
            background: rgba(255, 255, 255, 0.06);
            padding: 3px 10px;
            border-radius: 99px;
            font-size: 12px;
            color: #999;
            font-weight: 600;
        }

        .cards-list { display: flex; flex-direction: column; gap: 12px; }
        .review-card {
            background: #0a0a0a;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 20px 24px;
            transition: border-color 0.2s;
        }
        .review-card:hover { border-color: rgba(255, 255, 255, 0.12); }
        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }
        .card-info { flex: 1; min-width: 0; }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
        .card-meta { color: #777; font-size: 13px; line-height: 1.6; }
        .card-proof {
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            color: #aaa;
            font-size: 13px;
            line-height: 1.5;
        }
        .card-proof strong { color: #ccc; font-weight: 600; }
        .card-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
        }
        .btn:hover { opacity: 0.85; }
        .btn:active { transform: scale(0.97); }
        .btn-approve { background: #22c55e; color: #052e16; }
        .btn-reject {
            background: rgba(239, 68, 68, 0.12);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        .card-status { margin-top: 10px; font-size: 13px; color: #22c55e; }
        .card-status.error { color: #fca5a5; }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: #555;
            font-size: 14px;
        }
        .loading { text-align: center; padding: 60px; color: #555; font-size: 14px; }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .card-top { flex-direction: column; }
            .card-actions { width: 100%; }
            .btn { flex: 1; text-align: center; }
            nav { padding: 0 20px; }
            .nav-center { gap: 24px; }
        }
    </style>
    <link rel="stylesheet" href="css/theme.css">
</head>
<body>
    <nav>
        <a class="nav-left" href="index.html"><span class="brand-logo">
                <img class="logo-dark" src="logo.png" alt="BackTrack">
                <img class="logo-light" src="logo-white.png" alt="" aria-hidden="true">
            </span></a>
        <div class="nav-center">
            <a class="nav-link" href="browse.html">Browse</a>
            <a class="nav-link" href="map.html">Map</a>
            <a class="nav-link" href="submit.html">Submit</a>
            <a class="nav-link" href="features.html">Features</a>
            <a class="nav-link" href="sources.html">Sources</a>
        </div>
        <div class="nav-right">
            <a class="sign-in-btn" href="login.html">Sign In</a>
        </div>
    </nav>
    <div class="nav-spacer"></div>

    <div class="container">
        <div class="page-header">
            <h1>Admin Panel</h1>
            <p>Review submissions, manage claims, and keep the platform clean.</p>
        </div>

        <div class="admin-status" id="adminStatus"></div>

        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card">
                <div class="stat-number pending" id="pendingCount">0</div>
                <div class="stat-label">Pending Items</div>
            </div>
            <div class="stat-card">
                <div class="stat-number claims" id="claimsCount">0</div>
                <div class="stat-label">Pending Claims</div>
            </div>
            <div class="stat-card">
                <div class="stat-number total" id="totalCount">0</div>
                <div class="stat-label">Total Active</div>
            </div>
        </div>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Pending Submissions</h2>
                <span class="section-count" id="itemsCountBadge">0</span>
            </div>
            <div class="cards-list" id="pendingItems"><div class="loading">Loading...</div></div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Pending Claims</h2>
                <span class="section-count" id="claimsCountBadge">0</span>
            </div>
            <div class="cards-list" id="pendingClaims"><div class="loading">Loading...</div></div>
        </section>

        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Map Items</h2>
                <span class="section-count" id="mapItemsCountBadge">0</span>
            </div>
            <div style="margin-bottom: 16px;">
                <button class="btn" style="background: rgba(255,255,255,0.06); color: #aaa; margin-right: 8px;" onclick="filterMapItems('all')">All Floors</button>
                <button class="btn" style="background: rgba(255,255,255,0.06); color: #aaa; margin-right: 8px;" onclick="filterMapItems(1)">Floor 1</button>
                <button class="btn" style="background: rgba(255,255,255,0.06); color: #aaa;" onclick="filterMapItems(2)">Floor 2</button>
            </div>
            <div class="cards-list" id="mapItems"></div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script>
        const pendingItemsEl = document.getElementById('pendingItems');
        const pendingClaimsEl = document.getElementById('pendingClaims');
        const adminStatus = document.getElementById('adminStatus');
        const statsGrid = document.getElementById('statsGrid');

        function showStatus(msg) {
            adminStatus.textContent = msg;
            adminStatus.classList.toggle('visible', !!msg);
        }

        function renderEmpty(container, text) {
            container.innerHTML = `<div class="empty-state"><p>${text}</p></div>`;
        }

        async function loadAdminData() {
            if (typeof BackTrackDB === 'undefined') {
                showStatus('Supabase is not configured.');
                return;
            }

            const user = await BackTrackDB.getCurrentUser();
            const isAdmin = await BackTrackDB.isAdmin();
            const isSuperAdmin = user?.email === 'rushwanthmahendran1@gmail.com';

            if (!isAdmin && !isSuperAdmin) {
                showStatus('Admin access required. Sign in with an admin account.');
                return;
            }

            showStatus('');
            statsGrid.style.display = 'grid';

            const [items, claims] = await Promise.all([
                BackTrackDB.getPendingItems(),
                BackTrackDB.getPendingClaims()
            ]);

            let totalActive = 0;
            try {
                const all = await BackTrackDB.getItems({ status: ['found', 'claimed'] });
                totalActive = all.length;
            } catch(e) {}

            document.getElementById('pendingCount').textContent = items.length;
            document.getElementById('claimsCount').textContent = claims.length;
            document.getElementById('totalCount').textContent = totalActive;
            document.getElementById('itemsCountBadge').textContent = items.length;
            document.getElementById('claimsCountBadge').textContent = claims.length;

            if (!items.length) {
                renderEmpty(pendingItemsEl, 'No pending submissions. All caught up!');
            } else {
                pendingItemsEl.innerHTML = items.map(item => `
                    <div class="review-card" id="item-card-${item.id}">
                        <div class="card-top">
                            <div class="card-info">
                                <div class="card-title">${item.name}</div>
                                <div class="card-meta">
                                    ${item.category} &middot; ${item.location} &middot; ${item.date_lost || 'No date'}
                                </div>
                                <div class="card-meta">Contact: ${item.contact_email || 'N/A'}${item.contact_phone ? ' &middot; ' + item.contact_phone : ''}</div>
                                ${item.description ? `<div class="card-proof">${item.description}</div>` : ''}
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-approve" onclick="approveItem('${item.id}')">Approve</button>
                                <button class="btn btn-reject" onclick="rejectItem('${item.id}')">Reject</button>
                            </div>
                        </div>
                        <div class="card-status" id="item-status-${item.id}"></div>
                    </div>
                `).join('');
            }

            if (!claims.length) {
                renderEmpty(pendingClaimsEl, 'No pending claims to review.');
            } else {
                pendingClaimsEl.innerHTML = claims.map(claim => `
                    <div class="review-card" id="claim-card-${claim.id}">
                        <div class="card-top">
                            <div class="card-info">
                                <div class="card-title">${claim.items?.name || 'Unknown Item'}</div>
                                <div class="card-meta">
                                    ${claim.items?.category || 'N/A'} &middot; ${claim.items?.location || 'N/A'}
                                </div>
                                <div class="card-meta">Claimed by: <strong style="color:#ccc">${claim.claimer_name || 'Unknown'}</strong> (${claim.claimer_email})</div>
                                ${claim.proof_description ? `<div class="card-proof"><strong>Proof:</strong> ${claim.proof_description}</div>` : ''}
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-approve" onclick="approveClaim('${claim.id}', '${claim.item_id}')">Approve</button>
                                <button class="btn btn-reject" onclick="rejectClaim('${claim.id}')">Reject</button>
                            </div>
                        </div>
                        <div class="card-status" id="claim-status-${claim.id}"></div>
                    </div>
                `).join('');
            }
        }

        async function approveItem(id) {
            const s = document.getElementById(`item-status-${id}`);
            s.textContent = 'Approving...'; s.className = 'card-status';
            const ok = await BackTrackDB.setItemStatus(id, 'found');
            if (ok) { s.textContent = 'Approved.'; setTimeout(loadAdminData, 800); }
            else { s.textContent = 'Failed.'; s.className = 'card-status error'; }
        }

        async function rejectItem(id) {
            if (!confirm('Remove this submission?')) return;
            const s = document.getElementById(`item-status-${id}`);
            s.textContent = 'Removing...';
            const ok = await BackTrackDB.deleteItem(id);
            if (ok) { s.textContent = 'Removed.'; setTimeout(loadAdminData, 800); }
            else { s.textContent = 'Failed.'; s.className = 'card-status error'; }
        }

        async function approveClaim(claimId, itemId) {
            const s = document.getElementById(`claim-status-${claimId}`);
            s.textContent = 'Approving...'; s.className = 'card-status';
            const claim = await BackTrackDB.updateClaimStatus(claimId, 'approved');
            if (claim && itemId) {
                await BackTrackDB.setItemStatus(itemId, 'claimed');
                s.textContent = 'Approved. Item marked claimed.';
                setTimeout(loadAdminData, 800);
            } else { s.textContent = 'Failed.'; s.className = 'card-status error'; }
        }

        async function rejectClaim(claimId) {
            if (!confirm('Reject this claim?')) return;
            const s = document.getElementById(`claim-status-${claimId}`);
            s.textContent = 'Rejecting...';
            const ok = await BackTrackDB.updateClaimStatus(claimId, 'rejected');
            if (ok) { s.textContent = 'Rejected.'; setTimeout(loadAdminData, 800); }
            else { s.textContent = 'Failed.'; s.className = 'card-status error'; }
        }

        loadAdminData();
        loadMapItems();

        // Map Items Management - matches map.html
        const mapData = {
            1: {
                rooms: [
                    { id: "F1-101", name: "Main Office", items: [{ name: "Black Wallet", desc: "Found near reception desk" }] },
                    { id: "F1-102", name: "Cafeteria", items: [{ name: "Lunch Box", desc: "Red with superhero stickers" }] },
                    { id: "F1-103", name: "Gymnasium", items: [{ name: "Water Bottle", desc: "Blue Hydro Flask" }, { name: "AirPods", desc: "White case" }] },
                    { id: "F1-104", name: "Hallway", items: [{ name: "Textbook", desc: "AP Chemistry" }] },
                    { id: "F1-105", name: "Health Clinic", items: [{ name: "Jacket", desc: "Nike gray hoodie size M" }] },
                    { id: "F1-106", name: "Auditorium", items: [] },
                    { id: "F1-107", name: "Library Entrance", items: [] },
                ],
            },
            2: {
                rooms: [
                    { id: "F2-201", name: "Biology Lab", items: [{ name: "Lab Goggles", desc: "Clear safety goggles" }] },
                    { id: "F2-202", name: "Library", items: [{ name: "Calculator", desc: "TI-84 Plus" }, { name: "Earbuds", desc: "Samsung Galaxy Buds" }] },
                    { id: "F2-203", name: "Computer Lab", items: [{ name: "USB Drive", desc: "32GB SanDisk" }] },
                    { id: "F2-204", name: "Classroom A", items: [] },
                    { id: "F2-205", name: "Hallway", items: [] },
                    { id: "F2-206", name: "Chemistry Lab", items: [] },
                    { id: "F2-207", name: "Classroom B", items: [{ name: "Backpack", desc: "Black Jansport" }] },
                    { id: "F2-208", name: "Classroom C", items: [] },
                    { id: "F2-209", name: "Teacher Lounge", items: [] },
                ],
            },
        };

        let currentFilter = 'all';

        function getAllMapItems() {
            const items = [];
            Object.entries(mapData).forEach(([floor, data]) => {
                data.rooms.forEach(room => {
                    room.items.forEach((item, idx) => {
                        items.push({
                            id: `${room.id}-${idx}`,
                            floor: parseInt(floor),
                            room: room.name,
                            roomId: room.id,
                            itemIndex: idx,
                            ...item
                        });
                    });
                });
            });
            return items;
        }

        function filterMapItems(filter) {
            currentFilter = filter;
            loadMapItems();
        }

        function loadMapItems() {
            const mapItemsEl = document.getElementById('mapItems');
            let items = getAllMapItems();

            if (currentFilter !== 'all') {
                items = items.filter(item => item.floor === currentFilter);
            }

            document.getElementById('mapItemsCountBadge').textContent = items.length;

            if (items.length === 0) {
                mapItemsEl.innerHTML = '<div class="empty-state"><p>No map items found.</p></div>';
                return;
            }

            mapItemsEl.innerHTML = items.map(item => `
                <div class="review-card" id="mapitem-${item.id}">
                    <div class="card-top">
                        <div class="card-info">
                            <div class="card-title">${item.name}</div>
                            <div class="card-meta">
                                Floor ${item.floor} &middot; ${item.room}
                            </div>
                            ${item.desc ? `<div class="card-proof">${item.desc}</div>` : ''}
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-reject" onclick="removeMapItem('${item.id}', ${item.floor}, '${item.roomId}', ${item.itemIndex})">Remove</button>
                        </div>
                    </div>
                    <div class="card-status" id="mapitem-status-${item.id}"></div>
                </div>
            `).join('');
        }

        function removeMapItem(id, floor, roomId, itemIndex) {
            if (!confirm('Remove this item from the map?')) return;

            const statusEl = document.getElementById(`mapitem-status-${id}`);
            statusEl.textContent = 'Removing...';
            statusEl.className = 'card-status';

            // Remove from data structure
            const room = mapData[floor].rooms.find(r => r.id === roomId);
            if (room && room.items[itemIndex]) {
                room.items.splice(itemIndex, 1);
                statusEl.textContent = 'Removed successfully.';
                setTimeout(() => {
                    loadMapItems();
                }, 800);
            } else {
                statusEl.textContent = 'Error removing item.';
                statusEl.className = 'card-status error';
            }
        }
    </script>
    <script src="js/nav-auth.js"></script>
    <script src="js/accessibility.js"></script>
</body>
</html>
